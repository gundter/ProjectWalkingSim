---
phase: 07-save-system
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - Source/ProjectWalkingSim/Public/Interaction/TapeRecorderActor.h
  - Source/ProjectWalkingSim/Private/Interaction/TapeRecorderActor.cpp
  - Source/ProjectWalkingSim/Public/Player/HUD/PauseMenuWidget.h
  - Source/ProjectWalkingSim/Private/Player/HUD/PauseMenuWidget.cpp
  - Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
  - Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
  - Source/ProjectWalkingSim/Public/Save/SaveSubsystem.h
  - Source/ProjectWalkingSim/Private/Save/SaveSubsystem.cpp
  - Source/ProjectWalkingSim/Public/Core/SereneGameMode.h
  - Source/ProjectWalkingSim/Private/Core/SereneGameMode.cpp
autonomous: true

must_haves:
  truths:
    - "Player can interact with a tape recorder in the world to open save slot picker"
    - "Saving at tape recorder captures screenshot and writes game state to selected slot"
    - "Esc opens pause menu with Continue, Load Game, Resume, and Quit options"
    - "Continue in pause menu loads the most recent save"
    - "Load Game in pause menu opens the 3-slot picker in load mode"
    - "Player position is stored as the tape recorder location on save"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Interaction/TapeRecorderActor.h"
      provides: "Save point actor implementing IInteractable"
      contains: "class ATapeRecorderActor"
    - path: "Source/ProjectWalkingSim/Public/Player/HUD/PauseMenuWidget.h"
      provides: "Pause menu with Continue, Load Game, Resume, Quit"
      contains: "class UPauseMenuWidget"
  key_links:
    - from: "TapeRecorderActor.cpp"
      to: "SaveLoadMenuWidget"
      via: "Opens save slot menu in Save mode"
      pattern: "ESaveLoadMode::Save"
    - from: "PauseMenuWidget.cpp"
      to: "SaveSubsystem::LoadLatestSave"
      via: "Continue button"
      pattern: "LoadLatestSave"
    - from: "PauseMenuWidget.cpp"
      to: "SaveLoadMenuWidget"
      via: "Load Game opens slot picker in Load mode"
      pattern: "ESaveLoadMode::Load"
    - from: "SerenePlayerController.cpp"
      to: "PauseMenuWidget"
      via: "Esc key toggles pause menu"
      pattern: "PauseMenu|TogglePauseMenu"
    - from: "TapeRecorderActor.cpp"
      to: "SaveSubsystem"
      via: "Overrides player save location to tape recorder position"
      pattern: "GetActorLocation"
---

<objective>
Create the TapeRecorderActor (world save point), PauseMenuWidget (Esc menu), and wire everything into the player controller and HUD. This is the final integration plan that makes the save system player-facing.

Purpose: After this plan, the save system is fully functional: players save at tape recorders, die and see Game Over, pause to load saves, and resume play from saved state.

Output: TapeRecorderActor, PauseMenuWidget, Esc input binding, full HUD integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-save-system/07-CONTEXT.md
@.planning/phases/07-save-system/07-RESEARCH.md
@.planning/phases/07-save-system/07-01-SUMMARY.md
@.planning/phases/07-save-system/07-02-SUMMARY.md
@.planning/phases/07-save-system/07-03-SUMMARY.md

Key files from prior plans:
@Source/ProjectWalkingSim/Public/Save/SaveSubsystem.h (from 07-01)
@Source/ProjectWalkingSim/Public/Player/HUD/SaveLoadMenuWidget.h (from 07-03)
@Source/ProjectWalkingSim/Public/Player/HUD/GameOverWidget.h (from 07-03)

Key files to modify:
@Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
@Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
@Source/ProjectWalkingSim/Public/Core/SereneGameMode.h
@Source/ProjectWalkingSim/Private/Core/SereneGameMode.cpp
@Source/ProjectWalkingSim/Public/Interaction/InteractableBase.h (pattern reference)

Existing patterns:
@Source/ProjectWalkingSim/Public/Interaction/DoorActor.h (IInteractable pattern)
@Source/ProjectWalkingSim/Public/Hiding/HidingComponent.h (state checking)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TapeRecorderActor -- save point interactable + SaveSubsystem pending location API</name>
  <files>
    Source/ProjectWalkingSim/Public/Interaction/TapeRecorderActor.h
    Source/ProjectWalkingSim/Private/Interaction/TapeRecorderActor.cpp
    Source/ProjectWalkingSim/Public/Save/SaveSubsystem.h
    Source/ProjectWalkingSim/Private/Save/SaveSubsystem.cpp
  </files>
  <action>
**SaveSubsystem.h** -- Add pending save location API (3 new methods + 3 private members):
- `void SetPendingSaveLocation(const FVector& Location, const FRotator& Rotation)` -- Stores location/rotation and sets bHasPendingSaveLocation = true.
- `void ClearPendingSaveLocation()` -- Resets bHasPendingSaveLocation to false.
- Private members: `FVector PendingSaveLocation`, `FRotator PendingSaveRotation`, `bool bHasPendingSaveLocation = false`.
- In SaveToSlot: when writing PlayerLocation/PlayerRotation, use PendingSaveLocation/PendingSaveRotation if bHasPendingSaveLocation is true, otherwise use the player pawn's current location/rotation.

**SaveSubsystem.cpp** -- Implement the two new methods (trivial setters). Modify SaveToSlot to check bHasPendingSaveLocation.

**TapeRecorderActor.h** -- ATapeRecorderActor : public AInteractableBase

Inherits from AInteractableBase (same base as DoorActor, PickupActor). This is the world-placed tape recorder that serves as a save point. Interacting opens the save slot picker.

Properties:
- `UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Save") TObjectPtr<USoundBase> SaveSound` -- Sound played when save starts (tape rolling). Assigned in Blueprint.
- `UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Save") float SaveAnimDuration = 1.5f` -- Duration of save feedback before the slot picker opens. Can be 0 to skip.
- `UPROPERTY(EditDefaultsOnly, Category = "Save") TSubclassOf<USaveLoadMenuWidget> SaveMenuWidgetClass` -- Blueprint subclass of SaveLoadMenuWidget. Assigned in BP subclass.

Override IInteractable methods:
- `CanInteract_Implementation(AActor* Interactor)`: Return true only if: (1) bCanBeInteracted is true, (2) player is not hiding (check HidingComponent->GetHidingState() == EHidingState::Free), (3) no save menu is already open. Get HidingComponent from the player character.
- `GetInteractionText_Implementation()`: Return FText "Record" (the detective is recording case notes on the tape recorder).
- `OnInteract_Implementation(AActor* Interactor)`:
  1. Play SaveSound at actor location (UGameplayStatics::PlaySoundAtLocation).
  2. Tell SaveSubsystem to use tape recorder position: `SaveSubsystem->SetPendingSaveLocation(GetActorLocation(), GetActorRotation())`.
  3. Create the SaveLoadMenuWidget from SaveMenuWidgetClass, add to viewport.
  4. Call widget->OpenMenu(ESaveLoadMode::Save).
  5. Set player input mode to Game+UI (FInputModeGameAndUI) so the player can click slots.
  6. Show mouse cursor.
  7. Bind widget->OnMenuClosed to HandleSaveMenuClosed.

Private:
- `UPROPERTY() TObjectPtr<USaveLoadMenuWidget> SaveMenuInstance` -- Live widget instance.
- `void HandleSaveMenuClosed()` -- Hide cursor, restore input mode to Game Only, remove widget from viewport, clear SaveMenuInstance. Call SaveSubsystem->ClearPendingSaveLocation().

**TapeRecorderActor.cpp** -- Full implementation.

Constructor: Set InteractionText to NSLOCTEXT("Interaction", "TapeRecorder", "Record").
  </action>
  <verify>Project compiles. TapeRecorderActor inherits AInteractableBase and opens SaveLoadMenuWidget in Save mode. SaveSubsystem has SetPendingSaveLocation/ClearPendingSaveLocation. TapeRecorderActor sets pending location in OnInteract and clears it in HandleSaveMenuClosed.</verify>
  <done>TapeRecorderActor opens save slot picker on interaction. Player location saved as tape recorder position. Save sound plays. Menu closes cleanly with input mode restored.</done>
</task>

<task type="auto">
  <name>Task 2: PauseMenuWidget + Esc binding + IsGameOver guard</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/HUD/PauseMenuWidget.h
    Source/ProjectWalkingSim/Private/Player/HUD/PauseMenuWidget.cpp
    Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
    Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
    Source/ProjectWalkingSim/Public/Core/SereneGameMode.h
    Source/ProjectWalkingSim/Private/Core/SereneGameMode.cpp
  </files>
  <action>
**PauseMenuWidget.h** -- UPauseMenuWidget : public UUserWidget

Pause menu opened by Esc. Contains: Continue (load latest), Load Game (open slot picker), Resume (close menu), Quit (exit game).

BindWidget members:
- `TObjectPtr<UTextBlock> PauseTitle` -- "PAUSED".
- `TObjectPtr<UButton> ContinueButton` -- Loads latest save.
- `TObjectPtr<UButton> LoadGameButton` -- Opens SaveLoadMenuWidget in Load mode.
- `TObjectPtr<UButton> ResumeButton` -- Closes pause menu, resumes game.
- `TObjectPtr<UButton> QuitButton` -- Exits to desktop.

Properties:
- `UPROPERTY(EditDefaultsOnly, Category = "Pause") TSubclassOf<USaveLoadMenuWidget> LoadMenuWidgetClass` -- Blueprint class for the load menu.

Override NativeConstruct:
- Bind all four buttons to their handlers.
- Check SaveSubsystem->HasAnySave(). If false, disable ContinueButton and LoadGameButton (SetIsEnabled(false)).

Delegate:
- `FOnMenuClosed OnPauseMenuClosed` -- Broadcast when Resume is clicked.

Private:
- `UPROPERTY() TObjectPtr<USaveLoadMenuWidget> LoadMenuInstance`
- `HandleContinueClicked()`: Call SaveSubsystem->LoadLatestSave().
- `HandleLoadGameClicked()`: Create LoadMenuWidgetClass instance, add to viewport, call OpenMenu(ESaveLoadMode::Load). Hide the pause menu (SetVisibility Collapsed). Bind LoadMenuInstance->OnMenuClosed to HandleLoadMenuClosed.
- `HandleResumeClicked()`: Broadcast OnPauseMenuClosed.
- `HandleQuitClicked()`: UKismetSystemLibrary::QuitGame.
- `HandleLoadMenuClosed()`: Show pause menu again (SetVisibility Visible). Remove load menu from viewport.

**PauseMenuWidget.cpp** -- Full implementation.

**SerenePlayerController.h** -- Add:
- `UPROPERTY(EditDefaultsOnly, Category = "Input") TObjectPtr<UInputAction> PauseAction` -- Esc key input action.
- `UPROPERTY(EditDefaultsOnly, Category = "UI") TSubclassOf<UPauseMenuWidget> PauseMenuWidgetClass` -- Blueprint pause menu class.
- Private: `UPROPERTY() TObjectPtr<UPauseMenuWidget> PauseMenuInstance`
- Private: `bool bIsPaused = false`
- Private: `void HandlePause(const FInputActionValue& Value)` -- Toggles pause menu.
- Private: `void HandlePauseMenuClosed()` -- Hides pause, restores input.
- Public: `void TogglePauseMenu()` -- Can be called externally if needed.

**SerenePlayerController.cpp** -- Implement:
- In `SetupInputComponent`: Bind PauseAction (Started trigger) to HandlePause.
- `HandlePause`: If bIsInventoryOpen, call CloseInventory() instead. Otherwise call TogglePauseMenu().
- `TogglePauseMenu()`:
  - If bIsPaused: close pause menu. Set bIsPaused = false. Remove widget or set Collapsed. Restore input mode to Game Only. Hide cursor. Call UGameplayStatics::SetGamePaused(GetWorld(), false).
  - If !bIsPaused: guard against opening if inventory is open, player is hiding, or Game Over is showing. For Game Over check: cast GetWorld()->GetAuthGameMode() to ASereneGameMode and call IsGameOver(). If any guard fails, return early. Otherwise: set bIsPaused = true, create widget if needed, add to viewport, show cursor, set input mode to Game+UI, call UGameplayStatics::SetGamePaused(GetWorld(), true), bind OnPauseMenuClosed.
- `HandlePauseMenuClosed()`: Same as closing in TogglePauseMenu (unpause, hide cursor, restore input).

**SereneGameMode.h** -- Add one inline method (Plan 02 creates GameOverWidgetInstance, this plan adds the query):
```cpp
/** Returns true if Game Over screen is currently displayed. */
UFUNCTION(BlueprintCallable, Category = "Game")
bool IsGameOver() const { return GameOverWidgetInstance != nullptr; }
```

**SereneGameMode.cpp** -- No additional implementation needed (IsGameOver is inline in the header).

NOTE: The pause menu is a standalone viewport widget managed by PlayerController, not a child of SereneHUD. This is intentional -- the controller owns input mode and pause state. SereneHUD/SereneHUDWidget are NOT modified by this plan.
  </action>
  <verify>Project compiles. SerenePlayerController has PauseAction binding and TogglePauseMenu method. PauseMenuWidget has Continue/LoadGame/Resume/Quit buttons. Esc key opens pause menu. Esc while inventory open closes inventory instead. SereneGameMode has IsGameOver().</verify>
  <done>PauseMenuWidget provides full pause menu with Continue, Load Game, Resume, Quit. Esc key toggles pause. Pause prevented during inventory, hiding, or Game Over. Load Game opens SaveLoadMenuWidget in Load mode. IsGameOver() available for state queries.</done>
</task>

</tasks>

<verification>
1. Project compiles without errors
2. TapeRecorderActor inherits AInteractableBase and shows "Record" interaction text
3. Interacting with tape recorder opens SaveLoadMenuWidget in Save mode
4. Player save location is set to tape recorder position (not player position)
5. Esc opens pause menu with 4 working buttons
6. Continue loads most recent save (or disabled if no saves)
7. Load Game opens 3-slot picker in Load mode
8. Resume unpauses and restores input
9. Quit exits game
10. Esc closes inventory if inventory is open
11. Pause is blocked during Game Over state
12. SereneGameMode::IsGameOver() returns correct state
</verification>

<success_criteria>
- Full save flow: interact with tape recorder -> select slot -> game saves (screenshot + state) -> menu closes
- Full load flow via pause: Esc -> Load Game -> select occupied slot -> level reloads with saved state
- Full load flow via continue: Esc -> Continue -> level reloads with latest save
- Death flow: Wendigo grabs -> Game Over screen -> Load Last Save -> level reloads with saved state
- Death with no saves: Game Over -> Restart -> fresh level start
- All UI interactions are clean (cursor, input mode, widget lifecycle)
</success_criteria>

<output>
After completion, create `.planning/phases/07-save-system/07-04-SUMMARY.md`
</output>
