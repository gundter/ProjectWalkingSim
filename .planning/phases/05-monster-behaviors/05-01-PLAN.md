---
phase: 05-monster-behaviors
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Source/ProjectWalkingSim/Public/AI/MonsterAITypes.h
  - Source/ProjectWalkingSim/Private/AI/MonsterAITypes.cpp
  - Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
  - Source/ProjectWalkingSim/Private/AI/WendigoCharacter.cpp
  - Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h
  - Source/ProjectWalkingSim/Private/AI/SuspicionComponent.cpp
  - Source/ProjectWalkingSim/Public/Tags/SereneTags.h
  - Source/ProjectWalkingSim/Private/Tags/SereneTags.cpp
autonomous: true

must_haves:
  truths:
    - "EWendigoBehaviorState enum exists with Patrol, Investigating, Chasing, Searching, GrabAttack values"
    - "EStimulusType enum exists with None, Sound, Sight values"
    - "WendigoCharacter stores LastKnownPlayerLocation, WitnessedHidingSpot, and BehaviorState"
    - "SuspicionComponent tracks and exposes LastStimulusType"
    - "AIConstants includes chase, search, and investigate-sight speed values"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/AI/MonsterAITypes.h"
      provides: "EWendigoBehaviorState, EStimulusType, FOnBehaviorStateChanged, new AIConstants speeds"
      contains: "EWendigoBehaviorState"
    - path: "Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h"
      provides: "Chase/search persistent state on character"
      contains: "LastKnownPlayerLocation"
    - path: "Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h"
      provides: "LastStimulusType getter and tracking"
      contains: "EStimulusType"
    - path: "Source/ProjectWalkingSim/Public/Tags/SereneTags.h"
      provides: "AI behavior and spawn gameplay tags"
      contains: "TAG_AI_Behavior_Chasing"
  key_links:
    - from: "SuspicionComponent"
      to: "EStimulusType"
      via: "ProcessSightStimulus and ProcessHearingStimulus set LastStimulusType"
      pattern: "LastStimulusType = EStimulusType"
    - from: "WendigoCharacter"
      to: "FOnBehaviorStateChanged"
      via: "SetBehaviorState broadcasts delegate"
      pattern: "OnBehaviorStateChanged.Broadcast"
---

<objective>
Extend the AI foundation types, WendigoCharacter, and SuspicionComponent with all Phase 5 data structures.

Purpose: All subsequent Phase 5 plans (chase, search, grab, spawn, investigation enhancement) depend on these new enums, constants, properties, and tags. This plan establishes the data layer without adding any behavior logic.

Output: Extended MonsterAITypes.h (new enums, delegate, speed constants), extended WendigoCharacter (chase/search persistent state, behavior state), extended SuspicionComponent (stimulus type tracking), new gameplay tags for behavior states.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-monster-behaviors/05-RESEARCH.md

@Source/ProjectWalkingSim/Public/AI/MonsterAITypes.h
@Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
@Source/ProjectWalkingSim/Private/AI/WendigoCharacter.cpp
@Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h
@Source/ProjectWalkingSim/Private/AI/SuspicionComponent.cpp
@Source/ProjectWalkingSim/Public/Tags/SereneTags.h
@Source/ProjectWalkingSim/Private/Tags/SereneTags.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend MonsterAITypes, SereneTags, and WendigoCharacter</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/MonsterAITypes.h
    Source/ProjectWalkingSim/Private/AI/MonsterAITypes.cpp
    Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
    Source/ProjectWalkingSim/Private/AI/WendigoCharacter.cpp
    Source/ProjectWalkingSim/Public/Tags/SereneTags.h
    Source/ProjectWalkingSim/Private/Tags/SereneTags.cpp
  </files>
  <action>
    **MonsterAITypes.h** -- add AFTER the existing EAlertLevel and FOnAlertLevelChanged:

    1. `EWendigoBehaviorState` enum (BlueprintType): Patrol, Investigating, Chasing, Searching, GrabAttack. This is more granular than EAlertLevel -- it tracks what the Wendigo is *doing*, not just its alert state.
    2. `FOnBehaviorStateChanged` dynamic multicast delegate with one param (EWendigoBehaviorState NewState).
    3. `EStimulusType` enum (BlueprintType): None, Sound, Sight. Used by investigation to differentiate reactions.
    4. New AIConstants values (add to existing namespace):
       - `WendigoChaseSpeed = 575.0f` (~15% faster than player sprint 500)
       - `WendigoSearchSpeed = 180.0f` (between patrol 150 and investigate 200)
       - `WendigoInvestigateSightSpeed = 250.0f` (faster investigation for visual stimulus)
       - `LOSLostTimeout = 3.0f` (seconds before chase transitions to search)
       - `GrabRange = 150.0f` (distance for grab attack, ~1.5m)
       - `SearchRadius = 600.0f` (radius for random search points around last-known)
       - `SearchDuration = 18.0f` (total search duration before returning to patrol)
       - `NumSearchPoints = 3` (as int32, random navmesh points during search)

    **WendigoCharacter.h** -- add to the public section:

    1. Forward declare `class AHidingSpotActor;` at top.
    2. `UPROPERTY(BlueprintReadOnly, Category = "AI|Chase") FVector LastKnownPlayerLocation = FVector::ZeroVector;`
    3. `UPROPERTY(BlueprintReadOnly, Category = "AI|Chase") bool bHasLastKnownPlayerLocation = false;`
    4. `UPROPERTY(BlueprintReadOnly, Category = "AI|Chase") TWeakObjectPtr<AActor> WitnessedHidingSpot;` (use AActor not AHidingSpotActor to avoid circular header dependency; cast at use-site)
    5. `UPROPERTY(BlueprintReadOnly, Category = "AI|Behavior") EWendigoBehaviorState BehaviorState = EWendigoBehaviorState::Patrol;`
    6. `UPROPERTY(BlueprintAssignable, Category = "AI|Behavior") FOnBehaviorStateChanged OnBehaviorStateChanged;`
    7. Add setter: `void SetBehaviorState(EWendigoBehaviorState NewState);` -- broadcasts delegate only if state actually changed.
    8. Add setters: `void SetLastKnownPlayerLocation(const FVector& Location);` and `void ClearLastKnownPlayerLocation();` and `void SetWitnessedHidingSpot(AActor* Spot);` and `void ClearWitnessedHidingSpot();`
    9. Add `#include "AI/MonsterAITypes.h"` to the header (needed for EWendigoBehaviorState and FOnBehaviorStateChanged).

    **WendigoCharacter.cpp** -- implement the new methods:
    - `SetBehaviorState`: check if NewState != BehaviorState, update, broadcast OnBehaviorStateChanged. Log via LogSerene.
    - `SetLastKnownPlayerLocation`: set vector + set bHasLastKnownPlayerLocation = true.
    - `ClearLastKnownPlayerLocation`: zero vector + set flag false.
    - `SetWitnessedHidingSpot` / `ClearWitnessedHidingSpot`: set/clear the weak pointer.

    **SereneTags.h** -- add to the SereneTags namespace:
    - `TAG_AI_Behavior_Patrol`, `TAG_AI_Behavior_Investigating`, `TAG_AI_Behavior_Chasing`, `TAG_AI_Behavior_Searching`, `TAG_AI_Behavior_GrabAttack`
    - `TAG_AI_Spawn_Zone`

    **SereneTags.cpp** -- define the new tags:
    - `UE_DEFINE_GAMEPLAY_TAG(SereneTags::TAG_AI_Behavior_Patrol, "AI.Behavior.Patrol");`
    - And similarly for Investigating, Chasing, Searching, GrabAttack
    - `UE_DEFINE_GAMEPLAY_TAG(SereneTags::TAG_AI_Spawn_Zone, "AI.Spawn.Zone");`

    IMPORTANT: Do NOT add `#include "Hiding/HidingSpotActor.h"` to WendigoCharacter.h -- use AActor* with forward declaration to avoid circular dependencies between AI and Hiding modules. The cast to AHidingSpotActor happens at the call site in the AI controller.
  </action>
  <verify>
    Compile: `UnrealBuildTool ProjectWalkingSim Development Win64` or build from IDE. Zero errors, zero warnings (treat warnings as errors is enabled via C4458 etc.).
  </verify>
  <done>
    - MonsterAITypes.h has EWendigoBehaviorState (5 values), EStimulusType (3 values), FOnBehaviorStateChanged, 8 new AIConstants values
    - WendigoCharacter.h has LastKnownPlayerLocation, bHasLastKnownPlayerLocation, WitnessedHidingSpot, BehaviorState, OnBehaviorStateChanged, and setter/clearer methods
    - SereneTags has 6 new gameplay tags
    - Project compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend SuspicionComponent with stimulus type tracking</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h
    Source/ProjectWalkingSim/Private/AI/SuspicionComponent.cpp
  </files>
  <action>
    **SuspicionComponent.h**:
    1. Add `#include "AI/MonsterAITypes.h"` if not already included (it is -- for EAlertLevel -- but verify EStimulusType is accessible after Task 1 changes).
    2. Add private member: `EStimulusType LastStimulusType = EStimulusType::None;`
    3. Add public getter: `UFUNCTION(BlueprintCallable, Category = "AI|Suspicion") EStimulusType GetLastStimulusType() const { return LastStimulusType; }`
    4. Add public setter: `void SetLastStimulusType(EStimulusType Type) { LastStimulusType = Type; }`

    **SuspicionComponent.cpp**:
    1. In `ProcessSightStimulus`: after the visibility check passes and suspicion is being accumulated, set `LastStimulusType = EStimulusType::Sight;`
    2. In `ProcessHearingStimulus`: after recording the stimulus location, set `LastStimulusType = EStimulusType::Sound;`
    3. In `ResetSuspicion`: also reset `LastStimulusType = EStimulusType::None;`
    4. In `ClearStimulusLocation`: do NOT clear LastStimulusType -- it should persist so investigation can read it even after the location is cleared. It only resets on full suspicion reset.

    This is a small change but it is the critical link that enables differentiated investigation behavior. Sight-triggered investigation moves faster (250 cm/s) and sound-triggered investigation moves slower (200 cm/s).
  </action>
  <verify>
    Compile cleanly. Grep SuspicionComponent.cpp for `LastStimulusType = EStimulusType::Sight` and `LastStimulusType = EStimulusType::Sound` to confirm both paths set it.
  </verify>
  <done>
    - SuspicionComponent stores and exposes LastStimulusType
    - ProcessSightStimulus sets it to Sight, ProcessHearingStimulus sets it to Sound
    - ResetSuspicion clears it to None
    - Project compiles cleanly
  </done>
</task>

</tasks>

<verification>
- Project compiles with zero errors and zero warnings
- All new enums are BlueprintType and have UMETA DisplayNames
- All new gameplay tags follow the existing `AI.` prefix pattern
- WendigoCharacter::SetBehaviorState only broadcasts on actual change (not redundant sets)
- No circular header dependencies introduced (WendigoCharacter uses AActor* not AHidingSpotActor*)
</verification>

<success_criteria>
1. MonsterAITypes.h defines EWendigoBehaviorState, EStimulusType, FOnBehaviorStateChanged, and 8 new AIConstants
2. WendigoCharacter stores persistent chase/search state with getters and setters
3. SuspicionComponent tracks LastStimulusType through perception processing
4. Six new gameplay tags defined and compilable
5. All files compile cleanly with no warnings
</success_criteria>

<output>
After completion, create `.planning/phases/05-monster-behaviors/05-01-SUMMARY.md`
</output>
