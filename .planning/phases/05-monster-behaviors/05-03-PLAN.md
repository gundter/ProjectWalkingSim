---
phase: 05-monster-behaviors
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - Source/ProjectWalkingSim/Public/AI/Tasks/STT_GrabAttack.h
  - Source/ProjectWalkingSim/Private/AI/Tasks/STT_GrabAttack.cpp
  - Source/ProjectWalkingSim/Private/AI/Tasks/STT_InvestigateLocation.cpp
  - Source/ProjectWalkingSim/Public/AI/Tasks/STT_InvestigateLocation.h
  - Source/ProjectWalkingSim/Public/AI/Conditions/STC_StimulusType.h
  - Source/ProjectWalkingSim/Private/AI/Conditions/STC_StimulusType.cpp
autonomous: true

must_haves:
  truths:
    - "GrabAttack task disables player input, waits a duration, then triggers game over"
    - "Investigation task differentiates speed between sight (250 cm/s) and sound (200 cm/s) stimuli"
    - "STC_StimulusType condition reads LastStimulusType from SuspicionComponent and compares"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/AI/Tasks/STT_GrabAttack.h"
      provides: "Cinematic kill sequence State Tree task"
      contains: "FSTT_GrabAttack"
    - path: "Source/ProjectWalkingSim/Public/AI/Conditions/STC_StimulusType.h"
      provides: "State Tree condition for stimulus type branching"
      contains: "FSTC_StimulusType"
    - path: "Source/ProjectWalkingSim/Public/AI/Tasks/STT_InvestigateLocation.h"
      provides: "Enhanced investigation with stimulus-aware speed"
      contains: "InvestigationSightSpeed"
  key_links:
    - from: "STT_GrabAttack"
      to: "Player input disable"
      via: "EnterState gets PlayerController and calls DisableInput"
      pattern: "DisableInput"
    - from: "STT_InvestigateLocation"
      to: "SuspicionComponent::GetLastStimulusType"
      via: "EnterState reads stimulus type to select speed"
      pattern: "GetLastStimulusType"
    - from: "FSTC_StimulusType"
      to: "SuspicionComponent"
      via: "TestCondition reads LastStimulusType"
      pattern: "GetLastStimulusType.*RequiredType"
---

<objective>
Create the GrabAttack task for the cinematic player kill, enhance the existing Investigation task with stimulus-type-aware speed differentiation, and add the StimulusType State Tree condition.

Purpose: GrabAttack is the consequence for being caught -- it creates the horror moment. Investigation enhancement makes the Wendigo react differently to sight (faster, more aggressive) vs sound (slower, more cautious), giving players who learn the AI a deeper gameplay experience. The StimulusType condition enables the State Tree to branch between sight and sound investigation states.

Output: STT_GrabAttack (new), enhanced STT_InvestigateLocation, STC_StimulusType condition (new).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-monster-behaviors/05-RESEARCH.md
@.planning/phases/05-monster-behaviors/05-01-SUMMARY.md

@Source/ProjectWalkingSim/Public/AI/Tasks/STT_InvestigateLocation.h
@Source/ProjectWalkingSim/Private/AI/Tasks/STT_InvestigateLocation.cpp
@Source/ProjectWalkingSim/Public/AI/Conditions/STC_SuspicionLevel.h
@Source/ProjectWalkingSim/Private/AI/Conditions/STC_SuspicionLevel.cpp
@Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h
@Source/ProjectWalkingSim/Public/AI/MonsterAITypes.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create STT_GrabAttack and STC_StimulusType</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/Tasks/STT_GrabAttack.h
    Source/ProjectWalkingSim/Private/AI/Tasks/STT_GrabAttack.cpp
    Source/ProjectWalkingSim/Public/AI/Conditions/STC_StimulusType.h
    Source/ProjectWalkingSim/Private/AI/Conditions/STC_StimulusType.cpp
  </files>
  <action>
    **STT_GrabAttack** -- cinematic kill sequence:

    **STT_GrabAttack.h:**
    - Follow the established FSTT_ pattern (same includes as other tasks).
    - `FSTT_GrabAttackInstanceData` USTRUCT:
      - `float ElapsedTime = 0.0f;`
      - `bool bInputDisabled = false;` (track so we can restore in ExitState)
    - `FSTT_GrabAttack` USTRUCT with `meta = (DisplayName = "Grab Attack")`:
      - `TStateTreeExternalDataHandle<AAIController> ControllerHandle;`
      - UPROPERTY: `float GrabDuration = 2.0f;` (seconds of "struggle" before death)
      - UPROPERTY: `float CameraBlendTime = 0.3f;` (blend to death camera, if used)

    **STT_GrabAttack.cpp:**
    - `EnterState`:
      1. Get Wendigo, set BehaviorState to GrabAttack.
      2. Stop Wendigo movement: `Controller.StopMovement()`.
      3. Get the player pawn via `UGameplayStatics::GetPlayerPawn(World, 0)`.
      4. Get the PlayerController via `UGameplayStatics::GetPlayerController(World, 0)`.
      5. Disable player input: `PlayerController->DisableInput(PlayerController)`.
      6. Set InstanceData.bInputDisabled = true.
      7. Face the player: `Controller.SetFocus(PlayerPawn)`.
      8. Log: "Wendigo grabbed player!"
      9. Return Running.
    - `Tick`:
      1. Increment ElapsedTime.
      2. If ElapsedTime >= GrabDuration:
         - Call `UGameplayStatics::GetPlayerController(World, 0)->ConsoleCommand(TEXT("RestartLevel"))` to restart the level. This is a simple demo-appropriate death -- Phase 8 can replace with a proper death screen/respawn system.
         - Return Succeeded.
      3. Return Running.
    - `ExitState`:
      1. Re-enable player input if it was disabled (safety -- in case of interrupted transition).
      2. Clear focus.
      3. Restore WendigoWalkSpeed.

    NOTE: The RestartLevel approach is intentionally simple for demo scope. Phase 8 Polish will replace with a proper death/respawn system (fade to black, death screen, checkpoint reload). The GrabAttack task structure will remain; only the death handler changes.

    **STC_StimulusType** -- condition for branching investigation by stimulus:

    **STC_StimulusType.h:**
    - Follow the established FSTC_ pattern from STC_SuspicionLevel.
    - Include StateTreeConditionBase.h (which includes StateTreeConditionCommonBase.h).
    - Empty instance data USTRUCT `FSTC_StimulusTypeInstanceData` (required by State Tree even if stateless -- documented lesson from Phase 4).
    - `FSTC_StimulusType` USTRUCT with `meta = (DisplayName = "Stimulus Type")`, inherits FStateTreeConditionCommonBase:
      - `using FInstanceDataType = FSTC_StimulusTypeInstanceData;`
      - Override GetInstanceDataType, Link, TestCondition
      - `TStateTreeExternalDataHandle<AAIController> ControllerHandle;`
      - UPROPERTY EditAnywhere: `EStimulusType RequiredType = EStimulusType::Sight;`
      - UPROPERTY EditAnywhere: `bool bInvertCondition = false;`

    **STC_StimulusType.cpp:**
    - `Link`: Link ControllerHandle.
    - `TestCondition`:
      1. Get controller, cast pawn to AWendigoCharacter.
      2. Get SuspicionComponent->GetLastStimulusType().
      3. `bool bResult = (LastType == RequiredType);`
      4. Return `bInvertCondition ? !bResult : bResult;`

    Use the same pattern as STC_SuspicionLevel for include structure and base class.
  </action>
  <verify>
    Compile cleanly. Verify STC_StimulusType follows the same pattern as STC_SuspicionLevel (empty instance data struct, FStateTreeConditionCommonBase base). Verify STT_GrabAttack disables input in EnterState and has safety restore in ExitState.
  </verify>
  <done>
    - STT_GrabAttack disables player input, waits GrabDuration, restarts level
    - STC_StimulusType reads LastStimulusType and compares to RequiredType with optional invert
    - Both follow established FSTT_/FSTC_ patterns
    - Empty instance data struct present on condition (State Tree requirement)
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance STT_InvestigateLocation with stimulus-type-aware speed</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/Tasks/STT_InvestigateLocation.h
    Source/ProjectWalkingSim/Private/AI/Tasks/STT_InvestigateLocation.cpp
  </files>
  <action>
    **STT_InvestigateLocation.h:**
    1. Add a new UPROPERTY: `float InvestigationSightSpeed = AIConstants::WendigoInvestigateSightSpeed;` (250.0f) with EditAnywhere, Category "Investigation", meta ClampMin 50.0.
    2. Add a new UPROPERTY: `bool bUseStimulusTypeSpeed = true;` with EditAnywhere, Category "Investigation". When true, EnterState reads the SuspicionComponent's LastStimulusType and picks speed accordingly. When false, always uses InvestigationSpeed (backward-compatible default for any existing State Tree references).

    **STT_InvestigateLocation.cpp:**
    1. Add `#include "AI/MonsterAITypes.h"` if not already present (needed for EStimulusType).
    2. In `EnterState`, AFTER getting the SuspicionComponent and BEFORE setting MaxWalkSpeed:
       - If bUseStimulusTypeSpeed is true:
         - Read `EStimulusType StimulusType = Suspicion->GetLastStimulusType();`
         - If StimulusType == EStimulusType::Sight, use InvestigationSightSpeed.
         - Otherwise, use InvestigationSpeed (the existing 200 cm/s default).
       - If bUseStimulusTypeSpeed is false, use InvestigationSpeed (existing behavior).
    3. Also set Wendigo->SetBehaviorState(EWendigoBehaviorState::Investigating) in EnterState.
    4. In ExitState, set BehaviorState back to Patrol (the base state -- the next task's EnterState will set the correct state).

    This is a minimal, backward-compatible enhancement. The existing InvestigationSpeed property still works. The new flag and speed property add stimulus awareness without breaking existing behavior.

    Do NOT change the LookAroundDuration, AcceptanceRadius, or navigation logic. Only speed selection and BehaviorState are modified.
  </action>
  <verify>
    Compile cleanly. Read the modified EnterState and verify it branches on bUseStimulusTypeSpeed and LastStimulusType. Verify ExitState still restores AIConstants::WendigoWalkSpeed (unchanged from original).
  </verify>
  <done>
    - STT_InvestigateLocation selects investigation speed based on stimulus type when bUseStimulusTypeSpeed is true
    - Sight stimulus: 250 cm/s (faster, more aggressive approach)
    - Sound stimulus: 200 cm/s (slower, cautious approach)
    - BehaviorState set to Investigating on enter, restored on exit
    - Fully backward compatible (bUseStimulusTypeSpeed = true by default, but existing InvestigationSpeed value still used for sound)
  </done>
</task>

</tasks>

<verification>
- All new and modified files compile cleanly
- STT_GrabAttack properly disables/re-enables player input (no input leak on interrupted transitions)
- STC_StimulusType has empty instance data struct (avoids the "missing instance value" error from Phase 4)
- STT_InvestigateLocation modifications are backward-compatible
- All tasks restore baseline speed in ExitState
</verification>

<success_criteria>
1. STT_GrabAttack provides a demo-quality death sequence (disable input, wait, restart)
2. STC_StimulusType enables State Tree branching between sight and sound investigation states
3. STT_InvestigateLocation moves at 250 cm/s for sight stimuli and 200 cm/s for sound stimuli
4. All files compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-monster-behaviors/05-03-SUMMARY.md`
</output>
