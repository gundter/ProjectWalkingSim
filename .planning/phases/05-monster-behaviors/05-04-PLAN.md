---
phase: 05-monster-behaviors
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - Source/ProjectWalkingSim/Public/AI/WendigoSpawnPoint.h
  - Source/ProjectWalkingSim/Private/AI/WendigoSpawnPoint.cpp
  - Source/ProjectWalkingSim/Public/AI/WendigoAIController.h
  - Source/ProjectWalkingSim/Private/AI/WendigoAIController.cpp
  - Source/ProjectWalkingSim/Public/Interaction/DoorActor.h
  - Source/ProjectWalkingSim/Private/Interaction/DoorActor.cpp
autonomous: true

must_haves:
  truths:
    - "SpawnPoint actor can spawn a Wendigo and assign a random patrol route from its available routes"
    - "AI controller detects when player enters hiding while being seen and records WitnessedHidingSpot"
    - "AI controller binds to player HidingComponent on first sight detection"
    - "Doors can be opened by AI via OpenForAI without requiring inventory check"
    - "Locked doors remain impassable to AI"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/AI/WendigoSpawnPoint.h"
      provides: "Spawn point actor with zone-based patrol route arrays"
      contains: "AWendigoSpawnPoint"
    - path: "Source/ProjectWalkingSim/Public/AI/WendigoAIController.h"
      provides: "Extended AI controller with witnessed hiding detection and player binding"
      contains: "OnPlayerHidingStateChanged"
    - path: "Source/ProjectWalkingSim/Public/Interaction/DoorActor.h"
      provides: "AI-compatible door opening method"
      contains: "OpenForAI"
  key_links:
    - from: "WendigoSpawnPoint"
      to: "UWorld::SpawnActor"
      via: "SpawnWendigo creates character and assigns patrol route"
      pattern: "SpawnActor.*WendigoClass"
    - from: "WendigoAIController"
      to: "HidingComponent::OnHidingStateChanged"
      via: "Delegate binding on first sight detection"
      pattern: "OnHidingStateChanged.*AddDynamic"
    - from: "DoorActor::OpenForAI"
      to: "bIsLocked check"
      via: "AI cannot open locked doors"
      pattern: "OpenForAI.*bIsLocked"
---

<objective>
Create the WendigoSpawnPoint actor, extend the AI controller with witnessed-hiding detection and player delegate binding, and add AI-compatible door opening.

Purpose: SpawnPoint enables multiple Wendigo spawn locations with zone-based patrol assignment (WNDG-06). Witnessed-hiding detection is critical for the chase-to-search loop -- if the Wendigo saw the player hide, it knows where to look. AI door opening prevents the Wendigo from getting stuck at closed doors during chase.

Output: AWendigoSpawnPoint (new actor), extended AWendigoAIController, extended ADoorActor with OpenForAI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-monster-behaviors/05-RESEARCH.md
@.planning/phases/05-monster-behaviors/05-01-SUMMARY.md

@Source/ProjectWalkingSim/Public/AI/WendigoAIController.h
@Source/ProjectWalkingSim/Private/AI/WendigoAIController.cpp
@Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
@Source/ProjectWalkingSim/Public/AI/PatrolRouteActor.h
@Source/ProjectWalkingSim/Public/Interaction/DoorActor.h
@Source/ProjectWalkingSim/Private/Interaction/DoorActor.cpp
@Source/ProjectWalkingSim/Public/Hiding/HidingComponent.h
@Source/ProjectWalkingSim/Public/Hiding/HidingTypes.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WendigoSpawnPoint and extend DoorActor</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/WendigoSpawnPoint.h
    Source/ProjectWalkingSim/Private/AI/WendigoSpawnPoint.cpp
    Source/ProjectWalkingSim/Public/Interaction/DoorActor.h
    Source/ProjectWalkingSim/Private/Interaction/DoorActor.cpp
  </files>
  <action>
    **WendigoSpawnPoint.h:**
    - Standard AActor subclass with PROJECTWALKINGSIM_API.
    - Forward declare AWendigoCharacter and APatrolRouteActor.
    - Properties:
      - `UPROPERTY(EditInstanceOnly, BlueprintReadOnly, Category = "AI|Spawn") TArray<TObjectPtr<APatrolRouteActor>> AvailablePatrolRoutes;` (designer picks from placed routes in the level)
      - `UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "AI|Spawn") TSubclassOf<AWendigoCharacter> WendigoClass;` (typically BP_WendigoCharacter)
    - Public method: `UFUNCTION(BlueprintCallable, Category = "AI|Spawn") AWendigoCharacter* SpawnWendigo();`
    - Editor-only billboard component for level visibility (same pattern as PatrolRouteActor):
      ```cpp
      #if WITH_EDITORONLY_DATA
      UPROPERTY(VisibleAnywhere, Category = "AI|Spawn")
      TObjectPtr<UBillboardComponent> BillboardComponent;
      #endif
      ```

    **WendigoSpawnPoint.cpp:**
    - Constructor: create root scene component and billboard (WITH_EDITORONLY_DATA guard).
    - `SpawnWendigo()`:
      1. Validate WendigoClass is set. If not, log warning and return nullptr.
      2. Set up FActorSpawnParameters (SpawnCollisionHandlingOverride = AdjustIfPossibleButAlwaysSpawn).
      3. Spawn via `GetWorld()->SpawnActor<AWendigoCharacter>(WendigoClass, &GetActorTransform(), SpawnParams)`.
      4. If AvailablePatrolRoutes is not empty, pick a random route: `AvailablePatrolRoutes[FMath::RandRange(0, AvailablePatrolRoutes.Num() - 1)]`.
      5. Assign the selected route to the spawned Wendigo. NOTE: PatrolRoute is EditInstanceOnly on WendigoCharacter -- this means it cannot be set via C++ property access after spawn. Two options:
         - Option A (preferred): Change WendigoCharacter::PatrolRoute from EditInstanceOnly to EditAnywhere to allow runtime assignment.
         - Option B: Add a public setter `void SetPatrolRoute(APatrolRouteActor* Route)` to WendigoCharacter.
         Use Option B -- add a `SetPatrolRoute` method. This preserves the EditInstanceOnly restriction for level designers while enabling runtime assignment from the spawn system.
      6. Log the spawn: "Spawned Wendigo at %s with patrol route %s".
      7. Return the spawned character.

    **Also update WendigoCharacter.h/.cpp:**
    - Add public method: `void SetPatrolRoute(APatrolRouteActor* Route) { PatrolRoute = Route; CurrentWaypointIndex = 0; }`
    - This is a one-liner -- inline in the header is fine.

    **DoorActor.h:**
    - Add a new public method:
      ```cpp
      /** Open this door for an AI actor. AI cannot open locked doors. */
      UFUNCTION(BlueprintCallable, Category = "Door")
      void OpenForAI(AActor* AIActor);
      ```

    **DoorActor.cpp:**
    - Implement `OpenForAI`:
      1. If bIsLocked, return immediately (AI cannot unlock doors).
      2. If bIsOpen, return (already open).
      3. Set bIsOpen = true.
      4. Calculate open direction using the same dot product pattern as OnInteract_Implementation: `FVector::DotProduct(GetActorForwardVector(), AIActor->GetActorLocation() - GetActorLocation())`. Door swings away from AI just like it swings away from player.
      5. Set TargetAngle = OpenAngle * OpenDirection.
      6. `SetActorTickEnabled(true)` to start the rotation interpolation.
    - NOTE: bIsOpen is currently private. Move it to protected, OR (preferred) keep it private and have OpenForAI call into the existing animation system. Since OpenForAI needs to set bIsOpen, OpenDirection, and TargetAngle -- which are all private -- the cleanest approach is to make OpenForAI a friend OR simply make these fields accessible. The simplest fix: move bIsOpen, CurrentAngle, TargetAngle, and OpenDirection to protected. This is a minor visibility change that doesn't affect existing behavior.
  </action>
  <verify>
    Compile cleanly. Verify AWendigoSpawnPoint::SpawnWendigo uses SpawnActor with proper collision handling. Verify ADoorActor::OpenForAI checks bIsLocked first. Verify WendigoCharacter has SetPatrolRoute method.
  </verify>
  <done>
    - AWendigoSpawnPoint spawns a Wendigo and assigns a random patrol route from AvailablePatrolRoutes
    - WendigoCharacter::SetPatrolRoute enables runtime patrol route assignment
    - DoorActor::OpenForAI opens non-locked doors for AI actors using the same swing-direction logic
    - Locked doors remain impassable to AI
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend WendigoAIController with witnessed-hiding detection</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/WendigoAIController.h
    Source/ProjectWalkingSim/Private/AI/WendigoAIController.cpp
  </files>
  <action>
    **WendigoAIController.h:**
    Add to the class:
    1. New private UFUNCTION: `void OnPlayerHidingStateChanged(EHidingState NewState);` -- delegate callback for player hiding.
    2. Forward declare: `enum class EHidingState : uint8;` at the top of the file.
    3. New private member: `bool bPlayerDelegateBound = false;` -- tracks whether we've bound to the player's HidingComponent delegate. Only bind once on first sight detection.
    4. New private member: `TWeakObjectPtr<AActor> TrackedPlayer;` -- the player actor we've bound delegates to.
    5. New private method: `void BindToPlayerDelegates(AActor* PlayerActor);` -- finds HidingComponent on the player and binds OnPlayerHidingStateChanged.

    **WendigoAIController.cpp:**
    Add includes:
    - `#include "Hiding/HidingComponent.h"` (for UHidingComponent)
    - `#include "Hiding/HidingTypes.h"` (for EHidingState)
    - `#include "Perception/AISense_Sight.h"` (already included)

    **BindToPlayerDelegates:**
    1. If bPlayerDelegateBound is true and TrackedPlayer is still valid, return early (already bound).
    2. Find UHidingComponent on the PlayerActor.
    3. If found, bind `HidingComp->OnHidingStateChanged.AddDynamic(this, &AWendigoAIController::OnPlayerHidingStateChanged)`.
    4. Set TrackedPlayer = PlayerActor, bPlayerDelegateBound = true.
    5. Log: "Bound to player hiding delegate".

    **OnPlayerHidingStateChanged:**
    1. If NewState != EHidingState::Entering, return (we only care about the moment the player starts hiding).
    2. Check if we currently see the player: `AIPerceptionComponent->GetCurrentlyPerceivedActors(UAISense_Sight::StaticClass(), PerceivedActors)`.
    3. If the player IS in the perceived list (Wendigo currently sees them):
       - Get the player's HidingComponent, get GetCurrentHidingSpot().
       - If spot is valid, call Wendigo->SetWitnessedHidingSpot(Spot) on the AWendigoCharacter.
       - Log: "Wendigo witnessed player entering hiding spot %s".
    4. If the player is NOT in the perceived list, do nothing (Wendigo didn't see the hiding -- the spot is safe).

    **ProcessSightPerception (modify existing):**
    - In the `bCurrentlySensed == true` branch, AFTER the existing log line, call `BindToPlayerDelegates(Player)`. This binds on first sight detection and is a no-op on subsequent calls (bPlayerDelegateBound guard).

    **Also in Tick (modify existing sight processing loop):**
    - After `SuspicionComp->SetStimulusLocation(Actor->GetActorLocation())`, also call `Wendigo->SetLastKnownPlayerLocation(Actor->GetActorLocation())`. This keeps the WendigoCharacter's persistent last-known-player updated every tick while the Wendigo can see the player. The STT_ChasePlayer task also updates this, but having it in the controller's Tick ensures it's always current regardless of which State Tree task is active.

    IMPORTANT: Do NOT bind the delegate in the constructor or BeginPlay -- the player may not exist yet. Bind on first sight detection (Pitfall 7 from research).
    IMPORTANT: OnPlayerHidingStateChanged must be a UFUNCTION for dynamic delegate binding.
  </action>
  <verify>
    Compile cleanly. Verify OnPlayerHidingStateChanged is declared as UFUNCTION(). Verify BindToPlayerDelegates has an early-return guard for bPlayerDelegateBound. Verify ProcessSightPerception calls BindToPlayerDelegates only in the bCurrentlySensed=true branch.
  </verify>
  <done>
    - AI controller binds to player's HidingComponent::OnHidingStateChanged on first sight detection
    - When player enters hiding while being seen, Wendigo records WitnessedHidingSpot
    - When player hides unseen, no witnessed hiding is recorded (hiding is safe)
    - Tick continuously updates LastKnownPlayerLocation on WendigoCharacter while seeing player
    - Delegate binding has proper guard against double-binding
  </done>
</task>

</tasks>

<verification>
- All modified and new files compile cleanly
- AWendigoSpawnPoint spawns Wendigos with patrol route assignment via SetPatrolRoute
- ADoorActor::OpenForAI respects lock state (locked = impassable)
- AWendigoAIController binds to player hiding delegate on first sight (not in constructor)
- Witnessed hiding only recorded when Wendigo had active sight perception at the moment of hiding entry
- No circular header dependencies (forward declarations used appropriately)
</verification>

<success_criteria>
1. WendigoSpawnPoint can spawn a Wendigo at its location with a randomly selected patrol route
2. AI controller detects witnessed hiding via perception + delegate timing
3. DoorActor provides AI-compatible opening that respects lock state
4. All files compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-monster-behaviors/05-04-SUMMARY.md`
</output>
