---
phase: 05-monster-behaviors
plan: 05
type: execute
wave: 3
depends_on: ["05-02", "05-03", "05-04"]
files_modified:
  - Content/AI/ST_WendigoAI.uasset
  - Content/AI/BP_WendigoSpawnPoint.uasset
autonomous: false

must_haves:
  truths:
    - "State Tree has Alert container with Chase, GrabAttack, and Search states"
    - "State Tree transitions from Chase to Search when LOS is lost (Failed)"
    - "State Tree transitions from Chase to GrabAttack when player is grabbed (Succeeded)"
    - "State Tree transitions from Search back to Patrol when search completes"
    - "Suspicious container branches investigation by stimulus type (sight vs sound)"
    - "BP_WendigoSpawnPoint exists with WendigoClass set to BP_WendigoCharacter"
    - "Player can escape chase by hiding and waiting for search to complete"
    - "Wendigo investigates sounds before returning to patrol"
  artifacts:
    - path: "Content/AI/ST_WendigoAI.uasset"
      provides: "Updated State Tree with full Alert container, stimulus-type investigation branching"
      min_lines: 1
    - path: "Content/AI/BP_WendigoSpawnPoint.uasset"
      provides: "Blueprint spawn point actor"
      min_lines: 1
  key_links:
    - from: "ST_WendigoAI Alert container"
      to: "STT_ChasePlayer"
      via: "Chase state runs STT_ChasePlayer task"
      pattern: "Chase Player"
    - from: "ST_WendigoAI Alert container"
      to: "STT_SearchArea"
      via: "Search state runs STT_SearchArea task, entered on Chase failure"
      pattern: "Search Area"
    - from: "ST_WendigoAI Suspicious container"
      to: "STC_StimulusType"
      via: "Enter conditions branch by LastStimulusType"
      pattern: "Stimulus Type"
---

<objective>
Update the State Tree asset with the full Phase 5 behavior hierarchy and create the SpawnPoint Blueprint. Then verify all Phase 5 behaviors in PIE.

Purpose: This is the integration plan that wires all Phase 5 C++ work into functional editor assets and verifies the complete predator loop: Patrol -> Suspicious (investigate) -> Alert (chase -> search -> return to patrol). This is the only plan that requires human interaction (PIE verification).

Output: Updated ST_WendigoAI with Alert container, BP_WendigoSpawnPoint, verified AI behaviors in PIE.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-monster-behaviors/05-RESEARCH.md
@.planning/phases/05-monster-behaviors/05-01-SUMMARY.md
@.planning/phases/05-monster-behaviors/05-02-SUMMARY.md
@.planning/phases/05-monster-behaviors/05-03-SUMMARY.md
@.planning/phases/05-monster-behaviors/05-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update State Tree and create SpawnPoint Blueprint via Python</name>
  <files>
    Content/AI/ST_WendigoAI.uasset
    Content/AI/BP_WendigoSpawnPoint.uasset
  </files>
  <action>
    The State Tree asset (ST_WendigoAI) must be updated in the Unreal Editor to include the new Phase 5 states. Since State Tree assets cannot be fully created via Python scripting (their internal structure uses binary serialization), provide **detailed step-by-step editor instructions** as a text file that the human will follow, AND create the BP_WendigoSpawnPoint Blueprint via Python where possible.

    **Create a Python editor script** at `Content/Python/setup_phase5_assets.py`:

    1. **BP_WendigoSpawnPoint creation:**
       - Use `unreal.EditorAssetLibrary` and `unreal.AssetToolsHelpers.get_asset_tools()` to create a Blueprint based on AWendigoSpawnPoint.
       - Note: If AWendigoSpawnPoint is not Blueprintable, the Blueprint may need to be created manually. In that case, just log instructions.
       - Set WendigoClass default to BP_WendigoCharacter (load `/Game/AI/BP_WendigoCharacter`).

    2. **State Tree update instructions** -- generate a text file at `Content/Python/StateTree_Phase5_Instructions.txt` with these exact steps:

    ```
    STATE TREE UPDATE INSTRUCTIONS - Phase 5
    ==========================================

    Open ST_WendigoAI in the State Tree editor.

    STEP 1: Add Alert Container (TOP priority - above Suspicious)
    - Right-click on Root -> Add State -> "Alert"
    - Set it as a Container (not Leaf)
    - Add Enter Condition: STC_SuspicionLevel with RequiredLevel = Alert
    - This container MUST be ABOVE Suspicious and Patrol in the hierarchy
      (State Tree evaluates top-to-bottom, highest priority first)

    STEP 2: Add Chase State (inside Alert container)
    - Right-click Alert -> Add Child State -> "Chase"
    - Set as Leaf
    - Add Task: "Chase Player" (STT_ChasePlayer)
    - Configure properties:
      - ChaseSpeed: 575.0
      - LOSLostTimeout: 3.0
      - GrabRange: 150.0
      - AcceptanceRadius: 50.0
    - Add Transition: On Succeeded -> GrabAttack (sibling state)
    - Add Transition: On Failed -> Search (sibling state)

    STEP 3: Add GrabAttack State (inside Alert container)
    - Right-click Alert -> Add Child State -> "GrabAttack"
    - Set as Leaf
    - Add Task: "Grab Attack" (STT_GrabAttack)
    - Configure: GrabDuration: 2.0
    - No outgoing transitions needed (restarts level)

    STEP 4: Add Search State (inside Alert container)
    - Right-click Alert -> Add Child State -> "Search"
    - Set as Leaf
    - Add Task: "Search Area" (STT_SearchArea)
    - Configure:
      - SearchSpeed: 180.0
      - SearchRadius: 600.0
      - NumRandomPoints: 3
      - MaxSearchDuration: 18.0
      - LingerDuration: 3.0
    - Add Transition: On Succeeded -> exits Alert container
      (This causes fall-through to Suspicious or Patrol based on current suspicion)
    - Add On Tick Transition: STC_SuspicionLevel >= Alert -> Chase
      (If search re-detects the player, go back to chase)

    STEP 5: Update Suspicious Container (investigation branching)
    - In the existing Suspicious container:
    - Rename existing InvestigateLocation state to "InvestigateSound"
    - Add Enter Condition to InvestigateSound: STC_StimulusType with RequiredType = Sound
    - Configure InvestigateSound task: bUseStimulusTypeSpeed = true (speed will auto-select 200)
    - Add new sibling state "InvestigateSight" ABOVE InvestigateSound:
      - Add Task: "Investigate Location" (STT_InvestigateLocation)
      - Add Enter Condition: STC_StimulusType with RequiredType = Sight
      - Configure: bUseStimulusTypeSpeed = true, InvestigationSightSpeed = 250.0
    - Keep OrientToward as the fallback (lowest in Suspicious children)
    - Add On Tick Transition on BOTH investigate states: STC_SuspicionLevel >= Alert -> exits Suspicious
      (If suspicion escalates to Alert during investigation, chase begins)

    STEP 6: Add ReturnToNearestWaypoint to Search flow
    - Option A: Add a "ReturnToPatrol" leaf state inside Alert, after Search
      - Task: "Return To Nearest Waypoint" (STT_ReturnToNearestWaypoint)
      - Search On Succeeded transition points to ReturnToPatrol instead of exiting Alert
      - ReturnToPatrol On Succeeded -> exits Alert container
    - Option B: Let Search Succeeded exit Alert directly (patrol resumes from wherever Wendigo is)
      - Simpler but may cause a "jump" to the nearest waypoint on next patrol tick
    - Use Option A for smoother patrol resumption

    STEP 7: Verify hierarchy order (top to bottom):
    1. Alert (container) - highest priority
       - Chase (leaf)
       - GrabAttack (leaf)
       - Search (leaf)
       - ReturnToPatrol (leaf)
    2. Suspicious (container)
       - InvestigateSight (leaf)
       - InvestigateSound (leaf)
       - OrientToward (leaf)
    3. Patrol (container) - lowest priority
       - MoveToWaypoint (leaf)
       - Idle (leaf)

    STEP 8: Save the State Tree asset
    ```

    Run the Python script via `unreal.PythonScriptCommandlet` or manual execution in the editor's Python console.

    IMPORTANT: State Tree hierarchy order matters -- Alert MUST be above Suspicious which MUST be above Patrol. The State Tree evaluates children top-to-bottom and enters the first one whose conditions are met.
  </action>
  <verify>
    Python script runs without errors. BP_WendigoSpawnPoint exists in Content/AI/. StateTree_Phase5_Instructions.txt is generated. Verify the instruction file covers all 8 steps.
  </verify>
  <done>
    - BP_WendigoSpawnPoint Blueprint created with WendigoClass default set
    - State Tree update instructions generated with complete step-by-step guide
    - Instructions cover: Alert container, Chase/GrabAttack/Search states, investigation branching, ReturnToPatrol, hierarchy ordering
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Phase 5 Monster Behaviors: Complete predator behavior loop.

    C++ implementation:
    - STT_ChasePlayer: MoveToActor pursuit with LOS timer (3s) and grab range check (150cm)
    - STT_SearchArea: Last-known position + 2-3 random NavMesh search points with linger
    - STT_GrabAttack: Disable player input, 2s wait, restart level (demo death)
    - STT_ReturnToNearestWaypoint: Navigate to closest patrol waypoint for seamless resumption
    - STC_StimulusType: State Tree condition for sight vs sound branching
    - Enhanced STT_InvestigateLocation: 250 cm/s for sight, 200 cm/s for sound stimuli
    - AWendigoSpawnPoint: Spawn actor with zone-based patrol route selection
    - Witnessed hiding detection: AI controller tracks when Wendigo sees player enter hiding
    - DoorActor::OpenForAI: AI-compatible door opening (respects locks)

    State Tree: Updated ST_WendigoAI with Alert container (Chase -> Search -> ReturnToPatrol), stimulus-type investigation branching, and proper hierarchy ordering.
  </what-built>
  <how-to-verify>
    Open the project in Unreal Editor and follow the State Tree update instructions if not already applied.

    **Test 1: Chase behavior (WNDG-04)**
    1. Place BP_WendigoCharacter with a patrol route in the test level
    2. PIE and walk into the Wendigo's line of sight
    3. Wait for suspicion to reach Alert (watch the debug log for "Alert=%d" = 2)
    4. Verify: Wendigo moves toward the player at noticeably faster speed (~575 cm/s)
    5. Verify: Wendigo head tracks the player during chase (SetFocus)
    6. Let the Wendigo catch you -- verify grab attack triggers (input disabled, level restarts)

    **Test 2: Search behavior (WNDG-05)**
    1. PIE and trigger a chase (get spotted)
    2. Break line of sight (go around a corner or behind a wall)
    3. Wait ~3 seconds for the LOS timer to expire
    4. Verify: Wendigo transitions from Chase to Search (debug log: "BehaviorState = Searching")
    5. Verify: Wendigo moves to your last position then checks 2-3 nearby spots
    6. Wait ~18 seconds for search to complete
    7. Verify: Wendigo returns to patrol (navigates to nearest waypoint)

    **Test 3: Hide to escape chase (WNDG-05)**
    1. PIE, trigger a chase, then hide in a hiding spot WHILE the Wendigo can see you
    2. Verify: Wendigo records witnessed hiding spot (debug log: "Wendigo witnessed player entering")
    3. Restart: trigger a chase, break LOS first, THEN hide
    4. Verify: No witnessed hiding log -- hiding spot is safe
    5. Wait for search to complete, verify Wendigo returns to patrol

    **Test 4: Investigation differentiation (WNDG-03)**
    1. PIE with the Wendigo on patrol
    2. Sprint near the Wendigo to trigger sound investigation
    3. Verify: Wendigo approaches cautiously at slower speed (~200 cm/s)
    4. Hide and wait for patrol to resume
    5. Walk into partial view (visible but not long enough for Alert)
    6. Verify: Sight investigation is faster (~250 cm/s)

    **Test 5: Spawn point (WNDG-06)**
    1. Place a BP_WendigoSpawnPoint in the level
    2. Assign at least 2 patrol routes to its AvailablePatrolRoutes array
    3. Set WendigoClass to BP_WendigoCharacter
    4. In level Blueprint or BeginPlay, call SpawnWendigo on the spawn point
    5. Verify: A Wendigo spawns at the spawn point location and begins patrolling one of the assigned routes

    Report any issues found. If chase speed, search timing, or grab behavior need tuning, describe the issue and the behavior you observed.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- State Tree updated with full Phase 5 hierarchy
- BP_WendigoSpawnPoint Blueprint created
- All 5 PIE tests pass: chase, search, hide-to-escape, investigation differentiation, spawn point
- No speed leaks (Wendigo returns to patrol speed after chase/search)
- No input leaks (player can move after GrabAttack restarts level)
</verification>

<success_criteria>
1. Wendigo chases spotted player at increased speed (WNDG-04)
2. Wendigo investigates sounds and visual disturbances with differentiated reactions (WNDG-03)
3. Wendigo searches area when player breaks LOS, returns to patrol after timeout (WNDG-05)
4. Player can escape chase by hiding and waiting for search to complete (WNDG-05)
5. Wendigo can spawn at designated locations with zone-appropriate patrol routes (WNDG-06)
</success_criteria>

<output>
After completion, create `.planning/phases/05-monster-behaviors/05-05-SUMMARY.md`
</output>
