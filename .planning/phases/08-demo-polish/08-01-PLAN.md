---
phase: 08-demo-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Source/ProjectWalkingSim/Public/Narrative/NarrativeTriggerActor.h
  - Source/ProjectWalkingSim/Private/Narrative/NarrativeTriggerActor.cpp
  - Source/ProjectWalkingSim/Public/Narrative/DemoEndingManager.h
  - Source/ProjectWalkingSim/Private/Narrative/DemoEndingManager.cpp
  - Source/ProjectWalkingSim/Public/Tags/SereneTags.h
  - Source/ProjectWalkingSim/Private/Tags/SereneTags.cpp
autonomous: true

must_haves:
  truths:
    - "A trigger volume in the level can play a detective monologue when the player walks through it"
    - "A trigger volume fires only once per playthrough (one-shot guard)"
    - "A trigger volume broadcasts a delegate that other systems can listen to (e.g., spawn Wendigo)"
    - "The demo ending sequence fades to black, fades audio, and shows a title card widget"
    - "Player input is disabled during the ending sequence"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Narrative/NarrativeTriggerActor.h"
      provides: "Overlap-based narrative trigger actor"
      contains: "ANarrativeTriggerActor"
    - path: "Source/ProjectWalkingSim/Private/Narrative/NarrativeTriggerActor.cpp"
      provides: "Trigger implementation with one-shot guard, delay, PlaySound2D, delegate broadcast"
      contains: "OnOverlapBegin"
    - path: "Source/ProjectWalkingSim/Public/Narrative/DemoEndingManager.h"
      provides: "Ending sequence orchestrator component"
      contains: "UDemoEndingManager"
    - path: "Source/ProjectWalkingSim/Private/Narrative/DemoEndingManager.cpp"
      provides: "Fade-to-black via StartCameraFade, input disable, title card display"
      contains: "TriggerEnding"
  key_links:
    - from: "NarrativeTriggerActor.cpp"
      to: "UGameplayStatics::PlaySound2D"
      via: "MonologueSound playback on overlap"
      pattern: "PlaySound2D.*MonologueSound"
    - from: "DemoEndingManager.cpp"
      to: "APlayerCameraManager::StartCameraFade"
      via: "Screen fade to black"
      pattern: "StartCameraFade"
    - from: "NarrativeTriggerActor.h"
      to: "OnNarrativeTriggered delegate"
      via: "BlueprintAssignable delegate for downstream wiring"
      pattern: "FOnNarrativeTriggered"
---

<objective>
Create the narrative infrastructure for the demo: NarrativeTriggerActor (overlap-based monologue/event trigger) and DemoEndingManager (fade-to-black title card ending sequence). Add new gameplay tags for narrative and inspectable interactions.

Purpose: These two classes provide the backbone for the demo's story delivery (DEMO-02) and ending (DEMO-04). NarrativeTriggerActor fires detective monologues and triggers game events (like Wendigo spawning) when the player enters volumes. DemoEndingManager orchestrates the demo's final moments: disable input, play final monologue, fade to black, show "The Juniper Tree" title card.

Output: Two new C++ classes in a Narrative/ folder, plus updated SereneTags with new tag declarations. Project compiles cleanly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-demo-polish/08-RESEARCH.md

@Source/ProjectWalkingSim/Public/Tags/SereneTags.h
@Source/ProjectWalkingSim/Private/Tags/SereneTags.cpp
@Source/ProjectWalkingSim/Public/Interaction/InteractableBase.h
@Source/ProjectWalkingSim/Public/AI/WendigoSpawnPoint.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: NarrativeTriggerActor with one-shot overlap trigger</name>
  <files>
    Source/ProjectWalkingSim/Public/Narrative/NarrativeTriggerActor.h
    Source/ProjectWalkingSim/Private/Narrative/NarrativeTriggerActor.cpp
    Source/ProjectWalkingSim/Public/Tags/SereneTags.h
    Source/ProjectWalkingSim/Private/Tags/SereneTags.cpp
  </files>
  <action>
    Create directories: Public/Narrative/ and Private/Narrative/.

    Create ANarrativeTriggerActor : public AActor with:
    - UBoxComponent* TriggerBox as root (SetCollisionProfileName("Trigger"), default extent 200x200x100)
    - PrimaryActorTick.bCanEverTick = false
    - UPROPERTY(EditAnywhere, Category="Narrative") TObjectPtr of USoundBase MonologueSound -- the audio to play
    - UPROPERTY(EditAnywhere, Category="Narrative", meta=(MultiLine=true)) FText SubtitleText -- optional subtitle
    - UPROPERTY(EditAnywhere, Category="Narrative") bool bOneShot = true -- fire once only
    - UPROPERTY(EditAnywhere, Category="Narrative") float TriggerDelay = 0.0f -- delay before playing
    - bool bHasTriggered = false (private, NOT UPROPERTY since it resets on load per research decision)
    - DECLARE_DYNAMIC_MULTICAST_DELEGATE(FOnNarrativeTriggered) -- BlueprintAssignable delegate
    - OnActorBeginOverlap binding in constructor via AddDynamic
    - OnOverlapBegin handler: guard bOneShot && bHasTriggered, verify OtherActor is player-controlled APawn, set bHasTriggered=true, then either use FTimerHandle with TriggerDelay or immediately call the playback lambda
    - Playback: PlaySound2D(this, MonologueSound) if set, then OnNarrativeTriggered.Broadcast()
    - Include proper copyright header: // Copyright Null Lantern.
    - Use UE_LOG(LogSerene, ...) for logging
    - Include "Components/BoxComponent.h", "Kismet/GameplayStatics.h"

    Add to SereneTags.h and SereneTags.cpp:
    - TAG_Interaction_Inspectable (for InspectableActor in Plan 02)
    - TAG_Narrative_Trigger (for NarrativeTriggerActor identification if needed)

    IMPORTANT: Use OnActorBeginOverlap.AddDynamic (actor-level overlap), NOT component-level overlap, since TriggerBox is root. Actually -- since TriggerBox IS the root and may not generate actor-level overlaps correctly, use TriggerBox->OnComponentBeginOverlap.AddDynamic instead with the UPrimitiveComponent signature: void OnTriggerOverlap(UPrimitiveComponent* OverlappedComponent, AActor* OtherActor, UPrimitiveComponent* OtherComp, int32 OtherBodyIndex, bool bFromSweep, const FHitResult& SweepResult). This is more reliable than actor-level overlaps.
  </action>
  <verify>
    Build succeeds: run UBT build command. No errors related to NarrativeTriggerActor or SereneTags.
  </verify>
  <done>
    NarrativeTriggerActor.h/.cpp exist and compile. SereneTags has TAG_Interaction_Inspectable and TAG_Narrative_Trigger. The actor has a box trigger, one-shot guard, delay support, PlaySound2D monologue playback, and a BlueprintAssignable OnNarrativeTriggered delegate.
  </done>
</task>

<task type="auto">
  <name>Task 2: DemoEndingManager component with fade-to-black and title card</name>
  <files>
    Source/ProjectWalkingSim/Public/Narrative/DemoEndingManager.h
    Source/ProjectWalkingSim/Private/Narrative/DemoEndingManager.cpp
  </files>
  <action>
    Create UDemoEndingManager : public UActorComponent with:
    - UCLASS(ClassGroup=(Custom), meta=(BlueprintSpawnableComponent))
    - UPROPERTY(EditAnywhere, Category="Demo|Ending") float FadeDuration = 3.0f
    - UPROPERTY(EditAnywhere, Category="Demo|Ending") float TitleCardDelay = 2.0f
    - UPROPERTY(EditDefaultsOnly, Category="Demo|Ending") TSubclassOf of UUserWidget TitleCardWidgetClass
    - UPROPERTY(EditAnywhere, Category="Demo|Ending") TObjectPtr of USoundBase FinalMonologue -- optional last audio
    - UFUNCTION(BlueprintCallable, Category="Demo") void TriggerEnding()

    TriggerEnding implementation:
    1. Get APlayerController* PC via GetWorld()->GetFirstPlayerController(). Guard nullptr.
    2. Disable gameplay input: PC->DisableInput(PC)
    3. If FinalMonologue is set, call UGameplayStatics::PlaySound2D(this, FinalMonologue)
    4. Fade to black: PC->PlayerCameraManager->StartCameraFade(0.f, 1.f, FadeDuration, FLinearColor::Black, true /*bShouldFadeAudio*/, true /*bHoldWhenFinished*/)
    5. Set a timer (FTimerHandle, stored as member to prevent GC issues) for FadeDuration + TitleCardDelay
    6. Timer callback: if TitleCardWidgetClass && PC, CreateWidget of UUserWidget(PC, TitleCardWidgetClass), AddToViewport(200). Then set input mode to UI only and show cursor so player can interact with any title card buttons.

    Store the FTimerHandle as a UPROPERTY() member to keep it alive. Also store TObjectPtr of UUserWidget TitleCardInstance to prevent GC.

    Add a bool bEndingTriggered = false guard to prevent multiple calls.

    Include: "Kismet/GameplayStatics.h", "Camera/PlayerCameraManager.h", "Blueprint/UserWidget.h", "GameFramework/PlayerController.h"

    Copyright header and LogSerene logging.
  </action>
  <verify>
    Build succeeds: run UBT build command. No errors related to DemoEndingManager.
  </verify>
  <done>
    DemoEndingManager.h/.cpp exist and compile. TriggerEnding() disables input, plays optional monologue, fades screen to black via StartCameraFade, and shows a title card widget after the fade completes. Has double-trigger guard.
  </done>
</task>

</tasks>

<verification>
1. Full project build succeeds with zero errors
2. NarrativeTriggerActor has: UBoxComponent trigger, bOneShot guard, TriggerDelay, MonologueSound, SubtitleText, OnNarrativeTriggered delegate
3. DemoEndingManager has: TriggerEnding(), StartCameraFade, timer-based title card display, input disable, bEndingTriggered guard
4. SereneTags.h/cpp have TAG_Interaction_Inspectable and TAG_Narrative_Trigger
5. All files have // Copyright Null Lantern. header
6. All logging uses UE_LOG(LogSerene, ...)
</verification>

<success_criteria>
- Project compiles cleanly with the 4 new source files and 2 modified tag files
- NarrativeTriggerActor is ready for level placement (overlap triggers monologue + broadcasts delegate)
- DemoEndingManager is ready to be attached to an actor and connected to a NarrativeTriggerActor delegate for the ending
</success_criteria>

<output>
After completion, create `.planning/phases/08-demo-polish/08-01-SUMMARY.md`
</output>
