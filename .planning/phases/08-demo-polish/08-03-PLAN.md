---
phase: 08-demo-polish
plan: 03
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - Source/ProjectWalkingSim/Public/Interaction/ReadableActor.h
  - Source/ProjectWalkingSim/Private/Interaction/ReadableActor.cpp
  - Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
  - Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
  - Source/ProjectWalkingSim/Private/Player/HUD/DocumentReaderWidget.cpp
autonomous: true

must_haves:
  truths:
    - "ReadableActor opens a DocumentReaderWidget on interaction instead of just logging"
    - "Player cannot open inventory or pause while a document/inspection is open"
    - "Esc key while document is open closes the document (not pause menu)"
    - "Controller tracks bIsDocumentOpen state to guard other UI operations"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Interaction/ReadableActor.h"
      provides: "ReadableActor with DocumentReaderWidgetClass property"
      contains: "DocumentReaderWidgetClass"
    - path: "Source/ProjectWalkingSim/Private/Interaction/ReadableActor.cpp"
      provides: "OnInteract creates and shows DocumentReaderWidget"
      contains: "CreateWidget"
    - path: "Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h"
      provides: "Controller with bIsDocumentOpen guard and IsDocumentOpen query"
      contains: "bIsDocumentOpen"
    - path: "Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp"
      provides: "Input guards for document-open state"
      contains: "bIsDocumentOpen"
  key_links:
    - from: "ReadableActor.cpp"
      to: "DocumentReaderWidget::ShowDocument"
      via: "OnInteract creates widget and calls ShowDocument with ReadableTitle and ReadableContent"
      pattern: "ShowDocument.*ReadableTitle.*ReadableContent"
    - from: "SerenePlayerController.cpp"
      to: "bIsDocumentOpen"
      via: "HandlePause and HandleToggleInventory check bIsDocumentOpen before opening UI"
      pattern: "bIsDocumentOpen"
---

<objective>
Wire ReadableActor to open the DocumentReaderWidget on interaction (replacing the placeholder log), and add document-open state guards to SerenePlayerController to prevent inventory/pause conflicts.

Purpose: ReadableActor has existed since Phase 1 with ReadableTitle/ReadableContent but only logs on interact. This plan completes the circuit: interact with a note -> full-screen document display. The controller needs guards so Esc while reading closes the document (not pause), and Tab while reading is blocked.

Output: Modified ReadableActor.h/.cpp and SerenePlayerController.h/.cpp. Project compiles cleanly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-demo-polish/08-RESEARCH.md
@.planning/phases/08-demo-polish/08-02-SUMMARY.md

@Source/ProjectWalkingSim/Public/Interaction/ReadableActor.h
@Source/ProjectWalkingSim/Private/Interaction/ReadableActor.cpp
@Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
@Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
@Source/ProjectWalkingSim/Public/Player/HUD/PauseMenuWidget.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: ReadableActor opens DocumentReaderWidget on interaction</name>
  <files>
    Source/ProjectWalkingSim/Public/Interaction/ReadableActor.h
    Source/ProjectWalkingSim/Private/Interaction/ReadableActor.cpp
  </files>
  <action>
    Modify ReadableActor to create and display a DocumentReaderWidget when interacted with.

    ReadableActor.h changes:
    - Forward declare UDocumentReaderWidget
    - Add UPROPERTY(EditDefaultsOnly, Category="Readable") TSubclassOf of UDocumentReaderWidget DocumentReaderWidgetClass

    ReadableActor.cpp changes:
    - Add include: "Player/HUD/DocumentReaderWidget.h"
    - Replace OnInteract_Implementation body:
      1. Get APlayerController from Interactor: Cast Interactor to APawn, then GetController cast to APlayerController. Guard nullptr.
      2. Guard: if (!DocumentReaderWidgetClass) { UE_LOG warning and return; }
      3. Create widget: UDocumentReaderWidget* ReaderWidget = CreateWidget of UDocumentReaderWidget(PC, DocumentReaderWidgetClass)
      4. If !ReaderWidget, log error and return
      5. ReaderWidget->AddToViewport(50)
      6. ReaderWidget->ShowDocument(ReadableTitle, ReadableContent)
      7. Keep the existing log line (useful for debugging): UE_LOG(LogSerene, Log, TEXT("AReadableActor::OnInteract - Reading: %s"), *ReadableTitle.ToString())

    NOTE: The widget creates itself fresh each time and removes itself on close (via CloseDocument -> RemoveFromParent). No need to cache the widget instance on the actor. This avoids stale state issues.

    NOTE: The widget handles its own input mode switching internally (ShowDocument sets UIOnly, CloseDocument restores GameOnly). The actor just creates and shows it.
  </action>
  <verify>
    Build succeeds: run UBT build command. ReadableActor compiles with DocumentReaderWidgetClass property and CreateWidget call.
  </verify>
  <done>
    ReadableActor interaction creates a DocumentReaderWidget, adds it to viewport, and calls ShowDocument with the readable's title and content. DocumentReaderWidgetClass is configurable per Blueprint subclass.
  </done>
</task>

<task type="auto">
  <name>Task 2: SerenePlayerController document-open state guards</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
    Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
    Source/ProjectWalkingSim/Private/Player/HUD/DocumentReaderWidget.cpp
  </files>
  <action>
    Add document-open state tracking to SerenePlayerController so that inventory and pause are blocked while a document or inspection overlay is open.

    SerenePlayerController.h changes:
    - Add public methods:
      - void SetDocumentOpen(bool bOpen) -- called by DocumentReaderWidget or actors
      - bool IsDocumentOpen() const { return bIsDocumentOpen; }
    - Add private member: bool bIsDocumentOpen = false

    SerenePlayerController.cpp changes:
    - Implement SetDocumentOpen:
      ```
      void ASerenePlayerController::SetDocumentOpen(bool bOpen)
      {
          bIsDocumentOpen = bOpen;
      }
      ```

    - Modify HandlePause: Add guard at the TOP (before inventory check):
      ```
      // Esc while document is open: close document, don't open pause
      // The document widget handles its own close via NativeOnKeyDown (E or Esc)
      // so we just block pause from opening
      if (bIsDocumentOpen)
      {
          return;
      }
      ```
      This works because: NativeOnKeyDown on the widget will consume E/Esc first (widget has focus in UIOnly mode). But as a safety net, the controller also blocks pause opening.

    - Modify HandleToggleInventory: Add guard at the TOP:
      ```
      if (bIsDocumentOpen)
      {
          return;
      }
      ```

    - Modify HandleInteract: Add guard before the normal interaction path:
      ```
      // Block interaction while document is open
      if (bIsDocumentOpen)
      {
          return;
      }
      ```

    NOTE: The DocumentReaderWidget itself handles Esc/E via NativeOnKeyDown because it has keyboard focus in UIOnly mode. The controller guards are defense-in-depth: they prevent edge cases where input bleeds through (e.g., Enhanced Input actions that fire regardless of focus).

    NOTE: SetDocumentOpen(true) should be called by ReadableActor/InspectableActor right before ShowDocument/ShowInspection. SetDocumentOpen(false) should be called when the widget fires OnDocumentClosed. Since ReadableActor creates a fresh widget each time and doesn't cache it, we need a simple approach: have the actors call SetDocumentOpen(true) before showing the widget, and bind OnDocumentClosed to set it false.

    Update ReadableActor.cpp OnInteract_Implementation (in this same task since we're modifying the controller):
    - After creating the widget, before ShowDocument:
      - Cast PC to ASerenePlayerController* SPC
      - If SPC: SPC->SetDocumentOpen(true)
      - Bind widget OnDocumentClosed to a lambda or create a small helper: use a weak lambda that calls SPC->SetDocumentOpen(false). Since OnDocumentClosed is a dynamic delegate, we need a UFUNCTION. Instead, use a simpler approach:
        Have DocumentReaderWidget call SetDocumentOpen(false) directly in CloseDocument() by getting the owning player controller and casting. This is cleaner than binding delegates per-actor.

    Actually, the CLEANEST approach: Modify DocumentReaderWidget::CloseDocument() to also call SetDocumentOpen(false) on the controller. And modify DocumentReaderWidget::ShowDocument()/ShowInspection() to call SetDocumentOpen(true). This keeps the state management in ONE place (the widget) rather than scattered across ReadableActor and InspectableActor.

    So ALSO modify DocumentReaderWidget.cpp (minor change):
    - In ShowDocument and ShowInspection, after getting the PC, cast to ASerenePlayerController and call SetDocumentOpen(true)
    - In CloseDocument, cast GetOwningPlayer to ASerenePlayerController and call SetDocumentOpen(false)
    - Add include: "Player/SerenePlayerController.h"

    This means ReadableActor and InspectableActor do NOT need to know about SetDocumentOpen at all. The widget self-manages.
  </action>
  <verify>
    Build succeeds: run UBT build command. SerenePlayerController has SetDocumentOpen/IsDocumentOpen. HandlePause, HandleToggleInventory, and HandleInteract have bIsDocumentOpen guards. DocumentReaderWidget calls SetDocumentOpen on show/close.
  </verify>
  <done>
    Controller blocks inventory, pause, and interaction while a document is open. DocumentReaderWidget self-manages the bIsDocumentOpen state on the controller via SetDocumentOpen(true) on show and SetDocumentOpen(false) on close. No input mode conflicts between document/inventory/pause.
  </done>
</task>

</tasks>

<verification>
1. Full project build succeeds with zero errors
2. ReadableActor OnInteract creates a DocumentReaderWidget and calls ShowDocument with title+content
3. SerenePlayerController has bIsDocumentOpen state with guards in HandlePause, HandleToggleInventory, HandleInteract
4. DocumentReaderWidget calls SetDocumentOpen(true) when opened, SetDocumentOpen(false) when closed
5. Esc during document reading is consumed by the widget (NativeOnKeyDown), pause menu does not open
6. Tab during document reading is blocked by HandleToggleInventory guard
</verification>

<success_criteria>
- ReadableActor interaction shows a full-screen document instead of just logging
- No input mode conflicts: document/inventory/pause are mutually exclusive
- Widget self-manages controller state (no manual wiring needed per-actor)
</success_criteria>

<output>
After completion, create `.planning/phases/08-demo-polish/08-03-SUMMARY.md`
</output>
