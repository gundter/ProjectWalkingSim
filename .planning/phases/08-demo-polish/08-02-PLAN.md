---
phase: 08-demo-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Source/ProjectWalkingSim/Public/Player/HUD/DocumentReaderWidget.h
  - Source/ProjectWalkingSim/Private/Player/HUD/DocumentReaderWidget.cpp
  - Source/ProjectWalkingSim/Public/Interaction/InspectableActor.h
  - Source/ProjectWalkingSim/Private/Interaction/InspectableActor.cpp
autonomous: true

must_haves:
  truths:
    - "A full-screen widget can display a document title and multi-line content text"
    - "Player can close the document reader with E or Esc key press"
    - "Input mode switches to UI-only while document is open, back to game-only on close"
    - "An inspectable actor shows a full-screen overlay with an image and description text on interaction"
    - "Inspectable actor plays an optional monologue on first inspection only"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Player/HUD/DocumentReaderWidget.h"
      provides: "Full-screen readable document UI widget"
      contains: "UDocumentReaderWidget"
    - path: "Source/ProjectWalkingSim/Private/Player/HUD/DocumentReaderWidget.cpp"
      provides: "ShowDocument, CloseDocument, NativeOnKeyDown implementation"
      contains: "ShowDocument"
    - path: "Source/ProjectWalkingSim/Public/Interaction/InspectableActor.h"
      provides: "Story object examination actor (photos, toys, clues)"
      contains: "AInspectableActor"
    - path: "Source/ProjectWalkingSim/Private/Interaction/InspectableActor.cpp"
      provides: "OnInteract opens inspection overlay, optional one-time monologue"
      contains: "OnInteract_Implementation"
  key_links:
    - from: "DocumentReaderWidget.cpp"
      to: "FInputModeUIOnly / FInputModeGameOnly"
      via: "Input mode switch on show/close"
      pattern: "SetInputMode"
    - from: "DocumentReaderWidget.cpp"
      to: "NativeOnKeyDown"
      via: "E or Esc key closes document"
      pattern: "NativeOnKeyDown"
    - from: "InspectableActor.cpp"
      to: "UGameplayStatics::PlaySound2D"
      via: "Optional one-shot monologue on first inspect"
      pattern: "PlaySound2D.*InspectionMonologue"
---

<objective>
Create the storytelling UI system: DocumentReaderWidget for full-screen readable notes/letters, and InspectableActor for examining story objects (photographs, toys, clues). These are the primary vehicles for environmental storytelling (DEMO-03).

Purpose: ReadableActor already exists with ReadableTitle/ReadableContent fields but only logs on interaction. DocumentReaderWidget provides the actual display UI. InspectableActor adds a new interactable type for visual story objects (photographs, bloodstains, child's toy) that show a full-screen image with description text.

Output: Two new C++ classes (DocumentReaderWidget, InspectableActor). Project compiles cleanly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-demo-polish/08-RESEARCH.md

@Source/ProjectWalkingSim/Public/Interaction/InteractableBase.h
@Source/ProjectWalkingSim/Public/Interaction/ReadableActor.h
@Source/ProjectWalkingSim/Private/Interaction/ReadableActor.cpp
@Source/ProjectWalkingSim/Public/Player/HUD/PauseMenuWidget.h
@Source/ProjectWalkingSim/Public/Player/HUD/GameOverWidget.h
@Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: DocumentReaderWidget with full-screen text display and keyboard close</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/HUD/DocumentReaderWidget.h
    Source/ProjectWalkingSim/Private/Player/HUD/DocumentReaderWidget.cpp
  </files>
  <action>
    Create UDocumentReaderWidget : public UUserWidget following the PauseMenuWidget/GameOverWidget pattern (standalone viewport widget, NOT a BindWidget child of SereneHUDWidget).

    Header (DocumentReaderWidget.h):
    - Forward declare UTextBlock, UImage
    - DECLARE_DYNAMIC_MULTICAST_DELEGATE(FOnDocumentClosed) -- declared BEFORE the UCLASS
    - UPROPERTY(BlueprintAssignable, Category="UI") FOnDocumentClosed OnDocumentClosed
    - UFUNCTION(BlueprintCallable, Category="UI") void ShowDocument(const FText& Title, const FText& Content)
    - UFUNCTION(BlueprintCallable, Category="UI") void CloseDocument()
    - UFUNCTION(BlueprintCallable, Category="UI") void ShowInspection(const FText& Description, UTexture2D* Image)
    - Override: virtual FReply NativeOnKeyDown(const FGeometry& InGeometry, const FKeyEvent& InKeyEvent) override
    - UPROPERTY(meta=(BindWidget)) TObjectPtr of UTextBlock TitleText -- document title (can be hidden for inspection mode)
    - UPROPERTY(meta=(BindWidget)) TObjectPtr of UTextBlock ContentText -- document body text or inspection description
    - UPROPERTY(meta=(BindWidget)) TObjectPtr of UImage InspectionImage -- for inspection mode (hidden during document read)
    - bool bIsShowingDocument = false (private state guard)

    Implementation (DocumentReaderWidget.cpp):
    - ShowDocument(Title, Content):
      1. Set TitleText->SetText(Title), ContentText->SetText(Content)
      2. TitleText->SetVisibility(ESlateVisibility::SelfHitTestInvisible) -- visible for documents
      3. InspectionImage->SetVisibility(ESlateVisibility::Collapsed) -- hidden for documents
      4. bIsShowingDocument = true
      5. Get APlayerController via GetOwningPlayer()
      6. Set FInputModeUIOnly, SetWidgetToFocus(TakeWidget()), PC->SetInputMode(...)
      7. Do NOT show mouse cursor (keyboard-driven: E/Esc to close)
      8. SetKeyboardFocus() on the widget for NativeOnKeyDown

    - ShowInspection(Description, Image):
      1. Set TitleText->SetVisibility(ESlateVisibility::Collapsed) -- no title for inspections
      2. ContentText->SetText(Description)
      3. If Image is valid: InspectionImage->SetBrushFromTexture(Image), InspectionImage->SetVisibility(ESlateVisibility::SelfHitTestInvisible)
      4. Else: InspectionImage->SetVisibility(ESlateVisibility::Collapsed)
      5. bIsShowingDocument = true
      6. Same input mode switch as ShowDocument

    - CloseDocument():
      1. bIsShowingDocument = false
      2. RemoveFromParent()
      3. Restore FInputModeGameOnly via GetOwningPlayer()
      4. OnDocumentClosed.Broadcast()

    - NativeOnKeyDown: check InKeyEvent.GetKey() == EKeys::E || EKeys::Escape. If so, call CloseDocument(), return FReply::Handled(). Otherwise return Super::NativeOnKeyDown(...) for pass-through.

    IMPORTANT: This widget is CREATED by the actors that open it (ReadableActor, InspectableActor) using CreateWidget on the player controller, then AddToViewport(50). It is NOT pre-created by the controller. Each actor creates a fresh instance and it removes itself on close. This avoids stale state.

    IMPORTANT: Do NOT include guards for inventory/pause while document is open. That logic will be handled in Plan 03's controller wiring if needed. Keep this widget self-contained.

    Include: "Components/TextBlock.h", "Components/Image.h", "Blueprint/UserWidget.h", "Engine/Texture2D.h"
    Use copyright header and LogSerene logging.
  </action>
  <verify>
    Build succeeds: run UBT build command. No errors related to DocumentReaderWidget.
  </verify>
  <done>
    DocumentReaderWidget.h/.cpp exist and compile. ShowDocument() displays title+content, ShowInspection() displays image+description, CloseDocument() restores game input. NativeOnKeyDown handles E/Esc to close. Widget manages its own input mode lifecycle.
  </done>
</task>

<task type="auto">
  <name>Task 2: InspectableActor for story object examination</name>
  <files>
    Source/ProjectWalkingSim/Public/Interaction/InspectableActor.h
    Source/ProjectWalkingSim/Private/Interaction/InspectableActor.cpp
  </files>
  <action>
    Create AInspectableActor : public AInteractableBase with:

    Header (InspectableActor.h):
    - Include "Interaction/InteractableBase.h"
    - Forward declare UDocumentReaderWidget, UTexture2D
    - UPROPERTY(EditAnywhere, Category="Inspectable") TSoftObjectPtr of UTexture2D InspectionImage -- full-screen image (TSoftObjectPtr for async-loadable textures per project convention)
    - UPROPERTY(EditAnywhere, Category="Inspectable", meta=(MultiLine=true)) FText InspectionText -- description text
    - UPROPERTY(EditAnywhere, Category="Inspectable") TObjectPtr of USoundBase InspectionMonologue -- optional detective monologue on first inspect
    - UPROPERTY(EditDefaultsOnly, Category="Inspectable") TSubclassOf of UDocumentReaderWidget DocumentReaderWidgetClass -- widget Blueprint class
    - bool bHasBeenInspected = false (private, resets on load per research decision)
    - virtual void OnInteract_Implementation(AActor* Interactor) override

    Implementation (InspectableActor.cpp):
    - Constructor: InteractionText = NSLOCTEXT("Interaction", "Inspect", "Inspect"), InteractionTag = SereneTags::TAG_Interaction_Inspectable
    - OnInteract_Implementation:
      1. Get APlayerController from Interactor (Cast APawn -> GetController -> Cast APlayerController). Guard nullptr.
      2. If InspectionImage is not null (use !InspectionImage.IsNull()), load synchronously: UTexture2D* LoadedTexture = InspectionImage.LoadSynchronous()
      3. Create UDocumentReaderWidget instance: CreateWidget of UDocumentReaderWidget(PC, DocumentReaderWidgetClass). Guard nullptr and DocumentReaderWidgetClass.
      4. Widget->AddToViewport(50)
      5. Widget->ShowInspection(InspectionText, LoadedTexture)
      6. If InspectionMonologue && !bHasBeenInspected: UGameplayStatics::PlaySound2D(this, InspectionMonologue)
      7. bHasBeenInspected = true
      8. Log: UE_LOG(LogSerene, Log, TEXT("AInspectableActor::OnInteract - Inspecting: %s"), *GetName())

    Include: "Tags/SereneTags.h", "Core/SereneLogChannels.h", "Player/HUD/DocumentReaderWidget.h", "Kismet/GameplayStatics.h", "Engine/Texture2D.h"

    IMPORTANT: Use !InspectionImage.IsNull() to check if a soft pointer path is set (not IsValid() which checks if loaded). This follows the project convention from Phase 2 (InventorySlotWidget).

    Copyright header and LogSerene logging.
  </action>
  <verify>
    Build succeeds: run UBT build command. No errors related to InspectableActor.
  </verify>
  <done>
    InspectableActor.h/.cpp exist and compile. On interaction, it creates a DocumentReaderWidget, loads the inspection image via TSoftObjectPtr, shows the inspection overlay, and plays a one-time monologue. Interaction text is "Inspect", tag is TAG_Interaction_Inspectable.
  </done>
</task>

</tasks>

<verification>
1. Full project build succeeds with zero errors
2. DocumentReaderWidget has: ShowDocument(), ShowInspection(), CloseDocument(), NativeOnKeyDown with E/Esc handling, BindWidget members (TitleText, ContentText, InspectionImage), FOnDocumentClosed delegate
3. InspectableActor has: TSoftObjectPtr InspectionImage, InspectionText, InspectionMonologue, DocumentReaderWidgetClass, bHasBeenInspected one-shot guard
4. InspectableActor creates widget on interaction and calls ShowInspection
5. All files have // Copyright Null Lantern. header
6. All logging uses UE_LOG(LogSerene, ...)
</verification>

<success_criteria>
- Project compiles cleanly with the 4 new source files
- DocumentReaderWidget is a self-contained viewport widget that manages its own input mode
- InspectableActor is ready for level placement with per-instance image, text, and optional monologue
- Widget follows the standalone pattern (like PauseMenuWidget/GameOverWidget), NOT BindWidget child of SereneHUDWidget
</success_criteria>

<output>
After completion, create `.planning/phases/08-demo-polish/08-02-SUMMARY.md`
</output>
