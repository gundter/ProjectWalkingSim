---
phase: 03-hiding-system
plan: 06
type: execute
wave: 4
depends_on: ["03-05"]
files_modified:
  - Content/Hiding/DA_HidingSpot_Locker.uasset
  - Content/Hiding/DA_HidingSpot_Closet.uasset
  - Content/Hiding/DA_HidingSpot_UnderBed.uasset
  - Content/Input/Actions/IA_ExitHiding.uasset
  - Content/Input/Mappings/IMC_Hiding.uasset
  - Content/Blueprints/Game/BP_SereneCharacter.uasset
  - Content/Blueprints/Game/BP_SerenePlayerController.uasset
autonomous: false

must_haves:
  truths:
    - "Three HidingSpotDataAsset instances exist (Locker, Closet, UnderBed) with distinct camera limits and interaction text"
    - "IA_ExitHiding input action exists, mapped to F key in IMC_Hiding"
    - "IMC_Hiding contains Look + ExitHiding mappings only"
    - "BP_SereneCharacter has HidingComponent with DefaultMappingContext and HidingMappingContext assigned"
    - "Player can enter a hiding spot via F key and exit via F key in PIE"
  artifacts:
    - path: "Content/Hiding/DA_HidingSpot_Locker.uasset"
      provides: "Locker hiding spot data: tight yaw limits, 'Hide in Locker' text"
    - path: "Content/Hiding/DA_HidingSpot_Closet.uasset"
      provides: "Closet hiding spot data: medium yaw limits, 'Hide in Closet' text"
    - path: "Content/Hiding/DA_HidingSpot_UnderBed.uasset"
      provides: "Under-bed hiding spot data: wide yaw limits, 'Hide Under Bed' text"
    - path: "Content/Input/Actions/IA_ExitHiding.uasset"
      provides: "Bool input action for exiting hiding"
    - path: "Content/Input/Mappings/IMC_Hiding.uasset"
      provides: "Input mapping context active while hiding (Look + ExitHiding)"
  key_links:
    - from: "BP_SereneCharacter"
      to: "HidingComponent"
      via: "DefaultMappingContext and HidingMappingContext property assignment"
      pattern: "IMC_Hiding|IMC_Default"
---

<objective>
Create all editor assets needed for the hiding system: data assets for three hiding spot types, input action for exit, hiding-specific input mapping context, and wire up Blueprint defaults. Verify the full hiding flow in PIE.

Purpose: Without editor assets, the C++ code cannot function -- data assets provide configuration, input assets enable the control scheme. This plan bridges C++ to playable.
Output: Fully configured editor assets. Hiding system testable in PIE.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-hiding-system/03-RESEARCH.md
@.planning/phases/03-hiding-system/03-04-SUMMARY.md
@.planning/phases/03-hiding-system/03-05-SUMMARY.md

@Source/ProjectWalkingSim/Public/Hiding/HidingSpotDataAsset.h
@Source/ProjectWalkingSim/Public/Hiding/HidingComponent.h
@Source/ProjectWalkingSim/Public/Hiding/HidingSpotActor.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data assets, input assets, and Blueprint configuration via Python editor scripting</name>
  <files>
    Content/Hiding/DA_HidingSpot_Locker.uasset
    Content/Hiding/DA_HidingSpot_Closet.uasset
    Content/Hiding/DA_HidingSpot_UnderBed.uasset
    Content/Input/Actions/IA_ExitHiding.uasset
    Content/Input/Mappings/IMC_Hiding.uasset
  </files>
  <action>
    Use the UE5 Python editor scripting API (PythonScriptPlugin, already enabled in project) to create assets programmatically. This follows the established pattern from Phase 1 Plan 06 and Phase 2 Plan 06.

    **Step 1: Create the three HidingSpotDataAsset instances.**

    Use `unreal.EditorAssetLibrary` and `unreal.AssetToolsHelpers.get_asset_tools()`.

    For data assets, use `asset_tools.create_asset(asset_name, package_path, unreal.HidingSpotDataAsset, unreal.DataAssetFactory())`.

    NOTE: UHidingSpotDataAsset must be Blueprintable or at least have a UClass registered. Since it's a UDataAsset subclass with UCLASS(), it should be accessible. If `unreal.HidingSpotDataAsset` is not available in Python (similar to Phase 1-06 discovery where custom classes needed Blueprintable), use the generic approach: create via `unreal.DataAssetFactory()` and set the generated class. Actually, DataAssetFactory may not directly create subclassed data assets. Alternative: create them manually in the editor.

    **FALLBACK APPROACH:** If Python API cannot create UHidingSpotDataAsset instances (likely, since custom UCLASS without Blueprintable may not be accessible), document the manual creation steps clearly:

    1. In Content Browser, right-click -> Miscellaneous -> Data Asset
    2. Select UHidingSpotDataAsset as the parent class
    3. Name: DA_HidingSpot_Locker, save to Content/Hiding/
    4. Set properties:

    **DA_HidingSpot_Locker:**
    - InteractionText: "Hide in Locker"
    - ExitText: "Exit Locker"
    - CameraBlendInTime: 0.5
    - CameraBlendOutTime: 0.3
    - ViewPitchMin: -20.0
    - ViewPitchMax: 15.0
    - ViewYawMin: -35.0
    - ViewYawMax: 35.0
    - HidingVisibilityReduction: 0.6
    - SpotTypeTag: HidingSpot.Locker
    - EntryMontage: None (no animation assets yet)
    - ExitMontage: None
    - PeekOverlayMaterial: None (created in demo polish phase or skipped for now)

    **DA_HidingSpot_Closet:**
    - InteractionText: "Hide in Closet"
    - ExitText: "Exit Closet"
    - CameraBlendInTime: 0.6
    - CameraBlendOutTime: 0.4
    - ViewPitchMin: -25.0
    - ViewPitchMax: 20.0
    - ViewYawMin: -15.0
    - ViewYawMax: 15.0
    - HidingVisibilityReduction: 0.55
    - SpotTypeTag: HidingSpot.Closet

    **DA_HidingSpot_UnderBed:**
    - InteractionText: "Hide Under Bed"
    - ExitText: "Crawl Out"
    - CameraBlendInTime: 0.8
    - CameraBlendOutTime: 0.5
    - ViewPitchMin: -10.0
    - ViewPitchMax: 5.0
    - ViewYawMin: -60.0
    - ViewYawMax: 60.0
    - HidingVisibilityReduction: 0.5
    - SpotTypeTag: HidingSpot.UnderBed

    **Step 2: Create IA_ExitHiding input action.**

    Try Python first (following Phase 1-06 pattern with InputAction_Factory):
    ```python
    import unreal

    asset_tools = unreal.AssetToolsHelpers.get_asset_tools()
    factory = unreal.InputAction_Factory()

    # Create IA_ExitHiding
    ia_exit = asset_tools.create_asset("IA_ExitHiding", "/Game/Input/Actions", unreal.InputAction, factory)
    ia_exit.set_editor_property("value_type", unreal.InputActionValueType.BOOLEAN)
    unreal.EditorAssetLibrary.save_asset("/Game/Input/Actions/IA_ExitHiding")
    ```

    If Python works for IA but not for data assets, create the IA via Python and the data assets manually.

    **Step 3: Create IMC_Hiding input mapping context.**

    ```python
    imc_factory = unreal.InputMappingContext_Factory()
    imc_hiding = asset_tools.create_asset("IMC_Hiding", "/Game/Input/Mappings", unreal.InputMappingContext, imc_factory)

    # Map F key to ExitHiding
    ia_exit = unreal.EditorAssetLibrary.load_asset("/Game/Input/Actions/IA_ExitHiding")
    mapping_exit = imc_hiding.map_key(ia_exit, unreal.Key())
    # Set key to F
    mapping_exit.key = unreal.Key()
    mapping_exit.key.import_text("F")

    # Map Mouse XY to Look (reuse existing IA_Look)
    ia_look = unreal.EditorAssetLibrary.load_asset("/Game/Input/Actions/IA_Look")
    if ia_look:
        mapping_look = imc_hiding.map_key(ia_look, unreal.Key())
        mapping_look.key.import_text("Mouse2D")

    unreal.EditorAssetLibrary.save_asset("/Game/Input/Mappings/IMC_Hiding")
    ```

    NOTE: The Look action mapping in the hiding IMC should mirror the default Look mapping (Mouse2D with sensitivity modifiers). Copy the exact structure from the existing IMC_Default's Look mapping.

    **Step 4: Update Blueprint defaults.**

    Open BP_SereneCharacter in the editor (or via Python if accessible):
    - In the Details panel for HidingComponent:
      - Set DefaultMappingContext to IMC_Default (the existing default IMC)
      - Set HidingMappingContext to IMC_Hiding
      - Set ExitHidingAction to IA_ExitHiding

    If not accessible via Python, document these steps as manual Blueprint configuration:
    1. Open Content/Blueprints/Game/BP_SereneCharacter
    2. Select the HidingComponent in the Components panel
    3. In Details: set DefaultMappingContext = IMC_Default
    4. Set HidingMappingContext = IMC_Hiding
    5. Set ExitHidingAction = IA_ExitHiding
    6. Compile and save

    **Step 5: Place a test hiding spot in TestMap.**

    For PIE verification:
    1. Place an AHidingSpotActor in TestMap
    2. Assign DA_HidingSpot_Locker as SpotData
    3. Assign a cube mesh (or any static mesh) as SpotMesh so the interaction trace can hit it
    4. Position HidingCamera inside/behind the mesh where the player would view from
    5. Save the map
  </action>
  <verify>
    In the Unreal Editor:
    - Content/Hiding/ contains three DA_ assets
    - Content/Input/Actions/IA_ExitHiding exists
    - Content/Input/Mappings/IMC_Hiding exists with F and Mouse2D mappings
    - BP_SereneCharacter has HidingComponent with all three input references assigned
    - TestMap has at least one AHidingSpotActor placed
  </verify>
  <done>
    All editor assets created and configured. Blueprint defaults wired. Test hiding spot placed in level.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete hiding system: HidingComponent state machine, HidingSpotActor, VisibilityScoreComponent, data assets, input wiring.

    The full flow:
    1. Player walks to hiding spot, sees "Hide in Locker" prompt
    2. Player presses F, camera blends to hiding camera, movement locked
    3. Player can look around within constrained pitch/yaw range
    4. Player presses F to exit, camera blends back, movement restored
    5. VisibilityScoreComponent continuously samples ambient light
  </what-built>
  <how-to-verify>
    1. Open TestMap in PIE (Play In Editor)
    2. Walk toward the placed hiding spot (cube/mesh with HidingSpotActor)
    3. Verify: "Hide in Locker" interaction prompt appears when looking at it
    4. Press F to enter hiding:
       - Camera should smoothly blend to the hiding camera position
       - Movement (WASD) should be disabled
       - Sprint/crouch should not work
    5. While hidden:
       - Mouse look should be constrained (cannot look far up/down or left/right)
       - The prompt text should change context (no longer showing "Hide in Locker")
    6. Press F to exit:
       - Camera should smoothly blend back to first-person view
       - Movement should be restored
       - Sprint, crouch, interaction all work again
    7. Open Output Log, filter "LogSerene":
       - Should see "Entering hiding spot" message
       - Should see "Now hidden in" message
       - Should see "Exited hiding spot, now Free" message
       - VisibilityScoreComponent should log its initialization
    8. Walk around in dark vs lit areas, check Output Log for visibility score changes (Verbose log level)
    9. Test edge cases:
       - Enter hiding and open inventory (Tab) - should work per CONTEXT.md
       - Try to interact with hiding spot while already inside (should be blocked)
       - Walk away from hiding spot and back - prompt should reappear
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the hiding flow</resume-signal>
</task>

</tasks>

<verification>
- All 3 HidingSpotDataAsset instances created with correct per-type values
- IMC_Hiding has Look (Mouse2D) and ExitHiding (F) mappings
- BP_SereneCharacter HidingComponent references are wired
- Full hide/exit cycle works in PIE: approach -> prompt -> F to enter -> constrained look -> F to exit
- VisibilityScoreComponent logs initialization in BeginPlay
- Inventory access works while hidden
- No camera jitter during hide transitions
</verification>

<success_criteria>
The hiding system is fully functional end-to-end in PIE. Player can enter and exit all three hiding spot types. Camera transitions are smooth. Look constraints work correctly regardless of hiding spot orientation. Movement is properly locked/unlocked. Visibility scoring is active.
</success_criteria>

<output>
After completion, create `.planning/phases/03-hiding-system/03-06-SUMMARY.md`
</output>
