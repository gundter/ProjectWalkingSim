---
phase: 03-hiding-system
plan: 05
type: execute
wave: 3
depends_on: ["03-02", "03-03", "03-04"]
files_modified:
  - Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
  - Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
  - Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
  - Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
autonomous: true

must_haves:
  truths:
    - "ASereneCharacter creates HidingComponent and VisibilityScoreComponent in constructor"
    - "ASereneCharacter::Tick skips camera offset aggregation when HidingComponent is not in Free state"
    - "HidingComponent and VisibilityScoreComponent are accessible as public getters on ASereneCharacter"
    - "Component initialization log message updated to include all 9 components"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Player/SereneCharacter.h"
      provides: "HidingComponent and VisibilityScoreComponent UPROPERTY declarations + getters"
      contains: "UHidingComponent"
    - path: "Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp"
      provides: "Constructor CreateDefaultSubobject for both new components, Tick hiding bypass"
  key_links:
    - from: "SereneCharacter.cpp Tick"
      to: "HidingComponent"
      via: "Early return when HidingComponent->GetHidingState() != EHidingState::Free"
      pattern: "GetHidingState.*EHidingState::Free"
    - from: "SereneCharacter constructor"
      to: "HidingComponent"
      via: "CreateDefaultSubobject<UHidingComponent>"
      pattern: "CreateDefaultSubobject.*UHidingComponent"
    - from: "SereneCharacter constructor"
      to: "VisibilityScoreComponent"
      via: "CreateDefaultSubobject<UVisibilityScoreComponent>"
      pattern: "CreateDefaultSubobject.*UVisibilityScoreComponent"
---

<objective>
Integrate HidingComponent and VisibilityScoreComponent into ASereneCharacter. Add the critical Tick bypass that prevents camera offset computation while the player is hiding (the camera is controlled by SetViewTargetWithBlend during hiding, not by the character's head bone tracking).

Purpose: Without character integration, the hiding and visibility systems have no home. The Tick bypass is the most critical integration point -- without it, the character's camera logic fights the hiding camera blend (Research Pitfall #1).
Output: ASereneCharacter with 9 components total (7 existing + HidingComponent + VisibilityScoreComponent), hiding-aware Tick.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-hiding-system/03-RESEARCH.md
@.planning/phases/03-hiding-system/03-01-SUMMARY.md
@.planning/phases/03-hiding-system/03-04-SUMMARY.md

@Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
@Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
@Source/ProjectWalkingSim/Public/Hiding/HidingComponent.h
@Source/ProjectWalkingSim/Public/Visibility/VisibilityScoreComponent.h
@Source/ProjectWalkingSim/Public/Hiding/HidingTypes.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HidingComponent and VisibilityScoreComponent to ASereneCharacter</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
    Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
  </files>
  <action>
    **SereneCharacter.h changes:**

    1. Add forward declarations at top (with existing forward decls):
       ```cpp
       class UHidingComponent;
       class UVisibilityScoreComponent;
       ```

    2. Add `#include "Hiding/HidingTypes.h"` -- needed for EHidingState in the Tick bypass check. Actually, only the .cpp needs EHidingState. Forward declare if possible, but EHidingState is a UENUM so it can't be forward declared. Include HidingTypes.h in the .cpp only, and forward declare UHidingComponent in the .h. Use a method call like `HidingComponent->GetHidingState()` in the .cpp which returns EHidingState.

    3. Add component UPROPERTY declarations in a new section after Phase 02 Components:
       ```cpp
       // --- Phase 03 Components ---

       /** Hiding state machine. Manages enter/exit, camera, look constraints. */
       UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components")
       TObjectPtr<UHidingComponent> HidingComponent;

       /** Ambient light sampling for visibility scoring. AI reads this in Phase 4. */
       UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components")
       TObjectPtr<UVisibilityScoreComponent> VisibilityScoreComponent;
       ```

    4. Update class docstring to mention 9 components total (add HidingComponent and VisibilityScoreComponent to the list, noting Phase 03).

    **SereneCharacter.cpp changes:**

    1. Add includes:
       ```cpp
       #include "Hiding/HidingComponent.h"
       #include "Hiding/HidingTypes.h"
       #include "Visibility/VisibilityScoreComponent.h"
       ```

    2. In constructor, after InventoryComponent creation:
       ```cpp
       // --- Phase 03 Components ---
       HidingComponent = CreateDefaultSubobject<UHidingComponent>(TEXT("HidingComponent"));
       VisibilityScoreComponent = CreateDefaultSubobject<UVisibilityScoreComponent>(TEXT("VisibilityScoreComponent"));
       ```

    3. **CRITICAL -- Tick bypass for hiding.** In Tick(), add an early-out check AFTER the null guard but BEFORE the crouch camera offset computation:
       ```cpp
       void ASereneCharacter::Tick(float DeltaTime)
       {
           Super::Tick(DeltaTime);

           if (!FirstPersonCamera || !GetMesh())
           {
               return;
           }

           // --- NEW: Skip camera updates while hiding ---
           // When hiding, the camera is controlled by SetViewTargetWithBlend
           // targeting the hiding spot's camera. Any camera offset computation
           // here would fight the engine's blend and cause jitter (Pitfall #1).
           if (HidingComponent && HidingComponent->GetHidingState() != EHidingState::Free)
           {
               return;
           }

           // --- Existing camera offset aggregation (unchanged) ---
           // Crouch camera offset...
           // HeadBob offset...
           // Lean offset...
           // Head bone world position + world offset...
           // Camera rotation with lean roll...
       }
       ```
       The existing camera code below the new check stays EXACTLY as is. Only the early return is added.

    4. Update BeginPlay component log to include all 9 components:
       ```cpp
       UE_LOG(LogSerene, Log, TEXT("ASereneCharacter::BeginPlay - Components: Stamina=%s, HeadBob=%s, Lean=%s, Interaction=%s, Footstep=%s, Inventory=%s, Hiding=%s, Visibility=%s"),
           StaminaComponent ? TEXT("OK") : TEXT("MISSING"),
           HeadBobComponent ? TEXT("OK") : TEXT("MISSING"),
           LeanComponent ? TEXT("OK") : TEXT("MISSING"),
           InteractionComponent ? TEXT("OK") : TEXT("MISSING"),
           FootstepComponent ? TEXT("OK") : TEXT("MISSING"),
           InventoryComponent ? TEXT("OK") : TEXT("MISSING"),
           HidingComponent ? TEXT("OK") : TEXT("MISSING"),
           VisibilityScoreComponent ? TEXT("OK") : TEXT("MISSING"));
       ```
       Note: That's 8 format args. UE_LOG max is typically fine for this count, but double-check. If needed, split into two log lines.

    **IMPORTANT: Do NOT modify any existing functionality.** The Tick camera code below the new check must remain identical. Movement methods (Start/StopSprint, Start/StopCrouching), SetupPlayerInputComponent, OnStaminaDepleted, PossessedBy -- all unchanged.
  </action>
  <verify>
    Build compiles. Verify:
    - SereneCharacter.h has HidingComponent and VisibilityScoreComponent UPROPERTY declarations
    - Constructor creates both via CreateDefaultSubobject
    - Tick has early return when HidingComponent->GetHidingState() != EHidingState::Free
    - All existing functionality (movement, crouch, sprint, camera offsets) works unchanged when NOT hiding
    - BeginPlay logs all 9 components (count: Stamina, HeadBob, Lean, Interaction, Footstep, Inventory, Hiding, Visibility = 8 components listed, plus the implicit camera = 9 total on the character)
  </verify>
  <done>
    ASereneCharacter creates HidingComponent and VisibilityScoreComponent. Tick skips camera logic when hiding. BeginPlay logs all components. Existing Phase 1 and Phase 2 behavior is preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire exit hiding input on SerenePlayerController</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
    Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
  </files>
  <action>
    The HidingComponent's ExitHidingAction input binding is done in HidingComponent::BeginPlay (it binds ExitHidingAction to ExitHidingSpot on the controller's EnhancedInputComponent). However, the HidingComponent needs to bind after the controller's input component is set up, and it accesses `PC->InputComponent`. This should work because the character's BeginPlay runs after PossessedBy, and the controller's input component is ready by then.

    **However**, there's a timing consideration: HidingComponent::BeginPlay calls `Cast<APlayerController>(Character->GetController())` -- the controller must already be possessing. Since ASereneCharacter::BeginPlay is called during possession flow (after PossessedBy), this should work. But add a safety check.

    **Actual change needed on SerenePlayerController:**

    The SerenePlayerController does NOT need changes for the exit input -- that's handled by HidingComponent's BeginPlay binding.

    BUT the controller DOES need awareness of hiding state for the interact input. Currently, HandleInteract calls InteractionComponent->TryInteract(). When the player is in a hiding spot and presses the interact key (F), TryInteract would fire if InteractionComponent tick is still enabled. Since HidingComponent disables InteractionComponent tick during hiding, TryInteract would find nothing and do nothing -- acceptable.

    **What IS needed:** The F key (interact) should trigger ExitHidingSpot when the player is hidden. Two approaches:
    1. Map F to ExitHidingAction in the HidingMappingContext
    2. Have HandleInteract check hiding state and call ExitHidingSpot

    Approach 1 is cleaner (data-driven), but requires the hiding IMC to have an F-key mapping.
    Approach 2 is simpler to implement now.

    **DECISION: Use approach 2.** Modify HandleInteract to check hiding state:

    In SerenePlayerController.cpp, modify HandleInteract:
    ```cpp
    void ASerenePlayerController::HandleInteract(const FInputActionValue& Value)
    {
        ASereneCharacter* Character = GetSereneCharacter();
        if (!Character) return;

        // If hiding, pressing interact exits the hiding spot
        UHidingComponent* HidingComp = Character->FindComponentByClass<UHidingComponent>();
        if (HidingComp && HidingComp->IsHiding())
        {
            HidingComp->ExitHidingSpot();
            return;
        }

        // Normal interaction
        if (UInteractionComponent* IC = Character->FindComponentByClass<UInteractionComponent>())
        {
            IC->TryInteract();
        }
    }
    ```

    **Also:** Disable inventory toggle while hiding. In HandleToggleInventory:
    ```cpp
    void ASerenePlayerController::HandleToggleInventory(const FInputActionValue& Value)
    {
        // CONTEXT.md says "Full inventory access while hidden" -- so keep this working.
        // Actually, re-read CONTEXT.md: "Full inventory access while hidden - player can open and use inventory normally"
        // So do NOT block inventory toggle while hiding. Leave unchanged.
    }
    ```
    Per CONTEXT.md, inventory is accessible while hiding -- no change needed here.

    **Add includes to SerenePlayerController.cpp:**
    ```cpp
    #include "Hiding/HidingComponent.h"
    ```

    **SerenePlayerController.h:** No changes needed (HidingComponent is found via FindComponentByClass, no header dependency).

    **NOTE:** Actually check if HandleInteract currently accesses InteractionComponent directly or via FindComponentByClass. Read the .cpp to see the current implementation pattern and follow it.
  </action>
  <verify>
    Build compiles. Verify:
    - HandleInteract checks HidingComponent state before normal interaction
    - When IsHiding() is true, pressing F calls ExitHidingSpot instead of TryInteract
    - Inventory toggle still works while hiding (not blocked)
  </verify>
  <done>
    SerenePlayerController routes F key to ExitHidingSpot when player is hiding. Normal interaction flow preserved when not hiding. Inventory access unaffected.
  </done>
</task>

</tasks>

<verification>
- Project compiles with zero errors
- ASereneCharacter has 9 components (7 prior + HidingComponent + VisibilityScoreComponent)
- Tick bypass prevents camera jitter during hiding
- F key exits hiding spot when hidden, interacts normally when not hidden
- Inventory toggle works while hiding (per CONTEXT.md)
- All Phase 1 + Phase 2 behavior preserved
</verification>

<success_criteria>
Full character integration complete. The hiding system is wired end-to-end: InteractionComponent traces -> HidingSpotActor::OnInteract -> HidingComponent::EnterHidingSpot -> state machine manages full flow -> F key exits -> back to Free. Camera, movement, input, and mesh visibility all managed correctly.
</success_criteria>

<output>
After completion, create `.planning/phases/03-hiding-system/03-05-SUMMARY.md`
</output>
