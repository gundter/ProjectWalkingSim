---
phase: 03-hiding-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Source/ProjectWalkingSim/Public/Interaction/HideableInterface.h
  - Source/ProjectWalkingSim/Private/Interaction/HideableInterface.cpp
  - Source/ProjectWalkingSim/Public/Hiding/HidingTypes.h
  - Source/ProjectWalkingSim/Private/Hiding/HidingTypes.cpp
  - Source/ProjectWalkingSim/Public/Hiding/HidingSpotDataAsset.h
  - Source/ProjectWalkingSim/Private/Hiding/HidingSpotDataAsset.cpp
  - Source/ProjectWalkingSim/Public/Tags/SereneTags.h
  - Source/ProjectWalkingSim/Private/Tags/SereneTags.cpp
autonomous: true

must_haves:
  truths:
    - "IHideable interface has methods for camera, data, occupancy, and discovery"
    - "HidingSpotDataAsset stores per-type config (montages, camera limits, blend times, peek material, interaction text)"
    - "EHidingState enum defines Free/Entering/Hidden/Exiting states"
    - "Gameplay tags exist for Player.Hiding, HidingSpot.Locker, HidingSpot.Closet, HidingSpot.UnderBed"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Hiding/HidingTypes.h"
      provides: "EHidingState enum, FHidingStateChanged delegate"
    - path: "Source/ProjectWalkingSim/Public/Hiding/HidingSpotDataAsset.h"
      provides: "UHidingSpotDataAsset with per-type configuration"
      contains: "UHidingSpotDataAsset"
    - path: "Source/ProjectWalkingSim/Public/Interaction/HideableInterface.h"
      provides: "Expanded IHideable with GetHidingCamera, GetSpotData, IsOccupied, MarkDiscovered, WasDiscovered"
    - path: "Source/ProjectWalkingSim/Public/Tags/SereneTags.h"
      provides: "TAG_Player_Hiding, TAG_HidingSpot_Locker, TAG_HidingSpot_Closet, TAG_HidingSpot_UnderBed, TAG_Interaction_HidingSpot"
  key_links:
    - from: "HidingSpotDataAsset.h"
      to: "HideableInterface.h"
      via: "GetSpotData returns UHidingSpotDataAsset*"
      pattern: "UHidingSpotDataAsset"
---

<objective>
Create the foundational types for the hiding system: expand the IHideable interface stub with full method set, define the EHidingState enum and delegate, create UHidingSpotDataAsset for per-type configuration, and register new gameplay tags.

Purpose: All hiding system classes depend on these shared types. Without the data asset, interface, and enum, nothing else can compile.
Output: Compilable foundation types that Plan 03 (HidingSpotActor) and Plan 04 (HidingComponent) will build on.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-hiding-system/03-RESEARCH.md

@Source/ProjectWalkingSim/Public/Interaction/HideableInterface.h
@Source/ProjectWalkingSim/Private/Interaction/HideableInterface.cpp
@Source/ProjectWalkingSim/Public/Tags/SereneTags.h
@Source/ProjectWalkingSim/Private/Tags/SereneTags.cpp
@Source/ProjectWalkingSim/ProjectWalkingSim.Build.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hiding types, data asset, and expanded IHideable interface</name>
  <files>
    Source/ProjectWalkingSim/Public/Hiding/HidingTypes.h
    Source/ProjectWalkingSim/Private/Hiding/HidingTypes.cpp
    Source/ProjectWalkingSim/Public/Hiding/HidingSpotDataAsset.h
    Source/ProjectWalkingSim/Private/Hiding/HidingSpotDataAsset.cpp
    Source/ProjectWalkingSim/Public/Interaction/HideableInterface.h
    Source/ProjectWalkingSim/Private/Interaction/HideableInterface.cpp
  </files>
  <action>
    Create `Source/ProjectWalkingSim/Public/Hiding/` and `Source/ProjectWalkingSim/Private/Hiding/` directories.

    **HidingTypes.h/.cpp:**
    - Define `EHidingState` enum (UENUM, BlueprintType): `Free`, `Entering`, `Hidden`, `Exiting`
    - Define `DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FOnHidingStateChanged, EHidingState, NewState);`
    - This is a small file -- types only, no logic.

    **HidingSpotDataAsset.h/.cpp:**
    - Create `UHidingSpotDataAsset : public UDataAsset`
    - Properties (all EditDefaultsOnly):
      - `UAnimMontage* EntryMontage` (soft reference via TSoftObjectPtr is fine, but regular pointer is simpler for data assets -- use regular TObjectPtr since data assets are always loaded)
      - `UAnimMontage* ExitMontage`
      - `float CameraBlendInTime = 0.5f` -- time to blend to hiding camera
      - `float CameraBlendOutTime = 0.3f` -- time to blend back to player camera
      - `float ViewPitchMin = -30.0f` -- min pitch while hidden (degrees)
      - `float ViewPitchMax = 30.0f` -- max pitch while hidden
      - `float ViewYawMin = -45.0f` -- min yaw offset from spot forward (degrees)
      - `float ViewYawMax = 45.0f` -- max yaw offset from spot forward
      - `UMaterialInterface* PeekOverlayMaterial` -- post-process material for peek effect (locker slats, closet crack, under-bed framing)
      - `FText InteractionText` -- "Hide in Locker", "Hide in Closet", "Hide Under Bed"
      - `FText ExitText` -- "Exit Locker", "Exit Closet", "Crawl Out"
      - `FGameplayTag SpotTypeTag` -- tag identifying the type (HidingSpot.Locker, etc.)
      - `float HidingVisibilityReduction = 0.5f` -- how much to reduce visibility score while in this spot
    - Constructor sets default values for InteractionText to "Hide" and ExitText to "Exit".

    **IHideable expansion (HideableInterface.h):**
    - Keep existing 3 methods: CanHide, OnEnterHiding, OnExitHiding (do NOT break existing signatures).
    - Forward declare `class UCameraComponent;` and `class UHidingSpotDataAsset;` at top.
    - Add new UFUNCTION(BlueprintNativeEvent, BlueprintCallable) methods:
      - `UCameraComponent* GetHidingCamera() const;` -- returns the camera for this hiding spot
      - `UHidingSpotDataAsset* GetSpotData() const;` -- returns the data asset
      - `bool IsOccupied() const;` -- whether someone is already hiding here
      - `void MarkDiscovered();` -- monster found player here (Phase 5 will call this)
      - `bool WasDiscovered() const;` -- check if monster found someone here before
    - Update the class docstring to remove "Stub interface" note.
    - HideableInterface.cpp remains minimal (just the include).

    **Important:** Include "Animation/AnimMontage.h" in HidingSpotDataAsset.h for UAnimMontage forward decl, or forward declare class UAnimMontage. Forward declaration is preferred to avoid heavy headers.
  </action>
  <verify>
    Build the project: open a Developer Command Prompt or use `UnrealBuildTool` to compile. Alternatively run the editor (which triggers compilation). All new files must compile without errors or warnings. Verify:
    - `EHidingState` enum has 4 values
    - `UHidingSpotDataAsset` has all 13 properties with EditDefaultsOnly
    - `IHideable` has 8 methods total (3 original + 5 new)
  </verify>
  <done>
    HidingTypes.h defines EHidingState enum and FOnHidingStateChanged delegate. HidingSpotDataAsset.h defines UHidingSpotDataAsset with all per-type configuration. IHideable has 8 BlueprintNativeEvent methods. All compile cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register hiding gameplay tags</name>
  <files>
    Source/ProjectWalkingSim/Public/Tags/SereneTags.h
    Source/ProjectWalkingSim/Private/Tags/SereneTags.cpp
  </files>
  <action>
    Add the following gameplay tag declarations to SereneTags.h inside the SereneTags namespace:

    ```cpp
    // Hiding states
    UE_DECLARE_GAMEPLAY_TAG_EXTERN(TAG_Player_Hiding);          // "Player.Hiding"

    // Hiding spot interaction
    UE_DECLARE_GAMEPLAY_TAG_EXTERN(TAG_Interaction_HidingSpot); // "Interaction.HidingSpot"

    // Hiding spot types
    UE_DECLARE_GAMEPLAY_TAG_EXTERN(TAG_HidingSpot_Locker);      // "HidingSpot.Locker"
    UE_DECLARE_GAMEPLAY_TAG_EXTERN(TAG_HidingSpot_Closet);      // "HidingSpot.Closet"
    UE_DECLARE_GAMEPLAY_TAG_EXTERN(TAG_HidingSpot_UnderBed);    // "HidingSpot.UnderBed"
    ```

    Add corresponding definitions in SereneTags.cpp:

    ```cpp
    UE_DEFINE_GAMEPLAY_TAG(TAG_Player_Hiding, "Player.Hiding");
    UE_DEFINE_GAMEPLAY_TAG(TAG_Interaction_HidingSpot, "Interaction.HidingSpot");
    UE_DEFINE_GAMEPLAY_TAG(TAG_HidingSpot_Locker, "HidingSpot.Locker");
    UE_DEFINE_GAMEPLAY_TAG(TAG_HidingSpot_Closet, "HidingSpot.Closet");
    UE_DEFINE_GAMEPLAY_TAG(TAG_HidingSpot_UnderBed, "HidingSpot.UnderBed");
    ```

    Place these in a new comment section: `// Hiding system` after the existing `// Item types` section.

    NOTE: The existing TAG_Player_InTransition tag is already declared and will be reused for Entering/Exiting states -- do NOT re-declare it.
  </action>
  <verify>
    Build compiles. Grep SereneTags.h for TAG_Player_Hiding, TAG_HidingSpot_Locker, TAG_HidingSpot_Closet, TAG_HidingSpot_UnderBed, TAG_Interaction_HidingSpot. All 5 must exist.
  </verify>
  <done>
    Five new gameplay tags registered: Player.Hiding, Interaction.HidingSpot, HidingSpot.Locker, HidingSpot.Closet, HidingSpot.UnderBed. Compile succeeds.
  </done>
</task>

</tasks>

<verification>
- Project compiles with zero errors
- `EHidingState` has exactly 4 values: Free, Entering, Hidden, Exiting
- `UHidingSpotDataAsset` has all 13 configuration properties
- `IHideable` interface has 8 BlueprintNativeEvent methods
- SereneTags namespace has 5 new tag declarations + definitions
- Existing code (Phase 1 + Phase 2) still compiles without modification
</verification>

<success_criteria>
All hiding foundation types compile cleanly. IHideable is expanded without breaking existing code. Tags are registered. Data asset is ready for editor instantiation.
</success_criteria>

<output>
After completion, create `.planning/phases/03-hiding-system/03-01-SUMMARY.md`
</output>
