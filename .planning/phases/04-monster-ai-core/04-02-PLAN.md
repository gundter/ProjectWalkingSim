---
phase: 04-monster-ai-core
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h
  - Source/ProjectWalkingSim/Private/AI/SuspicionComponent.cpp
  - Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
  - Source/ProjectWalkingSim/Private/AI/WendigoCharacter.cpp
autonomous: true

must_haves:
  truths:
    - "SuspicionComponent accumulates suspicion from visibility score input"
    - "SuspicionComponent decays suspicion over time when no stimulus"
    - "Alert level transitions fire delegate (Patrol->Suspicious->Alert)"
    - "WendigoCharacter is a tall pawn (260cm capsule) with slow walk speed"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h"
      provides: "Suspicion accumulation/decay, alert level management"
      exports: ["USuspicionComponent"]
      min_lines: 50
    - path: "Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h"
      provides: "Wendigo pawn with SuspicionComponent and PatrolRoute reference"
      exports: ["AWendigoCharacter"]
      min_lines: 30
  key_links:
    - from: "SuspicionComponent"
      to: "AITypes.h"
      via: "EAlertLevel enum and AI constants"
      pattern: "EAlertLevel"
    - from: "WendigoCharacter"
      to: "SuspicionComponent"
      via: "CreateDefaultSubobject in constructor"
      pattern: "CreateDefaultSubobject.*SuspicionComponent"
---

<objective>
Create the Wendigo pawn (AWendigoCharacter) and its suspicion tracking system (USuspicionComponent). The pawn is a tall character (8-9ft) with slow deliberate movement. The suspicion component implements the gradual detection model: accumulation scaled by player visibility, slow decay, and three alert level thresholds with delegate broadcasts.

Purpose: The Wendigo needs a physical presence in the world (character) and a brain for detection state (suspicion). These are the pawn-side systems that the AI controller (Plan 03) will drive.
Output: AWendigoCharacter.h/.cpp, USuspicionComponent.h/.cpp
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-monster-ai-core/04-RESEARCH.md
@.planning/phases/04-monster-ai-core/04-CONTEXT.md

@Source/ProjectWalkingSim/Public/AI/AITypes.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: SuspicionComponent</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h
    Source/ProjectWalkingSim/Private/AI/SuspicionComponent.cpp
  </files>
  <action>
    Create USuspicionComponent (UActorComponent) with:

    **Public API:**
    - ProcessSightStimulus(float PlayerVisibilityScore, float DeltaTime): Accumulates suspicion.
      - If PlayerVisibilityScore < VisibilityThreshold (0.3): no accumulation, return.
      - Normalize effective visibility: (score - threshold) / (1.0 - threshold) to get 0-1 range above threshold.
      - Suspicion gain = BaseSuspicionRate * EffectiveVisibility * DeltaTime.
      - Clamp CurrentSuspicion to [0.0, 1.0].
      - Call UpdateAlertLevel().
    - ProcessHearingStimulus(FVector StimulusLocation): Sets LastKnownStimulusLocation and adds a fixed hearing suspicion bump (e.g., 0.25).
    - DecaySuspicion(float DeltaTime): Reduces CurrentSuspicion by SuspicionDecayRate * DeltaTime. Call UpdateAlertLevel().
    - GetAlertLevel() const -> EAlertLevel.
    - GetCurrentSuspicion() const -> float.
    - GetLastKnownStimulusLocation() const -> FVector.
    - HasStimulusLocation() const -> bool.
    - ClearStimulusLocation(): Resets the stored stimulus location.
    - ResetSuspicion(): Resets to 0.0 and Patrol state.

    **Delegate:**
    - OnAlertLevelChanged (FOnAlertLevelChanged from AITypes.h) - broadcast when alert level changes.

    **UPROPERTY (EditAnywhere, tunable):**
    - VisibilityThreshold (0.3f)
    - BaseSuspicionRate (0.15f)
    - SuspicionDecayRate (0.065f)
    - SuspiciousThreshold (0.4f)
    - AlertThreshold (0.8f)
    - HearingSuspicionBump (0.25f)

    **Private:**
    - CurrentSuspicion (float, 0.0)
    - CurrentAlertLevel (EAlertLevel::Patrol)
    - LastKnownStimulusLocation (FVector)
    - bHasStimulusLocation (bool, false)
    - UpdateAlertLevel(): Compare thresholds, broadcast if level changes.

    Use defaults from AIConstants namespace but store as editable properties on the component for per-instance tuning.
    Log alert level transitions via UE_LOG(LogSerene, Log, ...).
  </action>
  <verify>Project compiles. USuspicionComponent can be instantiated. ProcessSightStimulus with visibility 0.8 over multiple seconds eventually transitions to Suspicious then Alert.</verify>
  <done>SuspicionComponent accumulates from sight/hearing, decays over time, transitions through 3 alert levels, broadcasts changes via delegate.</done>
</task>

<task type="auto">
  <name>Task 2: WendigoCharacter</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
    Source/ProjectWalkingSim/Private/AI/WendigoCharacter.cpp
  </files>
  <action>
    Create AWendigoCharacter (ACharacter) with:

    **Constructor:**
    - Capsule size: radius 45.0f, half-height 130.0f (total height ~260cm / ~8.5ft)
    - CharacterMovement defaults:
      - MaxWalkSpeed = AIConstants::WendigoWalkSpeed (150 cm/s)
      - bOrientRotationToMovement = true
      - RotationRate = FRotator(0.0, 120.0, 0.0)
    - AIControllerClass = AWendigoAIController::StaticClass() (forward declare, include in .cpp)
    - AutoPossessAI = EAutoPossessAI::PlacedInWorldOrSpawned
    - Create SuspicionComponent as default subobject
    - bUseControllerRotationYaw = false (let movement handle rotation)

    **Properties:**
    - UPROPERTY(VisibleAnywhere) TObjectPtr<USuspicionComponent> SuspicionComponent
    - UPROPERTY(EditInstanceOnly, BlueprintReadOnly, Category = "AI|Patrol") TObjectPtr<APatrolRouteActor> PatrolRoute
      (forward declare APatrolRouteActor; this is set per-instance in the level editor to link a Wendigo to its patrol route)

    **Public getters:**
    - GetSuspicionComponent() -> USuspicionComponent*
    - GetPatrolRoute() -> APatrolRouteActor*

    Do NOT add skeletal mesh assignment in C++ (Mannequin mesh will be assigned in the Blueprint subclass in Plan 07).
    Forward-declare AWendigoAIController and APatrolRouteActor. Include only in .cpp.
  </action>
  <verify>Project compiles. AWendigoCharacter can be subclassed in Blueprint. Capsule debug shows ~260cm tall.</verify>
  <done>AWendigoCharacter is a tall ACharacter with SuspicionComponent, PatrolRoute reference, slow walk speed, and auto-possession by AI controller.</done>
</task>

</tasks>

<verification>
- Project compiles with no errors or warnings
- USuspicionComponent has ProcessSightStimulus, ProcessHearingStimulus, DecaySuspicion, GetAlertLevel
- AWendigoCharacter has capsule half-height 130, MaxWalkSpeed 150, AutoPossessAI set
- SuspicionComponent is created as default subobject on WendigoCharacter
- OnAlertLevelChanged delegate declared and broadcast on transitions
</verification>

<success_criteria>
AWendigoCharacter is a 260cm tall pawn with SuspicionComponent, slow walk speed (150 cm/s), and PatrolRoute reference. SuspicionComponent implements gradual suspicion accumulation scaled by visibility score, slow decay (~15s), three alert level thresholds (0.4 Suspicious, 0.8 Alert), and delegate broadcasts on transitions.
</success_criteria>

<output>
After completion, create `.planning/phases/04-monster-ai-core/04-02-SUMMARY.md`
</output>
