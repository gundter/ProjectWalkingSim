---
phase: 04-monster-ai-core
plan: 04
type: execute
wave: 3
depends_on: [04-02, 04-03]
files_modified:
  - Source/ProjectWalkingSim/Public/AI/PatrolRouteActor.h
  - Source/ProjectWalkingSim/Private/AI/PatrolRouteActor.cpp
  - Source/ProjectWalkingSim/Public/AI/Tasks/STT_PatrolMoveToWaypoint.h
  - Source/ProjectWalkingSim/Private/AI/Tasks/STT_PatrolMoveToWaypoint.cpp
  - Source/ProjectWalkingSim/Public/AI/Tasks/STT_PatrolIdle.h
  - Source/ProjectWalkingSim/Private/AI/Tasks/STT_PatrolIdle.cpp
autonomous: true

must_haves:
  truths:
    - "PatrolRouteActor holds an array of waypoints placeable in the level editor"
    - "PatrolMoveToWaypoint task moves the Wendigo to the next waypoint and advances index"
    - "PatrolIdle task pauses the Wendigo for a configurable duration"
    - "Both tasks return Running while active and Succeeded when complete"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/AI/PatrolRouteActor.h"
      provides: "Waypoint container for patrol routes"
      exports: ["APatrolRouteActor"]
    - path: "Source/ProjectWalkingSim/Public/AI/Tasks/STT_PatrolMoveToWaypoint.h"
      provides: "State Tree task for moving to next patrol waypoint"
      exports: ["FSTT_PatrolMoveToWaypoint"]
      min_lines: 30
    - path: "Source/ProjectWalkingSim/Public/AI/Tasks/STT_PatrolIdle.h"
      provides: "State Tree task for patrol pause/scan behavior"
      exports: ["FSTT_PatrolIdle"]
      min_lines: 20
  key_links:
    - from: "STT_PatrolMoveToWaypoint"
      to: "AAIController::MoveToLocation"
      via: "EnterState calls MoveToLocation with waypoint position"
      pattern: "MoveToLocation"
    - from: "STT_PatrolMoveToWaypoint"
      to: "APatrolRouteActor"
      via: "Reads Waypoints array from pawn's PatrolRoute"
      pattern: "PatrolRoute.*Waypoints"
    - from: "STT_PatrolIdle"
      to: "SetFocalPoint"
      via: "Random look direction during idle"
      pattern: "SetFocal"
---

<objective>
Create the patrol route actor (level-placed waypoint container) and the two core patrol State Tree tasks: PatrolMoveToWaypoint (navigate to next waypoint) and PatrolIdle (pause and look around). These tasks are USTRUCT types inheriting FStateTreeTaskCommonBase, using external data handles to access the AI controller and pawn.

Purpose: Patrol is the Wendigo's default behavior. Players learn patrol patterns and time their movement accordingly. The slow, deliberate pace with pauses creates tension.
Output: APatrolRouteActor, FSTT_PatrolMoveToWaypoint, FSTT_PatrolIdle
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-monster-ai-core/04-RESEARCH.md
@.planning/phases/04-monster-ai-core/04-CONTEXT.md

@Source/ProjectWalkingSim/Public/AI/AITypes.h
@Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
@Source/ProjectWalkingSim/Public/AI/WendigoAIController.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: PatrolRouteActor</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/PatrolRouteActor.h
    Source/ProjectWalkingSim/Private/AI/PatrolRouteActor.cpp
  </files>
  <action>
    Create APatrolRouteActor (AActor) as a level-placed waypoint container:

    **Properties:**
    - UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Patrol") TArray<FVector> Waypoints
      - These are WORLD-SPACE positions. The designer places them via the level editor's Details panel.
    - UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Patrol") bool bLoopRoute = true
      - When true, after reaching the last waypoint, return to the first. When false, reverse direction (ping-pong).

    **Public API:**
    - GetWaypoint(int32 Index) const -> FVector: Returns Waypoints[Index]. Clamp to valid range.
    - GetNumWaypoints() const -> int32: Returns Waypoints.Num().
    - GetNextWaypointIndex(int32 CurrentIndex) const -> int32: Returns next index, handling loop/ping-pong.

    **Editor visualization (DrawDebugHelpers in Tick, editor-only):**
    - In constructor: PrimaryActorTick.bCanEverTick = true, PrimaryActorTick.bStartWithTickEnabled = true
    - Add a UBillboardComponent as RootComponent (standard for invisible placement actors)
    - In Tick, only if WITH_EDITOR and GetWorld()->IsEditorWorld():
      - Draw debug spheres at each waypoint (radius 25cm, green)
      - Draw debug lines connecting consecutive waypoints (green)
      - Draw debug line from last to first if bLoopRoute (dashed/different color)
    - This visualization helps designers see routes in the editor viewport

    **IMPORTANT:** Waypoints are edited as FVector array in the Details panel. This is the simplest approach for fixed indoor routes. Designers can also use "Make Edit Widget" on the Waypoints property for visual dragging.
    Add `meta=(MakeEditWidget)` to the Waypoints UPROPERTY for visual waypoint editing in viewport.
  </action>
  <verify>Project compiles. APatrolRouteActor can be placed in a level. Waypoints are editable in Details panel with viewport widget handles.</verify>
  <done>APatrolRouteActor holds waypoints with loop/ping-pong, provides index management, and shows debug visualization in editor.</done>
</task>

<task type="auto">
  <name>Task 2: Patrol State Tree tasks</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/Tasks/STT_PatrolMoveToWaypoint.h
    Source/ProjectWalkingSim/Private/AI/Tasks/STT_PatrolMoveToWaypoint.cpp
    Source/ProjectWalkingSim/Public/AI/Tasks/STT_PatrolIdle.h
    Source/ProjectWalkingSim/Private/AI/Tasks/STT_PatrolIdle.cpp
  </files>
  <action>
    **STT_PatrolMoveToWaypoint:**

    Instance data struct (FSTT_PatrolMoveToWaypointInstanceData):
    - int32 CurrentWaypointIndex = 0 (UPROPERTY EditAnywhere)
    - bool bMoveRequestActive = false (not UPROPERTY, runtime state)
    - EPathFollowingRequestResult::Type MoveRequestResult (track if move was accepted)

    Task struct (FSTT_PatrolMoveToWaypoint : FStateTreeTaskCommonBase):
    - USTRUCT(meta=(DisplayName="Patrol: Move To Waypoint"))
    - using FInstanceDataType = FSTT_PatrolMoveToWaypointInstanceData
    - GetInstanceDataType() returns FInstanceDataType::StaticStruct()
    - TStateTreeExternalDataHandle<AAIController> ControllerHandle
    - UPROPERTY(EditAnywhere) float AcceptanceRadius = 50.0f

    - Link(): Linker.LinkExternalData(ControllerHandle); return true;

    - EnterState():
      - Get controller via Context.GetExternalData(ControllerHandle)
      - Get pawn, cast to AWendigoCharacter
      - Get PatrolRoute from pawn. If null or no waypoints, return Failed.
      - Get target waypoint position from PatrolRoute->GetWaypoint(InstanceData.CurrentWaypointIndex)
      - Call Controller.MoveToLocation(TargetLocation, AcceptanceRadius)
        - Do NOT set bLockAILogic (prevents State Tree transitions)
      - Set bMoveRequestActive = true
      - Return Running

    - Tick():
      - Get controller. Check GetMoveStatus():
        - If EPathFollowingStatus::Moving: return Running (still navigating)
        - If reached/idle (not moving): advance waypoint index via PatrolRoute->GetNextWaypointIndex()
          - Store new index in InstanceData.CurrentWaypointIndex
          - Return Succeeded (task complete, State Tree transitions to idle or next move)
      - Return Running

    - ExitState():
      - If bMoveRequestActive, call Controller.StopMovement() to clean up
      - Set bMoveRequestActive = false

    **STT_PatrolIdle:**

    Instance data struct (FSTT_PatrolIdleInstanceData):
    - float ElapsedTime = 0.0f (runtime)
    - float TargetDuration = 0.0f (set randomly in EnterState)
    - bool bHasLookedAround = false (runtime)

    Task struct (FSTT_PatrolIdle : FStateTreeTaskCommonBase):
    - USTRUCT(meta=(DisplayName="Patrol: Idle / Look Around"))
    - TStateTreeExternalDataHandle<AAIController> ControllerHandle
    - UPROPERTY(EditAnywhere) float MinIdleDuration = 3.0f
    - UPROPERTY(EditAnywhere) float MaxIdleDuration = 6.0f

    - Link(): Linker.LinkExternalData(ControllerHandle); return true;

    - EnterState():
      - Randomize TargetDuration between Min and Max
      - Reset ElapsedTime to 0
      - Set bHasLookedAround to false
      - Clear AI focus: Controller.ClearFocus(EAIFocusPriority::Gameplay)
      - Return Running

    - Tick():
      - ElapsedTime += DeltaTime
      - At ~40% through duration (if !bHasLookedAround):
        - Pick a random direction offset (yaw +/- 60 degrees from current rotation)
        - Set focal point in that direction: Controller.SetFocalPoint(Pawn->GetActorLocation() + RandomDirection * 500.0f)
        - bHasLookedAround = true
      - At ~75% through duration:
        - Clear focus to return to forward-facing
      - If ElapsedTime >= TargetDuration: return Succeeded
      - Return Running

    - ExitState():
      - Controller.ClearFocus(EAIFocusPriority::Gameplay)

    **Include paths to investigate (exact headers may vary, check engine source if compile errors):**
    - "StateTreeTaskBase.h" for FStateTreeTaskCommonBase
    - "StateTreeExecutionContext.h" for FStateTreeExecutionContext
    - "StateTreeLinker.h" for FStateTreeLinker and TStateTreeExternalDataHandle
    - "AIController.h" for AAIController
    - "Navigation/PathFollowingComponent.h" for EPathFollowingStatus

    **CRITICAL anti-patterns to avoid:**
    - Do NOT return Succeeded/Failed from EnterState for long-running tasks (return Running)
    - Do NOT set bLockAILogic on MoveToLocation (it prevents State Tree transitions)
    - Do NOT use bShouldStateChangeOnReselect = true (causes parent re-entry)
  </action>
  <verify>Project compiles. Both task structs register with State Tree editor. FSTT_PatrolMoveToWaypoint appears as "Patrol: Move To Waypoint" in State Tree task list. FSTT_PatrolIdle appears as "Patrol: Idle / Look Around".</verify>
  <done>Two State Tree tasks compile and are available in the State Tree editor. PatrolMoveToWaypoint navigates to waypoints using MoveToLocation. PatrolIdle pauses with random duration and look-around behavior.</done>
</task>

</tasks>

<verification>
- Project compiles with no errors
- APatrolRouteActor has Waypoints array with MakeEditWidget, debug visualization
- FSTT_PatrolMoveToWaypoint uses MoveToLocation (no bLockAILogic), returns Running during movement, Succeeded on arrival
- FSTT_PatrolIdle randomizes pause duration (3-6s), includes look-around behavior, returns Succeeded when complete
- Both tasks use TStateTreeExternalDataHandle<AAIController> and override Link/EnterState/Tick/ExitState
- Neither task returns Succeeded from EnterState
</verification>

<success_criteria>
PatrolRouteActor provides editable waypoint arrays with editor visualization. Two State Tree tasks implement the patrol loop: move to waypoint (MoveToLocation-based) and idle with look-around (random duration 3-6s). Tasks follow State Tree lifecycle correctly (Running during work, Succeeded on completion).
</success_criteria>

<output>
After completion, create `.planning/phases/04-monster-ai-core/04-04-SUMMARY.md`
</output>
