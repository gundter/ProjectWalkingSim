---
phase: 04-monster-ai-core
plan: 06
type: execute
wave: 4
depends_on: [04-04, 04-05]
files_modified:
  - Source/ProjectWalkingSim/Public/AI/Tasks/STT_InvestigateLocation.h
  - Source/ProjectWalkingSim/Private/AI/Tasks/STT_InvestigateLocation.cpp
  - Source/ProjectWalkingSim/Public/AI/Tasks/STT_OrientToward.h
  - Source/ProjectWalkingSim/Private/AI/Tasks/STT_OrientToward.cpp
  - Source/ProjectWalkingSim/Public/AI/Conditions/STC_SuspicionLevel.h
  - Source/ProjectWalkingSim/Private/AI/Conditions/STC_SuspicionLevel.cpp
autonomous: true

must_haves:
  truths:
    - "InvestigateLocation task moves Wendigo to the last known stimulus location"
    - "OrientToward task rotates Wendigo to face a target location (menacing pause)"
    - "SuspicionLevel condition checks if alert level meets a threshold for State Tree transitions"
    - "Investigation movement is faster than patrol walk (but still slower than player)"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/AI/Tasks/STT_InvestigateLocation.h"
      provides: "State Tree task for investigating a stimulus location"
      exports: ["FSTT_InvestigateLocation"]
    - path: "Source/ProjectWalkingSim/Public/AI/Tasks/STT_OrientToward.h"
      provides: "State Tree task for turning to face stimulus"
      exports: ["FSTT_OrientToward"]
    - path: "Source/ProjectWalkingSim/Public/AI/Conditions/STC_SuspicionLevel.h"
      provides: "State Tree condition for alert level threshold checks"
      exports: ["FSTC_SuspicionLevel"]
  key_links:
    - from: "STT_InvestigateLocation"
      to: "USuspicionComponent::GetLastKnownStimulusLocation"
      via: "Reads stimulus location from pawn's SuspicionComponent"
      pattern: "GetLastKnownStimulusLocation"
    - from: "STT_OrientToward"
      to: "AAIController::SetFocalPoint"
      via: "Sets focal point to stimulus location for smooth rotation"
      pattern: "SetFocalPoint"
    - from: "STC_SuspicionLevel"
      to: "USuspicionComponent::GetAlertLevel"
      via: "Reads current alert level and compares to threshold"
      pattern: "GetAlertLevel"
---

<objective>
Create the investigation and reaction State Tree tasks plus the suspicion level condition. STT_InvestigateLocation moves the Wendigo toward a stimulus location. STT_OrientToward makes the Wendigo turn to face a direction (the menacing pause). STC_SuspicionLevel is a condition that gates State Tree transitions based on alert level. Together these enable the Suspicious behavior: stop, orient toward stimulus, then move to investigate.

Purpose: These tasks complete the Wendigo's reactive behavior set. The condition enables State Tree transitions between patrol and suspicious states, which is the core gameplay loop observable in debug view.
Output: STT_InvestigateLocation, STT_OrientToward, STC_SuspicionLevel
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-monster-ai-core/04-RESEARCH.md
@.planning/phases/04-monster-ai-core/04-CONTEXT.md

@Source/ProjectWalkingSim/Public/AI/AITypes.h
@Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
@Source/ProjectWalkingSim/Public/AI/WendigoAIController.h
@Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h
@Source/ProjectWalkingSim/Public/AI/Tasks/STT_PatrolMoveToWaypoint.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: InvestigateLocation and OrientToward tasks</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/Tasks/STT_InvestigateLocation.h
    Source/ProjectWalkingSim/Private/AI/Tasks/STT_InvestigateLocation.cpp
    Source/ProjectWalkingSim/Public/AI/Tasks/STT_OrientToward.h
    Source/ProjectWalkingSim/Private/AI/Tasks/STT_OrientToward.cpp
  </files>
  <action>
    **STT_InvestigateLocation:**

    Instance data struct (FSTT_InvestigateLocationInstanceData):
    - FVector TargetLocation = FVector::ZeroVector
    - bool bMoveRequestActive = false
    - float TimeAtLocation = 0.0f (time spent at investigation point)

    Task struct (FSTT_InvestigateLocation : FStateTreeTaskCommonBase):
    - USTRUCT(meta=(DisplayName="Investigate Location"))
    - TStateTreeExternalDataHandle<AAIController> ControllerHandle
    - UPROPERTY(EditAnywhere) float AcceptanceRadius = 100.0f (looser than patrol, investigate the area)
    - UPROPERTY(EditAnywhere) float InvestigationSpeed = 200.0f (faster than patrol 150, slower than player walk 250)
    - UPROPERTY(EditAnywhere) float LookAroundDuration = 4.0f (time to look around after arriving)

    - Link(): Linker.LinkExternalData(ControllerHandle); return true;

    - EnterState():
      - Get controller, get pawn as AWendigoCharacter
      - Get SuspicionComponent. Read LastKnownStimulusLocation.
      - If !HasStimulusLocation(): return Failed (nothing to investigate)
      - Store TargetLocation in instance data
      - Temporarily set pawn's MaxWalkSpeed to InvestigationSpeed
      - Call Controller.MoveToLocation(TargetLocation, AcceptanceRadius)
      - bMoveRequestActive = true
      - Return Running

    - Tick():
      - If bMoveRequestActive:
        - Check GetMoveStatus(). If still moving: return Running
        - If arrived: bMoveRequestActive = false, start look-around phase
      - If not moving (look-around phase):
        - TimeAtLocation += DeltaTime
        - If TimeAtLocation >= LookAroundDuration:
          - Clear SuspicionComponent stimulus location
          - Return Succeeded
        - Return Running

    - ExitState():
      - Restore pawn MaxWalkSpeed to AIConstants::WendigoWalkSpeed (150)
      - If bMoveRequestActive: Controller.StopMovement()
      - ClearFocus

    **STT_OrientToward:**

    Instance data struct (FSTT_OrientTowardInstanceData):
    - float ElapsedTime = 0.0f
    - FVector TargetLocation = FVector::ZeroVector

    Task struct (FSTT_OrientToward : FStateTreeTaskCommonBase):
    - USTRUCT(meta=(DisplayName="Orient Toward Stimulus"))
    - TStateTreeExternalDataHandle<AAIController> ControllerHandle
    - UPROPERTY(EditAnywhere) float OrientDuration = 2.0f (menacing pause duration)
    - UPROPERTY(EditAnywhere) bool bUseStimulusLocation = true (if true, read from SuspicionComponent)

    - Link(): same pattern

    - EnterState():
      - Get controller, pawn as AWendigoCharacter
      - If bUseStimulusLocation:
        - Read SuspicionComponent->GetLastKnownStimulusLocation()
        - If !HasStimulusLocation(): return Failed
        - Store in InstanceData.TargetLocation
      - Stop any current movement: Controller.StopMovement()
      - Set focal point to TargetLocation: Controller.SetFocalPoint(TargetLocation)
      - Reset ElapsedTime
      - Return Running

    - Tick():
      - ElapsedTime += DeltaTime
      - (Pawn rotates toward focal point automatically via UpdateControlRotation)
      - If ElapsedTime >= OrientDuration: return Succeeded
      - Return Running

    - ExitState():
      - Controller.ClearFocus(EAIFocusPriority::Gameplay)

    The orient task creates the "menacing pause" from CONTEXT.md -- the Wendigo stops and slowly turns to face where it detected something. This is a key horror moment.
  </action>
  <verify>Project compiles. Both task structs appear in State Tree editor with correct display names. InvestigateLocation reads from SuspicionComponent and moves at 200 cm/s. OrientToward stops movement and sets focal point for 2 seconds.</verify>
  <done>InvestigateLocation moves Wendigo to stimulus location at increased speed, then looks around. OrientToward creates the menacing pause by stopping and turning to face the stimulus.</done>
</task>

<task type="auto">
  <name>Task 2: SuspicionLevel condition</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/Conditions/STC_SuspicionLevel.h
    Source/ProjectWalkingSim/Private/AI/Conditions/STC_SuspicionLevel.cpp
  </files>
  <action>
    Create a State Tree condition that checks the Wendigo's current alert level against a configurable threshold. This is used in State Tree transitions to switch between patrol, suspicious, and alert states.

    **FSTC_SuspicionLevel : FStateTreeConditionCommonBase** (or FStateTreeConditionBase -- check engine source for the correct base class):
    - USTRUCT(meta=(DisplayName="Check Suspicion Level"))
    - TStateTreeExternalDataHandle<AAIController> ControllerHandle
    - UPROPERTY(EditAnywhere) EAlertLevel RequiredLevel = EAlertLevel::Suspicious
    - UPROPERTY(EditAnywhere) bool bInvertCondition = false (if true, condition passes when BELOW required level)

    - GetInstanceDataType(): Return nullptr or empty struct if no instance data needed.

    - Link(): Linker.LinkExternalData(ControllerHandle); return true;

    - TestCondition() (override):
      - Get controller, get pawn as AWendigoCharacter
      - Get SuspicionComponent, get current alert level
      - bool bMeetsLevel = (CurrentAlertLevel >= RequiredLevel)
        - Enum comparison: Patrol < Suspicious < Alert (ensure enum order supports this)
      - If bInvertCondition: return !bMeetsLevel
      - Return bMeetsLevel

    **Key notes:**
    - The base class for conditions may be FStateTreeConditionCommonBase or FStateTreeConditionBase. Check engine source at Plugins/Runtime/StateTree/Source/StateTreeModule/Public/ for the actual type name.
    - Override TestCondition() (the method name may be TestCondition or EvaluateCondition -- verify).
    - The condition should be lightweight (no allocations, just enum comparison).
    - EAlertLevel enum values must be ordered: Patrol=0, Suspicious=1, Alert=2 for >= comparison to work.

    **Usage in State Tree (for reference, not C++ work):**
    - Transition from Patrol state to Suspicious state: Condition = SuspicionLevel >= Suspicious
    - Transition from Suspicious to Alert: Condition = SuspicionLevel >= Alert
    - Transition back to Patrol: Condition = SuspicionLevel < Suspicious (inverted)
  </action>
  <verify>Project compiles. FSTC_SuspicionLevel appears as "Check Suspicion Level" in State Tree condition list. Condition correctly evaluates alert level against threshold.</verify>
  <done>STC_SuspicionLevel condition compiles, appears in State Tree editor, and enables transitions based on alert level thresholds (>=Suspicious, >=Alert, or inverted for <Suspicious).</done>
</task>

</tasks>

<verification>
- Project compiles with no errors
- STT_InvestigateLocation reads LastKnownStimulusLocation, moves at 200 cm/s, looks around for 4s, then clears stimulus
- STT_OrientToward stops movement and turns to face stimulus for 2s (menacing pause)
- STC_SuspicionLevel compares current alert level against configurable threshold with invert option
- All 3 structs appear in State Tree editor with correct display names
- InvestigateLocation restores walk speed in ExitState
</verification>

<success_criteria>
Two reactive State Tree tasks and one condition complete the Wendigo's Phase 4 behavior set. InvestigateLocation navigates to stimulus at increased speed. OrientToward creates the menacing detection pause. SuspicionLevel condition enables State Tree transitions between patrol/suspicious/alert states. All appear in the State Tree editor for visual authoring.
</success_criteria>

<output>
After completion, create `.planning/phases/04-monster-ai-core/04-06-SUMMARY.md`
</output>
