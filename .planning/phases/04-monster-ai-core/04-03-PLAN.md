---
phase: 04-monster-ai-core
plan: 03
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - Source/ProjectWalkingSim/Public/AI/WendigoAIController.h
  - Source/ProjectWalkingSim/Private/AI/WendigoAIController.cpp
autonomous: true

must_haves:
  truths:
    - "AI controller has StateTreeAIComponent with two-flag StartLogic guard"
    - "AI Perception detects player via sight (2500cm range, 90 deg FOV)"
    - "AI Perception detects noise events via hearing (2000cm range)"
    - "OnTargetPerceptionUpdated delegate fires when player enters/leaves perception"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/AI/WendigoAIController.h"
      provides: "Wendigo AI controller with StateTree + Perception"
      exports: ["AWendigoAIController"]
      min_lines: 40
    - path: "Source/ProjectWalkingSim/Private/AI/WendigoAIController.cpp"
      provides: "Constructor, perception config, StartLogic guard, perception handler stub"
      min_lines: 60
  key_links:
    - from: "WendigoAIController.h"
      to: "UStateTreeAIComponent"
      via: "CreateDefaultSubobject"
      pattern: "StateTreeAIComponent"
    - from: "WendigoAIController.h"
      to: "UAIPerceptionComponent"
      via: "CreateDefaultSubobject + ConfigureSense"
      pattern: "AIPerceptionComponent"
    - from: "WendigoAIController.cpp"
      to: "OnTargetPerceptionUpdated"
      via: "AddDynamic in BeginPlay"
      pattern: "OnTargetPerceptionUpdated"
---

<objective>
Create the Wendigo AI controller with State Tree AI component and AI Perception system (sight + hearing). The controller is the "brain" that drives the Wendigo pawn. It configures perception senses in the constructor, binds perception delegates in BeginPlay, and uses a two-flag guard to safely start the State Tree after both BeginPlay and OnPossess complete.

Purpose: The AI controller is the central coordination point between State Tree behavior and perception input. Plan 05 will wire the perception handler to the SuspicionComponent.
Output: AWendigoAIController.h/.cpp with StateTreeAI, Perception, and StartLogic guard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-monster-ai-core/04-RESEARCH.md

@Source/ProjectWalkingSim/Public/AI/AITypes.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: WendigoAIController with StateTree and Perception</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/WendigoAIController.h
    Source/ProjectWalkingSim/Private/AI/WendigoAIController.cpp
  </files>
  <action>
    Create AWendigoAIController (AAIController) with:

    **Header - includes and forward declarations:**
    - Forward declare: UStateTreeAIComponent, UAIPerceptionComponent, UAISenseConfig_Sight, UAISenseConfig_Hearing
    - Include AIController.h

    **Constructor (configure in .cpp, include actual headers there):**
    - Create UStateTreeAIComponent as default subobject ("StateTreeAIComponent")
    - Create UAIPerceptionComponent as default subobject ("AIPerceptionComponent")
    - Call SetPerceptionComponent(*AIPerceptionComponent)

    - Create UAISenseConfig_Sight as default subobject ("SightConfig"):
      - SightRadius = 2500.0f (25m)
      - LoseSightRadius = 3000.0f (30m, prevents detection flicker)
      - PeripheralVisionAngleDegrees = 45.0f (90 degree total FOV)
      - SetMaxAge(5.0f) (forget after 5 seconds without seeing)
      - DetectionByAffiliation: bDetectEnemies = true, bDetectNeutrals = true, bDetectFriendlies = true (detect all for demo)
      - bAutoRegisterAsSource = true (player auto-registers as visual stimulus)
    - Call AIPerceptionComponent->ConfigureSense(*SightConfig)

    - Create UAISenseConfig_Hearing as default subobject ("HearingConfig"):
      - HearingRange = 2000.0f (20m)
      - SetMaxAge(3.0f) (forget after 3 seconds)
      - DetectionByAffiliation: all true
    - Call AIPerceptionComponent->ConfigureSense(*HearingConfig)

    - Set dominant sense to sight: AIPerceptionComponent->SetDominantSense(UAISense_Sight::StaticClass())

    **BeginPlay override:**
    - Call Super::BeginPlay()
    - Bind AIPerceptionComponent->OnTargetPerceptionUpdated to OnTargetPerceptionUpdated via AddDynamic
      (IMPORTANT: bind in BeginPlay, NOT constructor -- delegates don't work from constructor)
    - Set bBeginPlayCalled = true
    - Call TryStartStateTree()

    **OnPossess override:**
    - Call Super::OnPossess(InPawn)
    - Set bPossessCalled = true
    - Call TryStartStateTree()

    **TryStartStateTree (private):**
    - If bBeginPlayCalled AND bPossessCalled AND StateTreeAIComponent is valid:
      - Call StateTreeAIComponent->StartLogic()
      - UE_LOG(LogSerene, Log, TEXT("Wendigo State Tree started"))
    - This two-flag guard prevents the known UE5 bug where bStartLogicAutomatically fails

    **OnTargetPerceptionUpdated (UFUNCTION, private):**
    - Signature: void OnTargetPerceptionUpdated(AActor* Actor, FAIStimulus Stimulus)
    - For now, just log: UE_LOG(LogSerene, Log, TEXT("Wendigo perceived: %s (Sense: %s, Active: %s)"), *Actor->GetName(), ...)
    - Plan 05 will expand this to feed SuspicionComponent

    **Properties (VisibleAnywhere):**
    - TObjectPtr<UStateTreeAIComponent> StateTreeAIComponent
    - TObjectPtr<UAIPerceptionComponent> AIPerceptionComponent
    - TObjectPtr<UAISenseConfig_Sight> SightConfig (not VisibleAnywhere, just UPROPERTY for GC)
    - TObjectPtr<UAISenseConfig_Hearing> HearingConfig (same)

    **Private:**
    - bool bBeginPlayCalled = false
    - bool bPossessCalled = false

    Required includes in .cpp:
    - "Components/StateTreeAIComponent.h" (verify exact path -- may be "StateTreeModule/Public/Components/StateTreeAIComponent.h" or just "Components/StateTreeAIComponent.h")
    - "Perception/AIPerceptionComponent.h"
    - "Perception/AISenseConfig_Sight.h"
    - "Perception/AISenseConfig_Hearing.h"
    - "Perception/AISense_Sight.h" (for StaticClass in SetDominantSense)
    - "Core/SereneLogChannels.h"

    NOTE: If "Components/StateTreeAIComponent.h" does not compile, try "StateTreeAIComponent.h" or check engine source at Plugins/Runtime/GameplayStateTree/Source/GameplayStateTreeModule/Public/ for the actual path. The research flagged include paths as LOW confidence.
  </action>
  <verify>Project compiles. AWendigoAIController can be instantiated. Log output shows "Wendigo State Tree started" when a Wendigo is placed and possessed (verified in Plan 07).</verify>
  <done>AWendigoAIController has StateTreeAIComponent, UAIPerceptionComponent with sight (2500cm, 90deg) and hearing (2000cm), two-flag StartLogic guard, and perception delegate bound in BeginPlay.</done>
</task>

</tasks>

<verification>
- Project compiles with no errors
- AWendigoAIController creates StateTreeAIComponent and AIPerceptionComponent in constructor
- Sight config: 2500cm range, 3000cm lose range, 45deg half-angle, all affiliation flags true
- Hearing config: 2000cm range, all affiliation flags true
- Sight is set as dominant sense
- OnTargetPerceptionUpdated delegate bound in BeginPlay (not constructor)
- TryStartStateTree guards on both bBeginPlayCalled and bPossessCalled before calling StartLogic
</verification>

<success_criteria>
AWendigoAIController compiles and correctly configures State Tree AI component and AI Perception with sight and hearing senses. The two-flag StartLogic guard prevents the known timing bug. Perception delegate is bound for future suspicion wiring.
</success_criteria>

<output>
After completion, create `.planning/phases/04-monster-ai-core/04-03-SUMMARY.md`
</output>
