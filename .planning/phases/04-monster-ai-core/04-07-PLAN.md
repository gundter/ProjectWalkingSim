---
phase: 04-monster-ai-core
plan: 07
type: execute
wave: 5
depends_on: [04-04, 04-05, 04-06]
files_modified:
  - Config/DefaultEngine.ini
autonomous: false
user_setup:
  - service: editor
    why: "State Tree asset, Blueprint subclass, NavMesh must be created in Unreal Editor UI"
    dashboard_config:
      - task: "Create State Tree asset (ST_WendigoAI)"
        location: "Content Browser > Right-click > Artificial Intelligence > State Tree"
      - task: "Create BP_WendigoCharacter Blueprint from AWendigoCharacter"
        location: "Content Browser > Right-click > Blueprint Class > AWendigoCharacter"
      - task: "Create BP_PatrolRoute Blueprint from APatrolRouteActor"
        location: "Content Browser > Right-click > Blueprint Class > APatrolRouteActor"
      - task: "Configure NavMesh agent for tall character"
        location: "Project Settings > Navigation Mesh > Agents"
      - task: "Place NavMeshBoundsVolume in level"
        location: "Place Actors > Volumes > NavMeshBoundsVolume"

must_haves:
  truths:
    - "Wendigo follows patrol route through designated waypoints in PIE"
    - "Wendigo visually detects player who is visible and not hiding"
    - "Wendigo reacts to sprint noise (suspicion increases)"
    - "State Tree drives behavior transitions observable in debug view"
    - "Wendigo transitions Patrol->Suspicious when player is partially visible"
  artifacts:
    - path: "Config/DefaultEngine.ini"
      provides: "NavMesh agent configuration for tall character"
      contains: "NavMesh"
  key_links:
    - from: "BP_WendigoCharacter"
      to: "ST_WendigoAI"
      via: "StateTreeAIComponent references State Tree asset"
      pattern: "State Tree asset assigned in controller"
    - from: "BP_WendigoCharacter"
      to: "BP_PatrolRoute"
      via: "PatrolRoute property set per-instance in level"
      pattern: "PatrolRoute reference in Details panel"
---

<objective>
Configure NavMesh for the tall Wendigo, create Blueprint subclasses and the State Tree asset in the editor, wire everything together, and verify the complete AI loop in PIE. This is the integration and verification plan that proves all Phase 4 C++ code works end-to-end.

Purpose: C++ code alone cannot run without editor-created assets (State Tree, Blueprints, NavMesh). This plan bridges code to playable behavior.
Output: NavMesh config, BP_WendigoCharacter, BP_PatrolRoute, ST_WendigoAI State Tree asset, verified patrol and detection in PIE.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-monster-ai-core/04-RESEARCH.md
@.planning/phases/04-monster-ai-core/04-CONTEXT.md

@Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
@Source/ProjectWalkingSim/Public/AI/WendigoAIController.h
@Source/ProjectWalkingSim/Public/AI/PatrolRouteActor.h
@Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h
@Source/ProjectWalkingSim/Public/AI/Tasks/STT_PatrolMoveToWaypoint.h
@Source/ProjectWalkingSim/Public/AI/Tasks/STT_PatrolIdle.h
@Source/ProjectWalkingSim/Public/AI/Tasks/STT_InvestigateLocation.h
@Source/ProjectWalkingSim/Public/AI/Tasks/STT_OrientToward.h
@Source/ProjectWalkingSim/Public/AI/Conditions/STC_SuspicionLevel.h
@Config/DefaultEngine.ini
</context>

<tasks>

<task type="auto">
  <name>Task 1: NavMesh configuration for tall character</name>
  <files>
    Config/DefaultEngine.ini
  </files>
  <action>
    Add NavMesh agent configuration for the Wendigo's tall capsule. The default agent profile is for standard ~180cm characters. The Wendigo needs a second profile with ~275cm agent height and ~60cm radius.

    Add to DefaultEngine.ini (under [/Script/NavigationSystem.NavigationSystemV1] or [/Script/NavigationSystem.RecastNavMesh]):

    If NavMesh agent configuration exists, add a second agent. If not, create the configuration section.

    The exact INI syntax for NavMesh agent profiles:
    ```
    [/Script/NavigationSystem.NavigationSystemV1]
    +SupportedAgents=(Name="Default",AgentRadius=34.0,AgentHeight=144.0,AgentStepHeight=35.0)
    +SupportedAgents=(Name="Wendigo",AgentRadius=60.0,AgentHeight=275.0,AgentStepHeight=35.0)
    ```

    NOTE: The exact INI format for multi-agent NavMesh may require Project Settings UI instead. If the INI approach does not work, document what needs to be set in Project Settings > Navigation Mesh > Agents and leave it for the checkpoint task.

    Also ensure NavigationSystem is enabled (it should be by default in UE5.7).

    Do NOT remove any existing DefaultEngine.ini content. Append the navigation configuration.
  </action>
  <verify>Open Project Settings > Navigation Mesh > Agents. Two agents should appear: Default and Wendigo. If only one appears, the INI config may need manual adjustment in the editor.</verify>
  <done>NavMesh has a second agent profile for the Wendigo (275cm height, 60cm radius).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    All Phase 4 C++ code: WendigoAIController (State Tree + Perception), WendigoCharacter (tall pawn + SuspicionComponent), PatrolRouteActor, 4 State Tree tasks (PatrolMoveToWaypoint, PatrolIdle, InvestigateLocation, OrientToward), 1 State Tree condition (SuspicionLevel), NoiseReportingComponent, NavMesh config.
  </what-built>
  <how-to-verify>
    **Step 1: Create Blueprint subclasses**
    1. Content Browser > right-click > Blueprint Class > search "WendigoCharacter" > Create BP_WendigoCharacter
       - Save to Content/AI/
       - Open BP_WendigoCharacter > Components > Mesh: assign SK_Mannequin
       - Set Mesh scale to approximately (1.4, 1.4, 1.4) to make it visually ~8.5ft tall
         (Capsule is already 260cm from C++ -- mesh scale is visual only)
    2. Content Browser > right-click > Blueprint Class > search "PatrolRouteActor" > Create BP_PatrolRoute
       - Save to Content/AI/

    **Step 2: Create State Tree asset**
    1. Content Browser > right-click > Artificial Intelligence > State Tree > Create ST_WendigoAI
       - Save to Content/AI/
    2. Open ST_WendigoAI:
       - Set Schema to StateTreeAIComponentSchema
       - Set AIController Class to WendigoAIController (or BP subclass)
       - Set Context Actor Class to WendigoCharacter (or BP subclass)
    3. Create the State Tree structure:
       - Root state: "Wendigo Behavior"
       - Child state 1: "Patrol" (default active state)
         - Add task: "Patrol: Move To Waypoint"
         - Add linked state: "Patrol Idle" (transition on task Succeeded)
       - Child state 2: "Patrol Idle"
         - Add task: "Patrol: Idle / Look Around"
         - Add linked state back to: "Patrol" (transition on task Succeeded)
       - Child state 3: "Suspicious"
         - Transition INTO this state: Add condition "Check Suspicion Level" with RequiredLevel = Suspicious
         - Add task: "Orient Toward Stimulus" (menacing pause)
         - After orient succeeds, transition to "Investigate" sub-state or add "Investigate Location" task
       - Child state 4: "Investigate"
         - Add task: "Investigate Location"
         - On Succeeded: transition back to "Patrol"
       - Transition from Suspicious/Investigate back to Patrol: condition "Check Suspicion Level" with RequiredLevel = Suspicious, bInvertCondition = true

       NOTE: State Tree visual structure is flexible. The key behaviors are:
       - Default: cycle between PatrolMoveToWaypoint and PatrolIdle
       - On suspicion >= Suspicious: OrientToward then InvestigateLocation
       - On suspicion decay back to Patrol: return to patrol cycle

    **Step 3: Assign State Tree to controller**
    1. Open BP_WendigoCharacter > Details > AI Controller Class: should already be WendigoAIController (set in C++)
    2. If the StateTreeAIComponent is visible in the controller, assign ST_WendigoAI to it
       - Alternatively, this may need to be set in a BP subclass of the controller

    **Step 4: Configure NavMesh**
    1. Check Project Settings > Navigation Mesh > Agents: should show Default + Wendigo
       - If Wendigo agent is missing: add it manually (Radius=60, Height=275, Step Height=35)
    2. Place a NavMeshBoundsVolume in the level covering the test area
    3. Build navigation: Build > Build Paths (or it auto-builds)
    4. Press P to visualize NavMesh in viewport -- green overlay should appear

    **Step 5: Set up test level**
    1. Place BP_PatrolRoute in level
       - In Details panel, add 3-4 waypoints to the Waypoints array (use viewport coordinates or MakeEditWidget handles)
       - Space waypoints ~500-1000cm apart in a loop
    2. Place BP_WendigoCharacter in level
       - In Details panel, set PatrolRoute reference to the BP_PatrolRoute actor
    3. Ensure player start is within sight range (~25m) of patrol route

    **Step 6: PIE verification**
    1. Press Play (PIE)
    2. Verify patrol: Wendigo should move between waypoints with pauses
       - Check Output Log for "Wendigo State Tree started"
       - Wendigo walks slowly (150 cm/s) between points
       - Wendigo pauses for 3-6 seconds at intervals
    3. Verify sight detection: Walk in front of Wendigo (within 25m, in its 90-degree FOV)
       - Check Output Log for perception events
       - If well-lit area (visibility > 0.3), suspicion should accumulate
       - Wendigo should eventually become Suspicious (stop, orient toward player)
    4. Verify hearing: Sprint near the Wendigo (within 20m)
       - Check Output Log for "Sprint noise reported" and "Wendigo heard noise"
       - Suspicion should increase from hearing stimulus
    5. Verify hiding: Enter a hiding spot if available
       - Wendigo should not detect player (visibility score drops below threshold)
    6. Enable AI debug: Use console command `ai.debug.enablecategory perception` and/or `ShowDebug AI`
       - Sight cone visualization should appear
       - State Tree state should be visible

    **Expected results:**
    - Wendigo patrols waypoints with periodic pauses (WNDG-01, WNDG-02)
    - Wendigo detects visible player via sight (WNDG-07 sight)
    - Wendigo reacts to sprint noise (WNDG-07 hearing)
    - State Tree transitions between Patrol and Suspicious are visible in debug
    - Alert level transitions logged to Output Log
  </how-to-verify>
  <resume-signal>Type "approved" if patrol, detection, and reactions work. Describe any issues if they don't.</resume-signal>
</task>

</tasks>

<verification>
- NavMesh has Wendigo agent profile (275cm height, 60cm radius)
- BP_WendigoCharacter exists with Mannequin mesh scaled to ~8.5ft
- BP_PatrolRoute exists and supports waypoint editing
- ST_WendigoAI State Tree asset created with patrol cycle and suspicious states
- Wendigo patrols waypoints in PIE
- Wendigo detects visible player and transitions to Suspicious
- Wendigo reacts to sprint noise
- State Tree transitions visible in AI debug view
</verification>

<success_criteria>
All four Phase 4 success criteria verified in PIE:
1. Wendigo follows patrol route through designated zones
2. Wendigo visually detects player who is visible and not hiding
3. Wendigo reacts to loud player sounds (running/sprinting)
4. State Tree drives behavior transitions observable in debug view
</success_criteria>

<output>
After completion, create `.planning/phases/04-monster-ai-core/04-07-SUMMARY.md`
</output>
