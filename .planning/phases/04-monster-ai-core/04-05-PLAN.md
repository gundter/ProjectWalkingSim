---
phase: 04-monster-ai-core
plan: 05
type: execute
wave: 3
depends_on: [04-02, 04-03]
files_modified:
  - Source/ProjectWalkingSim/Private/AI/WendigoAIController.cpp
  - Source/ProjectWalkingSim/Public/AI/WendigoAIController.h
  - Source/ProjectWalkingSim/Public/AI/NoiseReportingComponent.h
  - Source/ProjectWalkingSim/Private/AI/NoiseReportingComponent.cpp
  - Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
  - Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
autonomous: true

must_haves:
  truths:
    - "When Wendigo sees the player, visibility score feeds into suspicion accumulation"
    - "When player sprints, footstep noise is reported to AI hearing system"
    - "Walking and crouching footsteps do NOT generate AI noise"
    - "Suspicion decays when Wendigo loses sight of the player"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/AI/NoiseReportingComponent.h"
      provides: "Bridge between FootstepComponent and AI hearing"
      exports: ["UNoiseReportingComponent"]
    - path: "Source/ProjectWalkingSim/Private/AI/WendigoAIController.cpp"
      provides: "Perception handler wired to SuspicionComponent"
      contains: "ProcessSightStimulus"
  key_links:
    - from: "WendigoAIController::OnTargetPerceptionUpdated"
      to: "USuspicionComponent::ProcessSightStimulus"
      via: "Gets VisibilityScore from player, feeds to suspicion"
      pattern: "GetVisibilityScore.*ProcessSightStimulus"
    - from: "NoiseReportingComponent"
      to: "UAISense_Hearing::ReportNoiseEvent"
      via: "Listens to FootstepComponent OnFootstep, reports sprint noise"
      pattern: "ReportNoiseEvent"
    - from: "NoiseReportingComponent"
      to: "UFootstepComponent::OnFootstep"
      via: "Delegate binding"
      pattern: "OnFootstep.*AddDynamic"
---

<objective>
Wire the perception-to-suspicion pipeline and the sprint noise reporting bridge. The AI controller's OnTargetPerceptionUpdated handler reads the player's visibility score and feeds it into the SuspicionComponent. A new NoiseReportingComponent on the player character listens to FootstepComponent::OnFootstep and calls UAISense_Hearing::ReportNoiseEvent for sprint-volume footsteps only.

Purpose: This connects the existing player systems (VisibilityScore, FootstepComponent) to the new AI systems (Perception, Suspicion). Without this wiring, the Wendigo can see and hear but cannot process what it detects.
Output: Updated WendigoAIController with perception handler, NoiseReportingComponent on player, character integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-monster-ai-core/04-RESEARCH.md
@.planning/phases/04-monster-ai-core/04-CONTEXT.md

@Source/ProjectWalkingSim/Public/AI/AITypes.h
@Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
@Source/ProjectWalkingSim/Public/AI/WendigoAIController.h
@Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h
@Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
@Source/ProjectWalkingSim/Public/Player/Components/FootstepComponent.h
@Source/ProjectWalkingSim/Public/Visibility/VisibilityScoreComponent.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Perception-to-Suspicion wiring in AI Controller</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/WendigoAIController.h
    Source/ProjectWalkingSim/Private/AI/WendigoAIController.cpp
  </files>
  <action>
    Expand the OnTargetPerceptionUpdated handler (currently a log stub from Plan 03) to process perception events:

    **Add to header:**
    - private: void ProcessSightPerception(AActor* Player, bool bCurrentlySensed)
    - private: void ProcessHearingPerception(AActor* Instigator, FVector StimulusLocation)

    **Add to Tick override (new):**
    - Override Tick(float DeltaTime)
    - In Tick: Get the possessed pawn as AWendigoCharacter. Get SuspicionComponent.
    - Check if any player is currently sensed via sight (AIPerceptionComponent->GetCurrentlyPerceivedActors with UAISense_Sight gives list).
    - If a player IS currently perceived by sight:
      - Get the player's UVisibilityScoreComponent (FindComponentByClass on the perceived actor)
      - Get visibility score
      - Call SuspicionComponent->ProcessSightStimulus(VisibilityScore, DeltaTime)
    - If NO player is currently perceived by sight:
      - Call SuspicionComponent->DecaySuspicion(DeltaTime)

    **OnTargetPerceptionUpdated implementation:**
    - Check Stimulus.Type (compare against UAISense_Sight::StaticClass()->GetDefaultObject()->GetSenseID() and UAISense_Hearing equivalent)
    - For SIGHT stimulus:
      - Call ProcessSightPerception(Actor, Stimulus.WasSuccessfullySensed())
    - For HEARING stimulus:
      - Call ProcessHearingPerception(Actor, Stimulus.StimulusLocation)

    **ProcessSightPerception:**
    - If bCurrentlySensed:
      - Log: "Wendigo sees %s (Visibility: %.2f)"
      - (Continuous processing happens in Tick, this is just for the initial/lost detection event)
    - If NOT bCurrentlySensed:
      - Log: "Wendigo lost sight of %s"

    **ProcessHearingPerception:**
    - Get SuspicionComponent from possessed pawn
    - Call SuspicionComponent->ProcessHearingStimulus(StimulusLocation)
    - Log: "Wendigo heard noise at %s"

    **IMPORTANT:**
    - The continuous sight processing is in Tick (not in the delegate) because ProcessSightStimulus needs DeltaTime for rate-based accumulation.
    - The delegate fires on state changes (enter/exit perception). Tick handles ongoing accumulation.
    - Include "Visibility/VisibilityScoreComponent.h" and "AI/WendigoCharacter.h" and "AI/SuspicionComponent.h" in .cpp.
  </action>
  <verify>Project compiles. When a player walks in front of the Wendigo (above 0.3 visibility), suspicion accumulates. When player leaves sight, suspicion decays. Log output confirms perception events.</verify>
  <done>Perception events flow through to SuspicionComponent: sight triggers continuous accumulation in Tick, hearing triggers immediate suspicion bump with stimulus location. Decay occurs when no player is seen.</done>
</task>

<task type="auto">
  <name>Task 2: Sprint noise reporting component</name>
  <files>
    Source/ProjectWalkingSim/Public/AI/NoiseReportingComponent.h
    Source/ProjectWalkingSim/Private/AI/NoiseReportingComponent.cpp
    Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
    Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
  </files>
  <action>
    **NoiseReportingComponent:**

    Create UNoiseReportingComponent (UActorComponent):
    - Purpose: Listens to FootstepComponent's OnFootstep delegate. When volume exceeds sprint threshold, reports noise to AI hearing system.
    - This lives on the PLAYER character (not the Wendigo), because the player is the noise source.

    BeginPlay():
    - Find FootstepComponent on owner actor (FindComponentByClass)
    - Bind to OnFootstep delegate via AddDynamic
    - If FootstepComponent not found, log warning

    UFUNCTION() HandleFootstep(EPhysicalSurface SurfaceType, float Volume):
    - Only report noise for sprinting: if Volume > 1.0f (sprint volume is 1.5, walk is 1.0, crouch is 0.3)
    - Call UAISense_Hearing::ReportNoiseEvent(GetWorld(), GetOwner()->GetActorLocation(), Volume, GetOwner(), SprintNoiseRange, FName())
    - SprintNoiseRange is an editable property (default 2000.0f = 20m)
    - Log: "Sprint noise reported at volume %.1f"

    Properties:
    - UPROPERTY(EditAnywhere) float SprintNoiseRange = 2000.0f
    - UPROPERTY(EditAnywhere) float SprintVolumeThreshold = 1.0f (volume above which we report)

    Include "Perception/AISense_Hearing.h" in .cpp for ReportNoiseEvent.

    **SereneCharacter integration:**
    - Add UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components") TObjectPtr<UNoiseReportingComponent> NoiseReportingComponent
    - Forward declare UNoiseReportingComponent in header
    - In constructor: NoiseReportingComponent = CreateDefaultSubobject<UNoiseReportingComponent>(TEXT("NoiseReportingComponent"))
    - Include "AI/NoiseReportingComponent.h" in .cpp
    - Update class comment to mention 10 components total (was 9)

    This is the 10th component on ASereneCharacter. Add it after VisibilityScoreComponent in the component list.
  </action>
  <verify>Project compiles. When the player sprints, UAISense_Hearing::ReportNoiseEvent is called (visible in AI debug drawing if enabled). Walking and crouching do NOT trigger noise reports.</verify>
  <done>NoiseReportingComponent on player reports sprint footsteps to AI hearing. Walking/crouching are silent. Component is wired on ASereneCharacter as the 10th component.</done>
</task>

</tasks>

<verification>
- Project compiles with no errors
- WendigoAIController Tick continuously feeds VisibilityScore to SuspicionComponent when player is in sight
- WendigoAIController decays suspicion when player is NOT in sight
- ProcessHearingPerception feeds stimulus location to SuspicionComponent
- NoiseReportingComponent only reports noise for Volume > 1.0 (sprint)
- NoiseReportingComponent is created on ASereneCharacter in constructor
- Sprint noise reaches AI via UAISense_Hearing::ReportNoiseEvent
</verification>

<success_criteria>
The perception-to-suspicion pipeline is complete: sight perception feeds visibility score into gradual suspicion accumulation; hearing perception from sprint footsteps creates suspicion bumps with location data. The NoiseReportingComponent bridges the existing FootstepComponent to AI hearing, reporting only sprint-volume noise. Walking and crouching are silent to AI.
</success_criteria>

<output>
After completion, create `.planning/phases/04-monster-ai-core/04-05-SUMMARY.md`
</output>
