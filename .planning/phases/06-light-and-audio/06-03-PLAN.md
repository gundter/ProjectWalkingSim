---
phase: 06-light-and-audio
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Source/ProjectWalkingSim/Public/Audio/MusicTensionSystem.h
  - Source/ProjectWalkingSim/Private/Audio/MusicTensionSystem.cpp
  - Source/ProjectWalkingSim/Public/Audio/AmbientAudioManager.h
  - Source/ProjectWalkingSim/Private/Audio/AmbientAudioManager.cpp
autonomous: true

must_haves:
  truths:
    - "MusicTensionSystem crossfades between Calm/Tense/Intense music layers based on alert level"
    - "MusicTensionSystem plays one-shot stingers for specific gameplay events"
    - "AmbientAudioManager plays a continuous ambient bed with randomized one-shots"
    - "AmbientAudioManager can fade all ambient to silence for predator silence moments"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Audio/MusicTensionSystem.h"
      provides: "UMusicTensionSystem component with 3 music layers and stinger support"
      contains: "class UMusicTensionSystem"
    - path: "Source/ProjectWalkingSim/Private/Audio/MusicTensionSystem.cpp"
      provides: "Alert-level-driven crossfade and stinger playback"
      contains: "SetMusicIntensity"
    - path: "Source/ProjectWalkingSim/Public/Audio/AmbientAudioManager.h"
      provides: "AAmbientAudioManager actor with ambient bed and one-shot pool"
      contains: "class AAmbientAudioManager"
    - path: "Source/ProjectWalkingSim/Private/Audio/AmbientAudioManager.cpp"
      provides: "Ambient bed playback, randomized one-shots, predator silence API"
      contains: "EnterPredatorSilence"
  key_links:
    - from: "MusicTensionSystem.cpp"
      to: "SuspicionComponent::OnAlertLevelChanged"
      via: "Dynamic delegate binding"
      pattern: "OnAlertLevelChanged\\.AddDynamic"
    - from: "MusicTensionSystem.cpp"
      to: "UAudioComponent::FadeIn/FadeOut"
      via: "Built-in crossfade API"
      pattern: "Fade(In|Out)"
---

<objective>
Create MusicTensionSystem (alert-level-driven dynamic music with crossfade) and AmbientAudioManager (layered ambient soundscape with predator silence).

Purpose: Delivers AUDO-04 (dynamic music and tension stingers) and AUDO-02 (ambient horror soundscape). Music intensity follows AI alert state. Ambient provides continuous atmospheric bed with random one-shots. Both are infrastructure -- actual sound assets are Phase 8.

Output: MusicTensionSystem.h/.cpp and AmbientAudioManager.h/.cpp in Audio/. Both compile cleanly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-light-and-audio/06-RESEARCH.md
@.planning/phases/06-light-and-audio/06-CONTEXT.md
@Source/ProjectWalkingSim/Public/AI/MonsterAITypes.h
@Source/ProjectWalkingSim/Public/AI/SuspicionComponent.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MusicTensionSystem</name>
  <files>
    Source/ProjectWalkingSim/Public/Audio/MusicTensionSystem.h
    Source/ProjectWalkingSim/Private/Audio/MusicTensionSystem.cpp
  </files>
  <action>
Create UMusicTensionSystem as a UActorComponent. It manages three music layers (Calm, Tense, Intense) via crossfade and plays one-shot stingers.

**Header (MusicTensionSystem.h):**

Define EMusicIntensity enum (BlueprintType):
- Calm (patrol -- ambient drone, sparse)
- Tense (suspicious -- building tension)
- Intense (alert/chase -- full intensity)
- Silent (special: predator silence moment)

UMusicTensionSystem class:
- Inherits UActorComponent, ClassGroup=(Audio), BlueprintSpawnableComponent
- Override BeginPlay(), EndPlay()

Public API (BlueprintCallable):
- `void SetMusicIntensity(EMusicIntensity NewIntensity)` -- crossfade to new tier
- `void PlayStinger(USoundBase* StingerSound)` -- play a non-positional one-shot

Protected properties (EditAnywhere):
- `TSoftObjectPtr<USoundBase> CalmMusic` -- looping calm layer
- `TSoftObjectPtr<USoundBase> TenseMusic` -- looping tense layer
- `TSoftObjectPtr<USoundBase> IntenseMusic` -- looping intense layer
- `TSoftObjectPtr<USoundBase> SpottedStinger` -- monster spots player
- `TSoftObjectPtr<USoundBase> EscapedStinger` -- player escapes chase
- `TSoftObjectPtr<USoundBase> GrabAttackStinger` -- grab attack initiated
- `float CrossfadeDuration = 3.0f` -- seconds for layer crossfade

Private members:
- `TObjectPtr<UAudioComponent> MusicLayers[3]` -- indexed by EMusicIntensity (Calm=0, Tense=1, Intense=2)
- `TObjectPtr<UAudioComponent> StingerComp` -- for one-shot stingers (2D, non-spatial)
- `EMusicIntensity CurrentIntensity = EMusicIntensity::Calm`

Private methods:
- `UFUNCTION() void OnAlertLevelChanged(EAlertLevel NewLevel)` -- delegate handler
- `EMusicIntensity AlertLevelToIntensity(EAlertLevel Level) const`
- `UAudioComponent* GetLayerComponent(EMusicIntensity Intensity) const`
- `void CreateMusicLayers()` -- creates and configures the 3 UAudioComponents
- `void BindToWendigo()` -- finds Wendigo in world and binds to SuspicionComponent delegate

**Implementation (MusicTensionSystem.cpp):**

Constructor: Disable tick.

BeginPlay():
1. Super::BeginPlay()
2. CreateMusicLayers()
3. BindToWendigo()
4. Start playing Calm layer at full volume (others created but silent)

CreateMusicLayers():
1. For each of the 3 layers (Calm, Tense, Intense):
   - Create UAudioComponent via NewObject<UAudioComponent>(GetOwner())
   - Attach to owner root component
   - Set bAutoActivate=false, bAutoDestroy=false
   - Set bIsUISound=true (non-spatialized, 2D music)
   - Load the corresponding TSoftObjectPtr. If valid, SetSound().
   - RegisterComponent()
   - Store in MusicLayers[index]
2. Create StingerComp similarly (bIsUISound=true, non-spatial)

BindToWendigo():
1. Use UGameplayStatics::GetAllActorsOfClass to find AWendigoCharacter
2. If found, get SuspicionComponent, bind OnAlertLevelChanged.AddDynamic
3. Also bind to WendigoCharacter->OnBehaviorStateChanged for stinger triggers:
   - When NewState == Chasing (and previous was not Chasing), play SpottedStinger
   - When NewState == Searching (previous was Chasing), play EscapedStinger
   - When NewState == GrabAttack, play GrabAttackStinger
4. If no Wendigo found, log warning (acceptable -- Wendigo may spawn later)
5. NOTE: If Wendigo spawns dynamically (via SpawnPoint), this binding will miss it. Add a public `void BindToWendigoCharacter(AWendigoCharacter* Wendigo)` method that Plan 05 can call from spawn logic. The BeginPlay auto-find is a convenience for level-placed Wendigos.

OnAlertLevelChanged(NewLevel):
- Call SetMusicIntensity(AlertLevelToIntensity(NewLevel))

AlertLevelToIntensity():
- Patrol -> Calm, Suspicious -> Tense, Alert -> Intense

SetMusicIntensity(NewIntensity):
1. If NewIntensity == CurrentIntensity, return
2. If NewIntensity == Silent: fade out all layers, set CurrentIntensity, return
3. Fade out current layer: GetLayerComponent(CurrentIntensity)->FadeOut(CrossfadeDuration, 0.0f, EAudioFaderCurve::SCurve)
4. Fade in new layer: if not playing call Play() first, then FadeIn(CrossfadeDuration, MusicActiveVolume, 0.0f, EAudioFaderCurve::SCurve)
5. Update CurrentIntensity
6. Null-check both components before fade operations

PlayStinger(StingerSound):
1. If !StingerSound or !StingerComp, return
2. StingerComp->SetSound(StingerSound)
3. StingerComp->Play()

EndPlay():
1. Stop all music layers and stinger
2. Super::EndPlay()

**Stinger trigger via behavior state -- add a separate delegate handler:**
- `UFUNCTION() void OnBehaviorStateChangedForStingers(EWendigoBehaviorState NewState)`
- Track PreviousBehaviorState as a private member to detect transitions
- Chasing entry (from any non-Chasing): play SpottedStinger
- Searching entry (from Chasing): play EscapedStinger
- GrabAttack entry: play GrabAttackStinger
  </action>
  <verify>
Project compiles. Verify:
1. EMusicIntensity enum generates correctly
2. No missing includes for UAudioComponent, UGameplayStatics
3. Delegate binding signatures match (EAlertLevel, EWendigoBehaviorState)
  </verify>
  <done>MusicTensionSystem crossfades 3 music layers driven by AlertLevel, plays stingers on behavior state transitions, all via delegate binding (no Tick).</done>
</task>

<task type="auto">
  <name>Task 2: Create AmbientAudioManager</name>
  <files>
    Source/ProjectWalkingSim/Public/Audio/AmbientAudioManager.h
    Source/ProjectWalkingSim/Private/Audio/AmbientAudioManager.cpp
  </files>
  <action>
Create AAmbientAudioManager as an AActor placed in the level. It manages continuous ambient bed audio and randomized one-shot environmental sounds.

**Header (AmbientAudioManager.h):**

AAmbientAudioManager class:
- Inherits AActor
- Override BeginPlay(), EndPlay()

Public API (BlueprintCallable):
- `void EnterPredatorSilence(float FadeDuration = 2.0f)` -- fade all ambient to zero
- `void ExitPredatorSilence(float FadeDuration = 3.0f)` -- restore ambient from silence
- `bool IsSilenced() const` -- query predator silence state

Protected properties (EditAnywhere):
- `TSoftObjectPtr<USoundBase> AmbientBedSound` -- looping ambient bed
- `TArray<TSoftObjectPtr<USoundBase>> EnvironmentalOneShotSounds` -- pool of random one-shots
- `FVector2D OneShotIntervalRange = FVector2D(5.0f, 20.0f)` -- min/max seconds between one-shots
- `float AmbientBedVolume = 0.5f` -- base volume for ambient bed
- `float OneShotVolumeRange = 0.3f` -- volume variance for one-shots (+/- from 0.5)
- `TObjectPtr<USoundAttenuation> OneShotAttenuation` -- optional attenuation for 3D one-shots

Constructor: Create a default USceneComponent as root.

**Implementation (AmbientAudioManager.cpp):**

BeginPlay():
1. Super::BeginPlay()
2. Create AmbientBedComp via NewObject<UAudioComponent>(this). Attach to root. bAutoActivate=false, bAutoDestroy=false, bIsUISound=true (non-spatial ambient bed). RegisterComponent().
3. Load AmbientBedSound. If valid, SetSound, Play at AmbientBedVolume.
4. ScheduleNextOneShot() to start the random one-shot timer

Private members:
- `TObjectPtr<UAudioComponent> AmbientBedComp`
- `FTimerHandle OneShotTimerHandle`
- `bool bIsSilenced = false`

PlayRandomOneShot():
1. If EnvironmentalOneShotSounds is empty, schedule next and return
2. Pick random index: FMath::RandRange(0, Num-1)
3. Load the TSoftObjectPtr at that index. If null, schedule next and return
4. Play as 3D sound at a random offset from this actor's location (or as 2D if no attenuation set):
   - If OneShotAttenuation: PlaySoundAtLocation with random position offset within ~500cm of manager actor location
   - If no attenuation: Play as 2D via UGameplayStatics::PlaySound2D
5. Random volume: FMath::FRandRange(0.5f - OneShotVolumeRange, 0.5f + OneShotVolumeRange)
6. ScheduleNextOneShot()

ScheduleNextOneShot():
1. float Interval = FMath::FRandRange(OneShotIntervalRange.X, OneShotIntervalRange.Y)
2. GetWorld()->GetTimerManager().SetTimer(OneShotTimerHandle, this, &AAmbientAudioManager::PlayRandomOneShot, Interval, false)

EnterPredatorSilence(FadeDuration):
1. bIsSilenced = true
2. If AmbientBedComp && AmbientBedComp->IsPlaying(): FadeOut(FadeDuration, 0.0f)
3. Clear one-shot timer (silence includes stopping random sounds)

ExitPredatorSilence(FadeDuration):
1. bIsSilenced = false
2. If AmbientBedComp: FadeIn(FadeDuration, AmbientBedVolume, 0.0f)
3. ScheduleNextOneShot() to resume random one-shots

EndPlay():
1. GetWorld()->GetTimerManager().ClearTimer(OneShotTimerHandle)
2. If AmbientBedComp, stop it
3. Super::EndPlay()

**No Tick needed** -- all timer-driven.
  </action>
  <verify>
Project compiles. Verify:
1. AAmbientAudioManager can be placed in a level (is an AActor)
2. No missing includes
3. Timer and audio component creation logic compiles
  </verify>
  <done>AmbientAudioManager plays continuous ambient bed, randomized one-shots on timer, supports predator silence fade-in/out API. No Tick overhead.</done>
</task>

</tasks>

<verification>
1. Project compiles with zero errors after all four files added
2. EMusicIntensity enum usable in Blueprint
3. MusicTensionSystem binds to OnAlertLevelChanged and OnBehaviorStateChanged
4. AmbientAudioManager is an actor placeable in levels
5. Both systems are timer/delegate-driven (no Tick)
6. Predator silence API is callable from Blueprint
</verification>

<success_criteria>
- MusicTensionSystem.h/.cpp compile with 3-layer crossfade driven by alert level
- Stinger playback triggers on Chasing/Searching/GrabAttack state transitions
- AmbientAudioManager.h/.cpp compile with ambient bed + random one-shots
- EnterPredatorSilence/ExitPredatorSilence are BlueprintCallable
- No Tick functions on either system
- All sound references use TSoftObjectPtr
</success_criteria>

<output>
After completion, create `.planning/phases/06-light-and-audio/06-03-SUMMARY.md`
</output>
