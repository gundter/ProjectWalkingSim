---
phase: 06-light-and-audio
plan: 05
type: execute
wave: 2
depends_on: ["06-01", "06-02", "06-03", "06-04"]
files_modified:
  - Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
  - Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
  - Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
  - Source/ProjectWalkingSim/Private/AI/WendigoCharacter.cpp
  - Source/ProjectWalkingSim/Public/Lighting/FlashlightComponent.h
  - Source/ProjectWalkingSim/Private/Lighting/FlashlightComponent.cpp
autonomous: false

must_haves:
  truths:
    - "SereneCharacter owns FlashlightComponent and PlayerAudioComponent created in constructor"
    - "WendigoCharacter owns MonsterAudioComponent and MusicTensionSystem created in constructor"
    - "Flashlight periodic trace detects Wendigo in beam cone and raises suspicion"
    - "All Phase 6 systems are wired and compile as a complete unit"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Player/SereneCharacter.h"
      provides: "FlashlightComponent + PlayerAudioComponent UPROPERTY declarations"
      contains: "FlashlightComponent"
    - path: "Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp"
      provides: "CreateDefaultSubobject for both new components"
      contains: "CreateDefaultSubobject<UFlashlightComponent>"
    - path: "Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h"
      provides: "MonsterAudioComponent + MusicTensionSystem UPROPERTY declarations"
      contains: "MonsterAudioComponent"
    - path: "Source/ProjectWalkingSim/Private/AI/WendigoCharacter.cpp"
      provides: "CreateDefaultSubobject for both audio components"
      contains: "CreateDefaultSubobject<UMonsterAudioComponent>"
    - path: "Source/ProjectWalkingSim/Private/Lighting/FlashlightComponent.cpp"
      provides: "Periodic cone trace for Wendigo detection"
      contains: "FlashlightDetectionTrace"
  key_links:
    - from: "SereneCharacter.cpp"
      to: "FlashlightComponent"
      via: "CreateDefaultSubobject in constructor"
      pattern: "CreateDefaultSubobject<UFlashlightComponent>"
    - from: "SereneCharacter.cpp"
      to: "PlayerAudioComponent"
      via: "CreateDefaultSubobject in constructor"
      pattern: "CreateDefaultSubobject<UPlayerAudioComponent>"
    - from: "WendigoCharacter.cpp"
      to: "MonsterAudioComponent"
      via: "CreateDefaultSubobject in constructor"
      pattern: "CreateDefaultSubobject<UMonsterAudioComponent>"
    - from: "FlashlightComponent.cpp"
      to: "SuspicionComponent"
      via: "Periodic trace reports flashlight detection as visual stimulus"
      pattern: "ProcessSightStimulus\\|SetStimulusLocation"
---

<objective>
Wire all Phase 6 components into character classes, add flashlight-to-AI detection, and verify the complete system compiles and functions.

Purpose: This plan connects all independently-built systems (Plans 01-04) into the character actors. FlashlightComponent and PlayerAudioComponent are added to SereneCharacter. MonsterAudioComponent and MusicTensionSystem are added to WendigoCharacter. The flashlight beam detection feature (CONTEXT: "shining at or near the Wendigo draws its attention") is implemented as a periodic cone trace.

Output: Modified character headers/implementations, enhanced FlashlightComponent with AI detection. Full system compiles. PIE-verifiable.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-light-and-audio/06-RESEARCH.md
@.planning/phases/06-light-and-audio/06-CONTEXT.md
@.planning/phases/06-light-and-audio/06-01-SUMMARY.md
@.planning/phases/06-light-and-audio/06-02-SUMMARY.md
@.planning/phases/06-light-and-audio/06-03-SUMMARY.md
@.planning/phases/06-light-and-audio/06-04-SUMMARY.md
@Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
@Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
@Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
@Source/ProjectWalkingSim/Private/AI/WendigoCharacter.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire components into character classes</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
    Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
    Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
    Source/ProjectWalkingSim/Private/AI/WendigoCharacter.cpp
  </files>
  <action>
Add Phase 6 components to both character classes following the established pattern (forward declare in header, CreateDefaultSubobject in constructor).

**SereneCharacter.h changes:**
1. Add forward declarations at top:
   - `class UFlashlightComponent;`
   - `class UPlayerAudioComponent;`
2. Add UPROPERTY members in a new "Phase 06 Components" section (after Phase 04 section):
```cpp
// --- Phase 06 Components ---

/** Flashlight spotlight attached to camera. Always on for demo. */
UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components")
TObjectPtr<UFlashlightComponent> FlashlightComponent;

/** Player footstep audio + heartbeat proximity system. */
UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components")
TObjectPtr<UPlayerAudioComponent> PlayerAudioComponent;
```
3. Update the class doc comment to list the two new components (increment count from 10 to 12 total)

**SereneCharacter.cpp changes:**
1. Add includes:
   - `#include "Lighting/FlashlightComponent.h"`
   - `#include "Audio/PlayerAudioComponent.h"`
2. In constructor, after NoiseReportingComponent creation:
```cpp
// ---- Phase 06: Flashlight and Audio ----
FlashlightComponent = CreateDefaultSubobject<UFlashlightComponent>(
    TEXT("FlashlightComponent"));

PlayerAudioComponent = CreateDefaultSubobject<UPlayerAudioComponent>(
    TEXT("PlayerAudioComponent"));
```

**WendigoCharacter.h changes:**
1. Add forward declarations:
   - `class UMonsterAudioComponent;`
   - `class UMusicTensionSystem;`
2. Add UPROPERTY members after SuspicionComponent:
```cpp
/** Behavior-state-driven spatial audio: breathing, footsteps, vocalizations. */
UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Audio")
TObjectPtr<UMonsterAudioComponent> MonsterAudioComponent;

/** Dynamic music system driven by alert level. */
UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Audio")
TObjectPtr<UMusicTensionSystem> MusicTensionSystem;
```
3. Add public getter:
```cpp
/** Get the music tension system for external binding. */
UFUNCTION(BlueprintCallable, Category = "Audio")
UMusicTensionSystem* GetMusicTensionSystem() const { return MusicTensionSystem; }
```

**WendigoCharacter.cpp changes:**
1. Add includes:
   - `#include "Audio/MonsterAudioComponent.h"`
   - `#include "Audio/MusicTensionSystem.h"`
2. In constructor, after SuspicionComponent:
```cpp
// ---- Phase 06: Audio ----
MonsterAudioComponent = CreateDefaultSubobject<UMonsterAudioComponent>(
    TEXT("MonsterAudioComponent"));

MusicTensionSystem = CreateDefaultSubobject<UMusicTensionSystem>(
    TEXT("MusicTensionSystem"));
```

**NOTE on MusicTensionSystem placement:** Placing MusicTensionSystem on the Wendigo is fine for the demo (single level, single Wendigo). It auto-binds to its owning Wendigo's SuspicionComponent in BeginPlay. If multiple Wendigos are needed later, this should move to a world subsystem or GameMode. For now, the Wendigo-owned approach is simplest and avoids a separate manager actor.
  </action>
  <verify>
Project compiles with both character files modified. Run full build:
1. No linker errors from new includes
2. No UHT errors from new UPROPERTY declarations
3. CreateDefaultSubobject calls compile (UFlashlightComponent, UPlayerAudioComponent, UMonsterAudioComponent, UMusicTensionSystem all have GENERATED_BODY)
  </verify>
  <done>Both character classes own their Phase 6 components. Components auto-initialize in BeginPlay via their own internal logic. All delegate bindings happen automatically.</done>
</task>

<task type="auto">
  <name>Task 2: Add flashlight-to-AI detection</name>
  <files>
    Source/ProjectWalkingSim/Public/Lighting/FlashlightComponent.h
    Source/ProjectWalkingSim/Private/Lighting/FlashlightComponent.cpp
  </files>
  <action>
Add a periodic cone trace to FlashlightComponent that detects when the flashlight beam is shining on or near the Wendigo, reporting it as a visual stimulus to the Wendigo's SuspicionComponent.

**FlashlightComponent.h additions:**
1. Add forward declaration: `class AWendigoCharacter;`
2. Add private members:
```cpp
/** Timer for periodic Wendigo detection check. */
FTimerHandle DetectionTimerHandle;

/** Cached Wendigo reference for detection checks. */
TWeakObjectPtr<AWendigoCharacter> CachedWendigo;
```
3. Add private methods:
```cpp
/** Periodic check: is the flashlight beam hitting the Wendigo? */
void FlashlightDetectionTrace();

/** Find the Wendigo in the world (lazy cache). */
void FindWendigo();
```
4. Add tuning properties (EditAnywhere, Category = "Flashlight|Detection"):
```cpp
/** Half-angle (degrees) of the detection cone. Should be <= OuterConeAngle. */
UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Flashlight|Detection")
float DetectionHalfAngle = 15.0f;

/** Range (cm) of the detection trace. */
UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Flashlight|Detection")
float DetectionRange = 1500.0f;

/** Interval (seconds) between detection checks. */
UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Flashlight|Detection")
float DetectionInterval = 0.5f;
```

**FlashlightComponent.cpp additions:**

In BeginPlay(), after SpotLight setup, add:
```cpp
// Start periodic Wendigo detection
GetWorld()->GetTimerManager().SetTimer(
    DetectionTimerHandle, this,
    &UFlashlightComponent::FlashlightDetectionTrace,
    DetectionInterval, true, DetectionInterval);
```

Add EndPlay() override:
```cpp
void UFlashlightComponent::EndPlay(const EEndPlayReason::Type Reason)
{
    GetWorld()->GetTimerManager().ClearTimer(DetectionTimerHandle);
    Super::EndPlay(Reason);
}
```

FlashlightDetectionTrace():
1. If !SpotLight, return
2. FindWendigo() if CachedWendigo not valid
3. If CachedWendigo not valid, return
4. Get flashlight forward direction: SpotLight->GetForwardVector()
5. Get flashlight world location: SpotLight->GetComponentLocation()
6. Get direction to Wendigo: (Wendigo->GetActorLocation() - FlashlightLocation).GetSafeNormal()
7. Get distance to Wendigo
8. If distance > DetectionRange, return (too far)
9. Calculate angle: FMath::Acos(FVector::DotProduct(FlashlightForward, DirectionToWendigo))
10. Convert to degrees. If angle > FMath::DegreesToRadians(DetectionHalfAngle), return (outside cone)
11. Optional: do a line trace to check for occlusion (walls between flashlight and Wendigo):
    - FHitResult Hit
    - GetWorld()->LineTraceSingleByChannel(Hit, FlashlightLocation, Wendigo->GetActorLocation(), ECC_Visibility)
    - If Hit.GetActor() != Wendigo, return (blocked by wall)
12. If all checks pass, report to Wendigo's suspicion system:
    - USuspicionComponent* Suspicion = CachedWendigo->GetSuspicionComponent()
    - If Suspicion: call Suspicion->SetStimulusLocation(GetOwner()->GetActorLocation()) and Suspicion->ProcessSightStimulus(1.0f, DetectionInterval) -- full visibility equivalent
    - This treats the flashlight beam as equivalent to being fully visible to the Wendigo
    - Log at Verbose: "Flashlight detected Wendigo at distance X"

FindWendigo():
1. TArray<AActor*> Wendigos
2. UGameplayStatics::GetAllActorsOfClass(GetWorld(), AWendigoCharacter::StaticClass(), Wendigos)
3. If Wendigos.Num() > 0: CachedWendigo = Cast<AWendigoCharacter>(Wendigos[0])

**Includes needed in .cpp (additional):**
- AI/WendigoCharacter.h
- AI/SuspicionComponent.h
- Kismet/GameplayStatics.h
- Audio/AudioConstants.h (for detection interval defaults if used)

**Performance:** This runs every 0.5s, does 1 angle check and potentially 1 line trace. Negligible cost.
  </action>
  <verify>
Project compiles. Verify:
1. FlashlightDetectionTrace compiles with cone angle math
2. Line trace channel ECC_Visibility is correct
3. SuspicionComponent method calls match existing API
4. Timer setup and cleanup compile
  </verify>
  <done>Flashlight beam detects Wendigo via periodic cone trace + LOS check, reports as visual stimulus to SuspicionComponent. "Shining at the Wendigo draws its attention" feature complete.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
All Phase 6 atmosphere systems:
1. FlashlightComponent -- narrow spotlight on player camera with Lumen GI bounce
2. MonsterAudioComponent -- behavior-state-driven breathing, footsteps, vocalizations (3D spatial)
3. MusicTensionSystem -- 3-layer crossfade music driven by alert level, stingers on state transitions
4. AmbientAudioManager -- continuous ambient bed + randomized one-shots + predator silence API
5. PlayerAudioComponent -- surface-aware footstep playback + heartbeat proximity to Wendigo
6. Flashlight->AI detection -- periodic cone trace raises Wendigo suspicion when beam hits it
7. All components wired into SereneCharacter and WendigoCharacter
  </what-built>
  <how-to-verify>
1. Open the project in Unreal Editor. Confirm it compiles and opens without errors.
2. Open BP_SereneCharacter -- verify FlashlightComponent and PlayerAudioComponent appear in Components panel.
3. Open BP_Wendigo -- verify MonsterAudioComponent and MusicTensionSystem appear in Components panel.
4. PIE test: Start play. The flashlight spotlight should be visible, casting a narrow beam from the camera. Look around and confirm the light beam follows camera rotation.
5. Look at the Output Log for any audio-related warnings (expected: "No sound set" warnings are normal until Phase 8 content provides actual sound assets).
6. Verify Lumen GI bounce: the flashlight beam should bounce light off surfaces realistically (bright spot on walls, some indirect illumination around it).
7. OPTIONAL (if Wendigo is placed in level): Walk near the Wendigo with flashlight aimed at it. Check Output Log for "Flashlight detected Wendigo" verbose log. Suspicion should begin to accumulate.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Full project compiles with zero errors
2. Both character Blueprints show new components in editor
3. Flashlight spotlight visible in PIE with Lumen GI bounce
4. No crashes on play
5. Flashlight detection trace fires periodically (check verbose log)
6. All audio components initialize without crashes (sound asset null warnings are expected)
</verification>

<success_criteria>
- SereneCharacter owns FlashlightComponent + PlayerAudioComponent (constructor-created)
- WendigoCharacter owns MonsterAudioComponent + MusicTensionSystem (constructor-created)
- Flashlight creates visible spotlight in PIE
- Flashlight detection trace detects Wendigo in beam cone
- All delegate bindings fire without crashes
- Project compiles and runs in PIE
</success_criteria>

<output>
After completion, create `.planning/phases/06-light-and-audio/06-05-SUMMARY.md`
</output>
