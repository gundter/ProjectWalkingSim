---
phase: 06-light-and-audio
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Source/ProjectWalkingSim/Public/Audio/MonsterAudioComponent.h
  - Source/ProjectWalkingSim/Private/Audio/MonsterAudioComponent.cpp
autonomous: true

must_haves:
  truths:
    - "MonsterAudioComponent transitions breathing audio when WendigoCharacter behavior state changes"
    - "Monster footsteps play as 3D spatialized audio at the Wendigo location on a timer"
    - "State-specific vocalizations play as one-shots on behavior state entry"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Audio/MonsterAudioComponent.h"
      provides: "UMonsterAudioComponent with per-state audio maps and timer-based footsteps"
      contains: "class UMonsterAudioComponent"
    - path: "Source/ProjectWalkingSim/Private/Audio/MonsterAudioComponent.cpp"
      provides: "Delegate binding, audio component creation, state transition logic"
      contains: "OnBehaviorStateChanged"
  key_links:
    - from: "MonsterAudioComponent.cpp"
      to: "AWendigoCharacter::OnBehaviorStateChanged"
      via: "AddDynamic delegate binding in BeginPlay"
      pattern: "OnBehaviorStateChanged\\.AddDynamic"
    - from: "MonsterAudioComponent.cpp"
      to: "UAudioComponent"
      via: "NewObject creation in BeginPlay"
      pattern: "NewObject<UAudioComponent>"
---

<objective>
Create MonsterAudioComponent -- a behavior-state-driven spatial audio component placed on the Wendigo that manages breathing, footsteps, and vocalizations.

Purpose: Delivers AUDO-01 (spatial 3D monster sounds) and AUDO-03 (monster audio cues per behavior state). The player can locate the Wendigo by sound. Each behavior state (Patrol, Investigating, Chasing, Searching, GrabAttack) has distinct audio profiles.

Output: MonsterAudioComponent.h/.cpp in Audio/. Compiles cleanly. No character file modifications yet (wiring happens in Plan 05).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-light-and-audio/06-RESEARCH.md
@.planning/phases/06-light-and-audio/06-CONTEXT.md
@Source/ProjectWalkingSim/Public/AI/WendigoCharacter.h
@Source/ProjectWalkingSim/Private/AI/WendigoCharacter.cpp
@Source/ProjectWalkingSim/Public/AI/MonsterAITypes.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MonsterAudioComponent header</name>
  <files>Source/ProjectWalkingSim/Public/Audio/MonsterAudioComponent.h</files>
  <action>
Create UMonsterAudioComponent in Public/Audio/.

**Class design:**
- Inherits UActorComponent
- UCLASS with ClassGroup=(AI), BlueprintSpawnableComponent
- Override BeginPlay() and EndPlay()

**Sound asset properties (all TSoftObjectPtr<USoundBase>, EditAnywhere):**
- `TMap<EWendigoBehaviorState, TSoftObjectPtr<USoundBase>> BreathingSounds` -- looping breathing per state
- `TSoftObjectPtr<USoundBase> FootstepSound` -- monster footstep (played at location)
- `TMap<EWendigoBehaviorState, TSoftObjectPtr<USoundBase>> VocalizationSounds` -- one-shot growl/sniff/roar per state

**Attenuation property:**
- `TObjectPtr<USoundAttenuation> MonsterAttenuation` -- 3D spatial settings (assigned in editor)

**Tuning properties (EditAnywhere):**
- `float BreathingCrossfadeDuration = 1.5f` (from AudioConstants)
- `float VocalizationChance = 0.6f` (chance to play vocalization on state change)

**Private members:**
- `TObjectPtr<UAudioComponent> BreathingAudioComp` -- persistent looping breathing
- `FTimerHandle FootstepTimerHandle` -- drives timer-based monster footsteps

**Private methods:**
- `UFUNCTION() void OnBehaviorStateChanged(EWendigoBehaviorState NewState)` -- delegate handler
- `void TransitionBreathingSound(EWendigoBehaviorState NewState)` -- crossfade breathing
- `void PlayMonsterFootstep()` -- play 3D positional footstep at owner location
- `void PlayVocalization(EWendigoBehaviorState State)` -- play one-shot vocalization
- `float GetFootstepInterval() const` -- returns interval based on current behavior state
- `void UpdateFootstepTimer()` -- restart timer with current interval

Include `AI/MonsterAITypes.h` for EWendigoBehaviorState. Forward declare UAudioComponent, USoundAttenuation.
  </action>
  <verify>Header parses without errors in UHT.</verify>
  <done>MonsterAudioComponent.h declares the full component API with per-state audio maps and spatial audio support.</done>
</task>

<task type="auto">
  <name>Task 2: Implement MonsterAudioComponent</name>
  <files>Source/ProjectWalkingSim/Private/Audio/MonsterAudioComponent.cpp</files>
  <action>
Implement all MonsterAudioComponent methods.

**Constructor:**
- PrimaryComponentTick disabled (no Tick needed -- all timer/delegate driven)

**BeginPlay():**
1. Super::BeginPlay()
2. Cast GetOwner() to AWendigoCharacter. If null, log warning and return.
3. Bind to Wendigo->OnBehaviorStateChanged.AddDynamic(this, &UMonsterAudioComponent::OnBehaviorStateChanged)
4. Create BreathingAudioComp via NewObject<UAudioComponent>(GetOwner()). Attach to owner root component. Set bAutoActivate=false, bAutoDestroy=false. If MonsterAttenuation is set, assign it. Call RegisterComponent().
5. Start initial state: call TransitionBreathingSound(EWendigoBehaviorState::Patrol) to begin patrol breathing
6. Start footstep timer: UpdateFootstepTimer()

**EndPlay():**
1. GetWorld()->GetTimerManager().ClearTimer(FootstepTimerHandle)
2. If BreathingAudioComp, stop it
3. Super::EndPlay()

**OnBehaviorStateChanged(NewState):**
1. TransitionBreathingSound(NewState)
2. PlayVocalization(NewState)
3. UpdateFootstepTimer() -- adjust footstep rate for new state

**TransitionBreathingSound(NewState):**
1. If BreathingSounds does not contain NewState, fade out current and return
2. Load the sound: `USoundBase* Sound = BreathingSounds[NewState].LoadSynchronous()`
3. If null, return with log warning
4. If BreathingAudioComp is currently playing, call FadeOut(BreathingCrossfadeDuration, 0.0f)
5. Set new sound: BreathingAudioComp->SetSound(Sound)
6. FadeIn(BreathingCrossfadeDuration, 1.0f, 0.0f)

**PlayMonsterFootstep():**
1. Load FootstepSound.LoadSynchronous(). If null, return.
2. UGameplayStatics::PlaySoundAtLocation(this, Sound, GetOwner()->GetActorLocation(), FRotator::ZeroRotator, 1.0f, 1.0f, 0.0f, MonsterAttenuation, nullptr, nullptr)
3. Do NOT call ReportNoiseEvent -- monster sounds are for the PLAYER, not AI hearing (research pitfall 7)

**PlayVocalization(State):**
1. If FMath::FRand() > VocalizationChance, skip (random chance)
2. Find sound in VocalizationSounds map for State. If not found, return.
3. Load synchronous. If null, return.
4. UGameplayStatics::PlaySoundAtLocation with MonsterAttenuation at owner location

**GetFootstepInterval():**
- Switch on the owning WendigoCharacter->BehaviorState:
  - Patrol: 0.8f
  - Investigating: 0.6f
  - Chasing: 0.35f
  - Searching: 0.7f
  - GrabAttack: 0.0f (no footsteps during grab)
- Use AudioConstants values where available, fallback to hardcoded

**UpdateFootstepTimer():**
1. Clear existing timer
2. float Interval = GetFootstepInterval()
3. If Interval <= 0, return (no footsteps for this state)
4. GetWorld()->GetTimerManager().SetTimer(FootstepTimerHandle, this, &UMonsterAudioComponent::PlayMonsterFootstep, Interval, true)

**Performance notes:**
- No Tick -- all event-driven (delegates) and timer-driven
- TSoftObjectPtr LoadSynchronous called once per state transition, not per frame
- Timer-based footsteps avoid per-frame overhead
  </action>
  <verify>
Project compiles successfully. No linker errors. Verify:
1. No warnings about unresolved delegates
2. No missing include errors
3. Timer and audio component creation logic compiles
  </verify>
  <done>MonsterAudioComponent fully implemented: breathing crossfades on state change, timer-based 3D footsteps, random vocalizations. All event-driven, no Tick overhead.</done>
</task>

</tasks>

<verification>
1. Project compiles with zero errors
2. MonsterAudioComponent binds to OnBehaviorStateChanged delegate
3. No Tick function -- all timer/delegate driven
4. 3D footsteps use PlaySoundAtLocation (not ReportNoiseEvent)
5. Sound assets are TSoftObjectPtr (not hard references)
</verification>

<success_criteria>
- MonsterAudioComponent.h/.cpp compile cleanly in Audio/ directory
- Component creates UAudioComponent for breathing in BeginPlay
- Behavior state delegate drives breathing crossfade + vocalization + footstep rate
- Monster footsteps are 3D spatialized via PlaySoundAtLocation with attenuation
- No AI self-hearing (no ReportNoiseEvent for monster sounds)
</success_criteria>

<output>
After completion, create `.planning/phases/06-light-and-audio/06-02-SUMMARY.md`
</output>
