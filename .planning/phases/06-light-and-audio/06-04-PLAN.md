---
phase: 06-light-and-audio
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - Source/ProjectWalkingSim/Public/Audio/PlayerAudioComponent.h
  - Source/ProjectWalkingSim/Private/Audio/PlayerAudioComponent.cpp
autonomous: true

must_haves:
  truths:
    - "Player footsteps play audible sound based on surface type when OnFootstep fires"
    - "Player heartbeat audio intensifies as distance to Wendigo decreases"
    - "Heartbeat proximity check runs on a timer (4Hz), not every frame"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Audio/PlayerAudioComponent.h"
      provides: "UPlayerAudioComponent with footstep playback and heartbeat proximity"
      contains: "class UPlayerAudioComponent"
    - path: "Source/ProjectWalkingSim/Private/Audio/PlayerAudioComponent.cpp"
      provides: "OnFootstep listener, proximity timer, distance-based heartbeat intensity"
      contains: "HandleFootstep"
  key_links:
    - from: "PlayerAudioComponent.cpp"
      to: "FootstepComponent::OnFootstep"
      via: "AddDynamic delegate binding in BeginPlay"
      pattern: "OnFootstep\\.AddDynamic"
    - from: "PlayerAudioComponent.cpp"
      to: "AWendigoCharacter"
      via: "GetAllActorsOfClass for proximity distance calculation"
      pattern: "GetAllActorsOfClass.*WendigoCharacter"
---

<objective>
Create PlayerAudioComponent -- handles player footstep sound playback (listening to existing OnFootstep delegate) and heartbeat proximity system (distance-based intensity scaling toward the Wendigo).

Purpose: Completes the player-side audio experience. Footstep sounds make player movement audible (surface-aware). Heartbeat gives the player an intensity indicator of monster proximity without revealing exact direction (that is the monster breathing's job via MonsterAudioComponent spatial audio). Together with Plan 02's MonsterAudioComponent, this delivers the "dual proximity cue" from CONTEXT.md.

Output: PlayerAudioComponent.h/.cpp in Audio/. Compiles cleanly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-light-and-audio/06-RESEARCH.md
@.planning/phases/06-light-and-audio/06-CONTEXT.md
@Source/ProjectWalkingSim/Public/Player/Components/FootstepComponent.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlayerAudioComponent header</name>
  <files>Source/ProjectWalkingSim/Public/Audio/PlayerAudioComponent.h</files>
  <action>
Create UPlayerAudioComponent in Public/Audio/.

**Class design:**
- Inherits UActorComponent
- UCLASS with ClassGroup=(Audio), BlueprintSpawnableComponent
- Override BeginPlay(), EndPlay()

**Footstep sound properties (EditAnywhere):**
- `TMap<TEnumAsByte<EPhysicalSurface>, TSoftObjectPtr<USoundBase>> FootstepSounds` -- surface-specific footstep sounds (Default, Wood, Metal, Dirt, etc.)
- `TSoftObjectPtr<USoundBase> DefaultFootstepSound` -- fallback when surface not in map
- `float FootstepBaseVolume = 0.6f` -- base volume multiplier

**Heartbeat properties (EditAnywhere):**
- `TSoftObjectPtr<USoundBase> HeartbeatSound` -- looping heartbeat (MetaSound with Intensity param)
- `float HeartbeatMaxDistance = 3000.0f` -- distance at which heartbeat starts (~30m)
- `float HeartbeatMinDistance = 500.0f` -- distance at which heartbeat is max intensity (~5m)
- `float HeartbeatUpdateRate = 4.0f` -- proximity check Hz
- `FName HeartbeatIntensityParam = FName("Intensity")` -- MetaSound parameter name

**Private members:**
- `TObjectPtr<UAudioComponent> HeartbeatAudioComp` -- non-spatialized (2D) heartbeat
- `FTimerHandle HeartbeatTimerHandle` -- proximity check timer
- `TWeakObjectPtr<AActor> CachedWendigo` -- cached Wendigo reference for distance checks

**Private methods:**
- `UFUNCTION() void HandleFootstep(EPhysicalSurface SurfaceType, float Volume)` -- delegate handler
- `void UpdateHeartbeatProximity()` -- timer callback, checks distance and sets param
- `void FindWendigo()` -- locates Wendigo in world, caches reference
  </action>
  <verify>Header parses without UHT errors.</verify>
  <done>PlayerAudioComponent.h declares footstep playback and heartbeat proximity system with clear integration points.</done>
</task>

<task type="auto">
  <name>Task 2: Implement PlayerAudioComponent</name>
  <files>Source/ProjectWalkingSim/Private/Audio/PlayerAudioComponent.cpp</files>
  <action>
Implement all PlayerAudioComponent methods.

**Constructor:**
- PrimaryComponentTick disabled (no Tick)

**BeginPlay():**
1. Super::BeginPlay()
2. Find and bind to FootstepComponent on owner:
   - `UFootstepComponent* FootstepComp = GetOwner()->FindComponentByClass<UFootstepComponent>()`
   - If found: FootstepComp->OnFootstep.AddDynamic(this, &UPlayerAudioComponent::HandleFootstep)
   - If not found: log warning
3. Create HeartbeatAudioComp:
   - NewObject<UAudioComponent>(GetOwner())
   - Attach to owner root
   - bAutoActivate=false, bAutoDestroy=false
   - bIsUISound=true (non-spatialized, 2D heartbeat is a player-internal sound)
   - RegisterComponent()
   - Load HeartbeatSound. If valid, SetSound and Play (starts silent -- Intensity param at 0)
4. Start heartbeat timer:
   - float Interval = 1.0f / HeartbeatUpdateRate (0.25s at 4Hz)
   - SetTimer(HeartbeatTimerHandle, this, &UPlayerAudioComponent::UpdateHeartbeatProximity, Interval, true)
5. FindWendigo() -- cache initial reference

**HandleFootstep(SurfaceType, Volume):**
1. Look up SurfaceType in FootstepSounds map
2. If not found, use DefaultFootstepSound
3. Load the TSoftObjectPtr. If null, return.
4. Play at owner location as 2D sound (player hears their own footsteps non-spatially):
   - UGameplayStatics::PlaySound2D(this, Sound, FootstepBaseVolume * Volume)
5. Volume parameter from FootstepComponent already accounts for sprint/crouch multipliers

**UpdateHeartbeatProximity():**
1. If CachedWendigo is not valid, call FindWendigo(). If still not valid, set intensity to 0 and return.
2. float Distance = FVector::Dist(GetOwner()->GetActorLocation(), CachedWendigo->GetActorLocation())
3. Normalize distance to intensity:
   - If Distance >= HeartbeatMaxDistance: Intensity = 0.0f (too far, no heartbeat)
   - If Distance <= HeartbeatMinDistance: Intensity = 1.0f (maximum panic)
   - Else: Intensity = 1.0f - ((Distance - HeartbeatMinDistance) / (HeartbeatMaxDistance - HeartbeatMinDistance))
4. If HeartbeatAudioComp:
   - HeartbeatAudioComp->SetFloatParameter(HeartbeatIntensityParam, Intensity)
   - If Intensity > 0 and not playing: Play()
   - If Intensity <= 0 and playing: consider keeping it playing at 0 intensity (avoid start/stop pops)

**FindWendigo():**
1. TArray<AActor*> Wendigos
2. UGameplayStatics::GetAllActorsOfClass(GetWorld(), AWendigoCharacter::StaticClass(), Wendigos)
3. If Wendigos.Num() > 0: CachedWendigo = Wendigos[0]

**EndPlay():**
1. GetWorld()->GetTimerManager().ClearTimer(HeartbeatTimerHandle)
2. If HeartbeatAudioComp, Stop()
3. Super::EndPlay()

**Includes needed in .cpp:**
- PlayerAudioComponent.h
- Player/Components/FootstepComponent.h (for delegate binding)
- AI/WendigoCharacter.h (for proximity check -- forward declare in header, include in cpp)
- Kismet/GameplayStatics.h
- Components/AudioComponent.h

**NOTE:** This plan does NOT depend on AudioConstants.h at compile time. The default property values (0.6f, 3000.0f, 500.0f, 4.0f) are hardcoded inline in the header as UPROPERTY defaults. AudioConstants values are available for reference but not #included -- keeping this plan independent allows Wave 1 parallel execution.
  </action>
  <verify>
Project compiles. Verify:
1. Delegate binding to OnFootstep matches signature (EPhysicalSurface, float)
2. No circular include issues between Player and Audio modules
3. Timer creation compiles
4. SetFloatParameter call compiles
  </verify>
  <done>PlayerAudioComponent plays surface-aware footstep sounds and drives heartbeat intensity based on Wendigo proximity. Timer-based proximity (4Hz), no Tick.</done>
</task>

</tasks>

<verification>
1. Project compiles with zero errors
2. HandleFootstep signature matches FOnFootstep delegate (EPhysicalSurface, float)
3. Heartbeat proximity uses timer (4Hz), not Tick
4. Heartbeat is 2D (bIsUISound=true), footsteps are 2D (PlaySound2D)
5. All sound references use TSoftObjectPtr
6. CachedWendigo uses TWeakObjectPtr for safety
</verification>

<success_criteria>
- PlayerAudioComponent.h/.cpp compile cleanly
- Footstep sounds play per surface type via OnFootstep delegate
- Heartbeat scales 0-1 based on distance to Wendigo
- Proximity check runs at 4Hz on timer, not per-frame
- No Tick overhead
- No compile-time dependency on AudioConstants.h (can build in Wave 1)
</success_criteria>

<output>
After completion, create `.planning/phases/06-light-and-audio/06-04-SUMMARY.md`
</output>
