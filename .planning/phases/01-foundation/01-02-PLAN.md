---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
  - Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
  - Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
  - Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
  - Source/ProjectWalkingSim/Public/Core/SereneGameMode.h
  - Source/ProjectWalkingSim/Private/Core/SereneGameMode.cpp
autonomous: true

must_haves:
  truths:
    - "Player spawns in first-person view with visible body when looking down"
    - "Player can walk with WASD and look with mouse"
    - "Player can sprint by holding Shift (speed increases to ~500)"
    - "Player can crouch by pressing Ctrl (capsule shrinks, speed reduces)"
    - "Camera is attached to head bone and follows animations"
    - "Player body casts shadow via WorldRepresentationMesh"
    - "Camera pitch is clamped to prevent extreme angles"
    - "No jump is possible (disabled)"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Player/SereneCharacter.h"
      provides: "ACharacter subclass with FP rendering, camera, component slots"
      contains: "ASereneCharacter"
    - path: "Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h"
      provides: "Player controller with Enhanced Input mapping context and input actions"
      contains: "ASerenePlayerController"
    - path: "Source/ProjectWalkingSim/Public/Core/SereneGameMode.h"
      provides: "GameMode configured with SereneCharacter and SerenePlayerController defaults"
      contains: "ASereneGameMode"
  key_links:
    - from: "SerenePlayerController"
      to: "SereneCharacter"
      via: "Enhanced Input actions bound to character movement"
      pattern: "AddMovementInput|AddControllerYawInput"
    - from: "SereneCharacter constructor"
      to: "UCameraComponent"
      via: "Camera attached to head bone with FP rendering"
      pattern: "SetupAttachment.*head|bUseFirstPersonFieldOfView"
    - from: "SereneCharacter GetMesh()"
      to: "EFirstPersonPrimitiveType"
      via: "First Person Rendering pipeline"
      pattern: "SetFirstPersonPrimitiveType|FirstPerson"
    - from: "SereneGameMode"
      to: "SereneCharacter + SerenePlayerController"
      via: "DefaultPawnClass and PlayerControllerClass"
      pattern: "DefaultPawnClass|PlayerControllerClass"
---

<objective>
Core character with first-person rendering and Enhanced Input. Player can walk, look, sprint, and crouch in first person with a visible body.

Purpose: This is the central actor that all components attach to. Without the character and input working, no other gameplay system can function.

Output: ASereneCharacter with UE5 First Person Rendering (visible body + shadow mesh), UCameraComponent on head bone, movement via UCharacterMovementComponent (walk/sprint/crouch, no jump). ASerenePlayerController with Enhanced Input actions and mapping context. Updated ASereneGameMode pointing to both.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/codebase/CONVENTIONS.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SereneCharacter with First Person Rendering and movement configuration</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
    Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
  </files>
  <action>
    Create ASereneCharacter : public ACharacter with the following:

    **Header (.h):**
    - Forward declare all component classes (UStaminaComponent, UHeadBobComponent, UInteractionComponent, ULeanComponent, UFootstepComponent) but do NOT create them yet. Leave TObjectPtr declarations with comments "// Created in Plan 03/04/05"
    - UCameraComponent* FirstPersonCamera (VisibleAnywhere, BlueprintReadOnly, Category="Camera")
    - USkeletalMeshComponent* WorldRepresentationMesh (VisibleAnywhere, BlueprintReadOnly, Category="Mesh")
    - Movement state tracking:
      - bool bIsSprinting (replicated-ready, not replicated yet)
      - bool bIsCrouching (track separately from CMC for component notifications)
      - float WalkSpeed = 250.0f (EditDefaultsOnly)
      - float SprintSpeed = 500.0f (EditDefaultsOnly)
    - Public functions:
      - bool GetIsSprinting() const
      - void StartSprint() / StopSprint() -- will be called by PlayerController
      - void StartCrouching() / StopCrouching() -- wraps ACharacter::Crouch()/UnCrouch()
    - Override SetupPlayerInputComponent (empty for now -- input is on controller)
    - Override BeginPlay

    **Implementation (.cpp):**
    - Constructor:
      - Create FirstPersonCamera, attach to GetMesh() at "head" bone socket
      - FirstPersonCamera->bUsePawnControlRotation = true
      - FirstPersonCamera->bUseFirstPersonFieldOfView = true
      - FirstPersonCamera->bUseFirstPersonScale = true
      - GetMesh()->SetFirstPersonPrimitiveType(EFirstPersonPrimitiveType::FirstPerson)
      - Create WorldRepresentationMesh as USkeletalMeshComponent
      - WorldRepresentationMesh->SetupAttachment(GetMesh())
      - WorldRepresentationMesh->SetFirstPersonPrimitiveType(EFirstPersonPrimitiveType::WorldSpaceRepresentation)
      - WorldRepresentationMesh->SetLeaderPoseComponent(GetMesh())
      - Configure UCharacterMovementComponent (from GetCharacterMovement()):
        - MaxWalkSpeed = 250.0f (WalkSpeed)
        - MaxWalkSpeedCrouched = 130.0f
        - MaxAcceleration = 1200.0f
        - BrakingDecelerationWalking = 1400.0f
        - GroundFriction = 6.0f
        - BrakingFrictionFactor = 1.0f
        - NavAgentProps.bCanCrouch = true
        - CrouchedHalfHeight = 44.0f
        - JumpZVelocity = 0.0f
        - NavAgentProps.bCanJump = false
        - AirControl = 0.0f
      - bUseControllerRotationYaw = true
      - bUseControllerRotationPitch = false (camera handles pitch)
      - bUseControllerRotationRoll = false

    - StartSprint(): Set MaxWalkSpeed to SprintSpeed, set bIsSprinting=true. Only if not crouching and movement velocity > 0. Log with LogSerene.
    - StopSprint(): Restore MaxWalkSpeed to WalkSpeed, set bIsSprinting=false.
    - StartCrouching(): Call Crouch(). If currently sprinting, call StopSprint() first. Set bIsCrouching=true.
    - StopCrouching(): Call UnCrouch(). Set bIsCrouching=false.

    IMPORTANT: Do NOT attach camera to a spring arm. Attach directly to mesh head bone. This is first-person, not third-person.
    IMPORTANT: Include "Core/SereneLogChannels.h" and use UE_LOG(LogSerene, ...) not UE_LOG(LogTemp, ...).
    IMPORTANT: For the camera attachment to head bone, use FName(TEXT("head")) -- this is the standard UE5 mannequin head bone name. If the mesh is not set, the camera should fall back to RootComponent attachment with a warning log.
  </action>
  <verify>
    Project compiles. ASereneCharacter class appears in editor class browser. Camera component visible in component hierarchy when placing character in level.
  </verify>
  <done>
    ASereneCharacter compiles with FP camera on head bone, WorldRepresentationMesh for shadows, CMC configured for horror-weight movement (250 walk, 500 sprint, 130 crouch, no jump), sprint/crouch state management methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SerenePlayerController with Enhanced Input and update GameMode</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
    Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
    Source/ProjectWalkingSim/Public/Core/SereneGameMode.h
    Source/ProjectWalkingSim/Private/Core/SereneGameMode.cpp
  </files>
  <action>
    **SerenePlayerController (.h):**
    - ASerenePlayerController : public APlayerController
    - Protected UPROPERTY(EditDefaultsOnly, Category="Input"):
      - TObjectPtr of UInputMappingContext DefaultMappingContext
      - TObjectPtr of UInputAction: MoveAction (Axis2D: WASD), LookAction (Axis2D: Mouse), SprintAction (Bool: Shift hold), CrouchAction (Bool: Ctrl), InteractAction (Bool: E tap), LeanLeftAction (Bool: Q hold), LeanRightAction (Bool: E hold)
    - Note in comment: InteractAction (E press/tap) and LeanRightAction (E hold) share the E key. Differentiated by Enhanced Input triggers (Pressed vs Hold with 0.2s threshold). This is configured in the IMC data asset, not in C++.
    - Override BeginPlay
    - Override SetupInputComponent

    **SerenePlayerController (.cpp):**
    - BeginPlay:
      - Get UEnhancedInputLocalPlayerSubsystem via ULocalPlayer
      - AddMappingContext(DefaultMappingContext, 0) -- priority 0
      - Set input mode to game only
      - Log mapping context addition with LogSerene

    - SetupInputComponent:
      - Cast InputComponent to UEnhancedInputComponent
      - Bind MoveAction (ETriggerEvent::Triggered) -> HandleMove (Axis2D)
      - Bind LookAction (ETriggerEvent::Triggered) -> HandleLook (Axis2D)
      - Bind SprintAction (ETriggerEvent::Triggered) -> HandleSprintStart
      - Bind SprintAction (ETriggerEvent::Completed) -> HandleSprintStop
      - Bind CrouchAction (ETriggerEvent::Started) -> HandleCrouchToggle (default toggle mode)
      - Bind InteractAction (ETriggerEvent::Started) -> HandleInteract
      - Bind LeanLeftAction (ETriggerEvent::Triggered) -> HandleLeanLeftStart
      - Bind LeanLeftAction (ETriggerEvent::Completed) -> HandleLeanLeftStop
      - Bind LeanRightAction (ETriggerEvent::Triggered) -> HandleLeanRightStart
      - Bind LeanRightAction (ETriggerEvent::Completed) -> HandleLeanRightStop

    - HandleMove: Get controlled pawn as ASereneCharacter, call AddMovementInput with forward/right vectors from controller rotation
    - HandleLook: AddControllerYawInput(Value.X * sensitivity), AddControllerPitchInput(Value.Y * sensitivity). Clamp pitch via PlayerCameraManager->ViewPitchMin = -80, ViewPitchMax = 80.
    - HandleSprintStart/Stop: Get ASereneCharacter, call StartSprint()/StopSprint()
    - HandleCrouchToggle: Get ASereneCharacter, toggle crouch state. Check SereneGameInstance for bCrouchToggleMode. If toggle mode: flip crouch state. If hold mode: bind differently (Started=start, Completed=stop). For initial implementation, default to toggle.
    - HandleInteract: Get InteractionComponent from character, call TryInteract(). For now, log "Interact pressed" since InteractionComponent doesn't exist yet.
    - HandleLeanLeft/RightStart/Stop: Get LeanComponent from character, call SetLeanLeft(true/false) or SetLeanRight(true/false). For now, log "Lean" since LeanComponent doesn't exist yet.

    **Move existing SereneGameMode from Public/SereneGameMode.h to Public/Core/SereneGameMode.h:**
    - Move the header to Public/Core/ and the cpp to Private/Core/
    - Update include paths
    - Set in constructor:
      - DefaultPawnClass = ASereneCharacter::StaticClass()
      - PlayerControllerClass = ASerenePlayerController::StaticClass()
    - Include the character and controller headers

    IMPORTANT: Include "EnhancedInputComponent.h", "EnhancedInputSubsystems.h", "InputActionValue.h" for Enhanced Input.
    IMPORTANT: The Input Action and Input Mapping Context assets are DATA ASSETS created in the Unreal Editor (Content/Input/). C++ code only references them via TObjectPtr properties. The actual key bindings (WASD, Mouse, Shift, etc.) are configured in those data assets, not in C++. Document this clearly in a comment: "// Assign IA_ and IMC_ assets in the BP subclass or via DefaultObject"
    IMPORTANT: HandleMove must decompose the 2D axis value into forward (X) and right (Y) movement relative to the controller's yaw rotation. Use GetControlRotation(), extract yaw only, get forward/right vectors from that rotation.
  </action>
  <verify>
    Project compiles. Place ASereneCharacter in test level. Set GameMode to use ASereneGameMode. Enter PIE -- character spawns in first person. WASD moves (if input assets are assigned), mouse looks around with clamped pitch.
  </verify>
  <done>
    ASerenePlayerController compiles with all Enhanced Input action bindings. HandleMove uses controller rotation for directional movement. HandleLook applies mouse with pitch clamp. Sprint/crouch call through to character methods. Interact and lean are stubbed with log messages. GameMode defaults to SereneCharacter + SerenePlayerController. GameMode files relocated to Core/ directory.
  </done>
</task>

</tasks>

<verification>
1. Project compiles with zero errors
2. ASereneCharacter visible in editor class picker, has camera component attached to head bone
3. WorldRepresentationMesh component visible in character's component list
4. ASerenePlayerController has Input Action property slots in Details panel
5. ASereneGameMode defaults to SereneCharacter and SerenePlayerController
6. In PIE with mannequin mesh assigned: player sees body when looking down, body casts shadow
7. WASD moves character, mouse rotates view, pitch clamped at +/-80 degrees
8. Shift triggers sprint speed change, Ctrl toggles crouch
</verification>

<success_criteria>
- First-person character with visible body renders correctly via UE5 First Person Rendering
- Movement feels grounded: 250 walk, 500 sprint, 130 crouch, no jump
- Camera tracks head bone and responds to controller rotation
- All input bindings compile (functional when data assets are assigned in editor)
- Sprint and crouch state management works correctly (no crouch-sprint)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
