---
phase: 01-foundation
plan: 05
type: execute
wave: 4
depends_on: ["01-03", "01-04"]
files_modified:
  - Source/ProjectWalkingSim/Public/Player/Components/FootstepComponent.h
  - Source/ProjectWalkingSim/Private/Player/Components/FootstepComponent.cpp
  - Source/ProjectWalkingSim/Public/Player/HUD/StaminaBarWidget.h
  - Source/ProjectWalkingSim/Private/Player/HUD/StaminaBarWidget.cpp
  - Source/ProjectWalkingSim/Public/Player/HUD/SereneHUD.h
  - Source/ProjectWalkingSim/Private/Player/HUD/SereneHUD.cpp
  - Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
  - Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
  - Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
autonomous: true

must_haves:
  truths:
    - "Footstep traces detect surface type and log the correct physical material"
    - "Different surfaces produce different logged surface types"
    - "Stamina bar appears when sprinting and shows depletion progress"
    - "Stamina bar fades/hides when stamina is full and player is not sprinting"
    - "InteractionComponent is attached to character and detects interactables"
    - "All 5 components are created and attached in SereneCharacter constructor"
    - "PlayerController interact handler calls InteractionComponent::TryInteract"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Player/Components/FootstepComponent.h"
      provides: "Surface detection via downward trace with physical material"
      contains: "UFootstepComponent"
    - path: "Source/ProjectWalkingSim/Public/Player/HUD/StaminaBarWidget.h"
      provides: "UUserWidget base for stamina progress bar"
      contains: "UStaminaBarWidget"
    - path: "Source/ProjectWalkingSim/Public/Player/HUD/SereneHUD.h"
      provides: "AHUD subclass managing all HUD widgets"
      contains: "ASereneHUD"
  key_links:
    - from: "FootstepComponent::PlayFootstepForSurface"
      to: "UPhysicalMaterial"
      via: "Downward line trace with bReturnPhysicalMaterial"
      pattern: "bReturnPhysicalMaterial.*true"
    - from: "StaminaComponent::OnStaminaChanged"
      to: "StaminaBarWidget::SetStaminaPercent"
      via: "Delegate binding in SereneHUD or Character BeginPlay"
      pattern: "OnStaminaChanged.*AddDynamic"
    - from: "SereneCharacter constructor"
      to: "InteractionComponent + FootstepComponent"
      via: "CreateDefaultSubobject for remaining two components"
      pattern: "CreateDefaultSubobject.*InteractionComponent|FootstepComponent"
    - from: "SerenePlayerController::HandleInteract"
      to: "InteractionComponent::TryInteract"
      via: "Get component from character and call TryInteract"
      pattern: "InteractionComponent.*TryInteract"
---

<objective>
Footstep component, stamina HUD, and full system integration. Wire the remaining components to the character and connect the stamina UI to the stamina system.

Purpose: Footsteps are foundation for AI noise detection in Phase 4/5 (designed now, used later). The stamina bar gives the player critical feedback about their sprint resource. This plan completes all five components on the character and ensures the full system is connected.

Output: FootstepComponent with surface detection, StaminaBarWidget with progress bar, SereneHUD managing widget lifecycle, InteractionComponent and FootstepComponent attached to character, PlayerController interact handler wired to InteractionComponent.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FootstepComponent with surface detection</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/Components/FootstepComponent.h
    Source/ProjectWalkingSim/Private/Player/Components/FootstepComponent.cpp
  </files>
  <action>
    Create UFootstepComponent : public UActorComponent

    **Header:**
    - ClassGroup=(Custom), meta=(BlueprintSpawnableComponent)
    - UPROPERTY(EditAnywhere, Category="Footsteps"):
      - float TraceDistance = 50.0f (cm downward from foot)
      - float FootstepInterval = 0.5f (seconds between footsteps at walk speed)
      - float SprintIntervalMultiplier = 0.6f (faster footsteps when sprinting)
      - float CrouchIntervalMultiplier = 1.3f (slower when crouching)
      - float CrouchVolumeMultiplier = 0.3f (quieter when crouching -- for future AI noise)
    - Delegate:
      - DECLARE_DYNAMIC_MULTICAST_DELEGATE_TwoParams(FOnFootstep, EPhysicalSurface, SurfaceType, float, Volume)
      - UPROPERTY(BlueprintAssignable) FOnFootstep OnFootstep
    - Public:
      - void PlayFootstepForSurface(const FVector& FootLocation) -- can be called from AnimNotify or timer
      - EPhysicalSurface GetLastSurfaceType() const
    - Private:
      - EPhysicalSurface LastSurfaceType
      - float FootstepTimer = 0.0f

    **Implementation:**
    - TickComponent:
      - Get owner as ACharacter, check if moving (velocity > small threshold) and on ground
      - Determine current interval based on movement state (sprint/crouch/walk)
      - Accumulate FootstepTimer += DeltaTime
      - If FootstepTimer >= CurrentInterval:
        - Reset timer
        - Get foot location: owner actor location (bottom of capsule)
        - Call PlayFootstepForSurface(FootLocation)
    - PlayFootstepForSurface (follow RESEARCH.md code example):
      - Trace downward from FootLocation by TraceDistance
      - FCollisionQueryParams: bReturnPhysicalMaterial = true (CRITICAL)
      - AddIgnoredActor(GetOwner())
      - LineTraceSingleByChannel(ECC_Visibility)
      - If hit with physical material:
        - EPhysicalSurface SurfaceType = UPhysicalMaterial::DetermineSurfaceType(PhysMat)
        - LastSurfaceType = SurfaceType
        - Determine volume: 1.0f for walk, higher for sprint, CrouchVolumeMultiplier for crouch
        - Broadcast OnFootstep(SurfaceType, Volume)
        - Log: "Footstep: Surface={SurfaceType}, Volume={Volume}" with LogSerene
      - If no physical material: default to SurfaceType1 (or Default), still broadcast

    NOTE: Actual sound playback is deferred to Phase 6 (Audio). This component detects surfaces and broadcasts events. Phase 6 will listen to OnFootstep and play appropriate sounds. For Phase 1, the log output proves the system works.

    NOTE: The timer-based approach is simpler than AnimNotify for Phase 1 (no animation assets configured yet). When proper animations are set up, footsteps can be triggered via AnimNotify calling PlayFootstepForSurface instead of the timer. Design the component to support both: timer as fallback, AnimNotify as override (add bool bUseAnimNotify = false, when true timer is disabled).

    IMPORTANT: bReturnPhysicalMaterial = true is CRITICAL. Without it, the trace returns null physical material even on surfaces that have one assigned.
    IMPORTANT: Use UPhysicalMaterial::DetermineSurfaceType(), not direct cast or manual lookup.
  </action>
  <verify>
    Component compiles. Attach to character. Walk in PIE over different physical materials. Log shows detected surface types. Sprint shows faster footstep rate. Crouch shows slower rate with lower volume value.
  </verify>
  <done>
    FootstepComponent detects surface type via downward trace with physical material query. Timer-based footstep rate scales with movement state. OnFootstep delegate broadcasts surface type and volume for future audio and AI systems. Supports both timer fallback and AnimNotify trigger modes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create StaminaBarWidget, SereneHUD, and complete character/controller wiring</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/HUD/StaminaBarWidget.h
    Source/ProjectWalkingSim/Private/Player/HUD/StaminaBarWidget.cpp
    Source/ProjectWalkingSim/Public/Player/HUD/SereneHUD.h
    Source/ProjectWalkingSim/Private/Player/HUD/SereneHUD.cpp
    Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
    Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
    Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
  </files>
  <action>
    **StaminaBarWidget (.h/.cpp):**
    - UStaminaBarWidget : public UUserWidget
    - UPROPERTY(meta=(BindWidget)) TObjectPtr of UProgressBar StaminaBar
    - UPROPERTY(Transient, meta=(BindWidgetAnimOptional)) TObjectPtr of UWidgetAnimation FadeAnimation -- optional, for show/hide
    - Private: bool bIsVisible = false, float HideDelay = 2.0f, float HideTimer = 0.0f
    - Public:
      - UFUNCTION(BlueprintCallable) void SetStaminaPercent(float Percent) -- updates progress bar fill
      - UFUNCTION(BlueprintCallable) void ShowBar() -- make visible (play fade-in if animation exists)
      - UFUNCTION(BlueprintCallable) void HideBar() -- hide (play fade-out if animation exists)
    - SetStaminaPercent: Set StaminaBar->SetPercent(Percent). If Percent < 1.0: ShowBar(). If Percent >= 1.0: start HideDelay timer (hide after delay).
    - NativeTick: if waiting to hide, accumulate timer, call HideBar when elapsed.
    - The bar should show when sprinting (Percent < 1.0) and auto-hide 2 seconds after reaching full.

    NOTE: This widget needs a UMG Blueprint (WBP_StaminaBar) with a ProgressBar named "StaminaBar". The C++ base handles logic; Blueprint handles layout and styling. Document this.

    **SereneHUD (.h/.cpp):**
    - ASereneHUD : public AHUD
    - Responsible for creating and managing HUD widgets
    - UPROPERTY(EditDefaultsOnly, Category="HUD") TSubclassOf of UStaminaBarWidget StaminaBarWidgetClass
    - UPROPERTY(EditDefaultsOnly, Category="HUD") TSubclassOf of UInteractionPromptWidget InteractionPromptWidgetClass
    - Private:
      - TObjectPtr of UStaminaBarWidget StaminaBarInstance
      - TObjectPtr of UInteractionPromptWidget InteractionPromptInstance
    - Override BeginPlay:
      - Create widget instances from classes, add to viewport
      - Get owning player's pawn (ASereneCharacter)
      - Bind StaminaComponent->OnStaminaChanged to a handler that calls StaminaBarInstance->SetStaminaPercent
      - Bind InteractionComponent->OnInteractableChanged to a handler that calls InteractionPromptInstance->UpdatePrompt
    - If widget classes are not set, log warning with LogSerene and skip creation

    **Update SereneCharacter:**
    - Add InteractionComponent and FootstepComponent creation in constructor (CreateDefaultSubobject)
    - Now all 5 components are created: Stamina, HeadBob, Lean, Interaction, Footstep
    - Include headers for InteractionComponent and FootstepComponent
    - In BeginPlay: log all component creation status with LogSerene

    **Update SerenePlayerController:**
    - Replace HandleInteract log stub with actual call:
      - Get character, get InteractionComponent, call TryInteract()
    - Replace HandleLean stubs: already done in Plan 03, but verify lean calls work

    **Update SereneGameMode:**
    - Set HUDClass = ASereneHUD::StaticClass() in constructor
    - Include SereneHUD header

    IMPORTANT: Widget creation in HUD must handle the case where pawn is not yet possessed (BeginPlay timing). Use a timer or OnPossessedPawnChanged delegate to safely get the pawn. Or defer binding to the first call of DrawHUD/Tick when pawn is valid.
    IMPORTANT: The StaminaBarWidget's auto-hide behavior is driven by stamina percentage: show when < 1.0 (depleting or recovering), hide after full for 2 seconds. This matches the CONTEXT.md requirement: "stamina bar only shows while sprinting then fades."
  </action>
  <verify>
    Project compiles. In PIE:
    - Sprint: stamina bar appears, fills down as stamina depletes
    - Stop sprinting: bar continues showing during regen, hides ~2s after full
    - Look at DoorActor within range: interaction prompt appears (if WBP widget created)
    - Press E on DoorActor: door opens (proving InteractionComponent -> TryInteract -> DoorActor pipeline)
    - Walk on ground: footstep log messages appear at regular intervals
    - Sprint: footstep rate increases
    - All 5 components visible in character's component list in editor
  </verify>
  <done>
    StaminaBarWidget shows/hides based on stamina state with auto-hide delay. SereneHUD creates and manages both widgets, binding them to character component delegates. All 5 components attached to SereneCharacter. PlayerController interact calls InteractionComponent::TryInteract. Full input-to-interaction pipeline works end to end.
  </done>
</task>

</tasks>

<verification>
1. All 5 components present on ASereneCharacter: Stamina, HeadBob, Lean, Interaction, Footstep
2. Sprint -> stamina bar appears, depletes, forces walk at 0, hides after full recovery
3. Look at interactable -> prompt appears. Press E -> interaction fires. Look away -> prompt hides.
4. Walk -> footstep logs at walk interval. Sprint -> faster intervals. Crouch -> slower intervals.
5. Door opens/closes. Pickup destroys. Readable logs. Drawer slides.
6. SereneHUD creates widgets and binds to component delegates
7. GameMode sets character, controller, and HUD classes correctly
</verification>

<success_criteria>
- Complete character with all 5 gameplay components wired and functional
- Stamina HUD provides visual feedback matching the "minimal HUD" design from CONTEXT.md
- Interaction pipeline works end-to-end: trace -> detect -> prompt -> input -> execute
- Footstep system detects surfaces and broadcasts for future audio/AI integration
- All systems use LogSerene, all values are EditAnywhere for tuning
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
