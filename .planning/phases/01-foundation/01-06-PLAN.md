---
phase: 01-foundation
plan: 06
type: execute
wave: 5
depends_on: ["01-05"]
files_modified:
  - Content/Input/Actions/IA_Move.uasset
  - Content/Input/Actions/IA_Look.uasset
  - Content/Input/Actions/IA_Sprint.uasset
  - Content/Input/Actions/IA_Crouch.uasset
  - Content/Input/Actions/IA_Interact.uasset
  - Content/Input/Actions/IA_LeanLeft.uasset
  - Content/Input/Actions/IA_LeanRight.uasset
  - Content/Input/Mappings/IMC_Default.uasset
  - Content/Blueprints/Game/BP_SereneCharacter.uasset
  - Content/Blueprints/Game/BP_SereneGameMode.uasset
  - Content/Blueprints/Game/BP_SerenePlayerController.uasset
  - Content/Blueprints/UI/WBP_StaminaBar.uasset
  - Content/Blueprints/UI/WBP_InteractionPrompt.uasset
autonomous: false

must_haves:
  truths:
    - "Player spawns into TestMap in first person with visible mannequin body"
    - "WASD moves player, mouse looks around with clamped pitch"
    - "Shift-hold sprints, stamina bar appears and depletes"
    - "Ctrl toggles crouch, player gets shorter"
    - "Looking at a door within 1.5m shows interaction prompt"
    - "Pressing E opens/closes the door"
    - "Q-hold leans left, E-hold leans right"
    - "Head-bob is visible while walking, disabled via GameInstance toggle"
    - "Footstep surface detection logs surface types"
    - "Player body casts shadow"
  artifacts:
    - path: "Content/Input/Mappings/IMC_Default.uasset"
      provides: "Key bindings for all player actions"
    - path: "Content/Blueprints/Game/BP_SereneCharacter.uasset"
      provides: "Blueprint subclass of ASereneCharacter with mesh and input assigned"
    - path: "Content/Blueprints/Game/BP_SereneGameMode.uasset"
      provides: "Blueprint GameMode pointing to BP character and controller"
  key_links:
    - from: "BP_SerenePlayerController"
      to: "IMC_Default + IA_* assets"
      via: "Default property assignment in Blueprint Details panel"
      pattern: "DefaultMappingContext.*IMC_Default"
    - from: "BP_SereneGameMode"
      to: "BP_SereneCharacter + BP_SerenePlayerController"
      via: "DefaultPawnClass and PlayerControllerClass overrides"
      pattern: "DefaultPawnClass.*BP_SereneCharacter"
    - from: "TestMap World Settings"
      to: "BP_SereneGameMode"
      via: "GameMode Override in World Settings"
      pattern: "GameMode.*BP_SereneGameMode"
---

<objective>
Create data assets (Input Actions, Input Mapping Context), Blueprint subclasses, UMG widgets, and set up TestMap for full integration testing.

Purpose: C++ code references Input Actions and widget classes via UPROPERTY. These must be created as data assets in the editor. Blueprint subclasses allow assigning meshes, input assets, and widget classes without hardcoding paths. This plan makes everything playable.

Output: All Input Action assets with correct key bindings, IMC_Default mapping context, Blueprint subclasses of character/controller/gamemode/HUD with assets assigned, UMG widget Blueprints for stamina and interaction prompt, TestMap configured with GameMode and test interactables.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Input Action assets, IMC, Blueprint subclasses, and UMG widgets via editor scripting or manual creation</name>
  <files>
    Content/Input/Actions/IA_Move.uasset
    Content/Input/Actions/IA_Look.uasset
    Content/Input/Actions/IA_Sprint.uasset
    Content/Input/Actions/IA_Crouch.uasset
    Content/Input/Actions/IA_Interact.uasset
    Content/Input/Actions/IA_LeanLeft.uasset
    Content/Input/Actions/IA_LeanRight.uasset
    Content/Input/Mappings/IMC_Default.uasset
    Content/Blueprints/Game/BP_SereneCharacter.uasset
    Content/Blueprints/Game/BP_SereneGameMode.uasset
    Content/Blueprints/Game/BP_SerenePlayerController.uasset
    Content/Blueprints/Game/BP_SereneHUD.uasset
    Content/Blueprints/UI/WBP_StaminaBar.uasset
    Content/Blueprints/UI/WBP_InteractionPrompt.uasset
  </files>
  <action>
    These are Unreal Editor data assets that CANNOT be created from C++ code or command line. They must be created in the Unreal Editor. Use the following steps:

    **Input Action Assets (Content/Input/Actions/):**
    Create 7 Input Action assets:
    - IA_Move: Value Type = Axis2D (InputActionValue type: Axis2D)
    - IA_Look: Value Type = Axis2D
    - IA_Sprint: Value Type = Digital (Bool)
    - IA_Crouch: Value Type = Digital (Bool)
    - IA_Interact: Value Type = Digital (Bool). Add trigger: Pressed (fires on initial press only)
    - IA_LeanLeft: Value Type = Digital (Bool)
    - IA_LeanRight: Value Type = Digital (Bool). Add trigger: Hold with threshold 0.2s (differentiates from Interact on same E key)

    **Input Mapping Context (Content/Input/Mappings/):**
    Create IMC_Default with mappings:
    - IA_Move: W(Up), S(Down), A(Left), D(Right) -- use Swizzle Input Axis Values modifier for 2D mapping. W=+Y, S=-Y, A=-X, D=+X. Or use the Negate modifier on S and A.
    - IA_Look: Mouse XY -- use Delta modifier type
    - IA_Sprint: Left Shift
    - IA_Crouch: Left Ctrl
    - IA_Interact: E key, with Pressed trigger
    - IA_LeanLeft: Q key
    - IA_LeanRight: E key, with Hold trigger (hold threshold 0.2s) -- this makes E-tap = interact, E-hold = lean right

    **Blueprint Subclasses (Content/Blueprints/Game/):**
    - BP_SereneCharacter (parent: ASereneCharacter):
      - Assign UE5 Mannequin skeletal mesh to Mesh component (SK_Mannequin or equivalent)
      - Assign same mesh to WorldRepresentationMesh component
      - Verify camera attached to head bone
    - BP_SerenePlayerController (parent: ASerenePlayerController):
      - Assign DefaultMappingContext = IMC_Default
      - Assign all 7 Input Action properties to corresponding IA_ assets
    - BP_SereneGameMode (parent: ASereneGameMode):
      - Set DefaultPawnClass = BP_SereneCharacter
      - Set PlayerControllerClass = BP_SerenePlayerController
      - Set HUDClass = BP_SereneHUD (or ASereneHUD if no BP subclass needed)
    - BP_SereneHUD (parent: ASereneHUD):
      - Assign StaminaBarWidgetClass = WBP_StaminaBar
      - Assign InteractionPromptWidgetClass = WBP_InteractionPrompt

    **UMG Widget Blueprints (Content/Blueprints/UI/):**
    - WBP_StaminaBar (parent: UStaminaBarWidget):
      - Add ProgressBar named "StaminaBar" (MUST match BindWidget name exactly)
      - Style: dark background, red/orange fill, small size, positioned bottom-center or bottom-left
      - Optional: add fade animation named "FadeAnimation" for show/hide transitions
    - WBP_InteractionPrompt (parent: UInteractionPromptWidget):
      - Add TextBlock named "PromptText" (MUST match BindWidget name)
      - Add TextBlock named "ReticleText" (MUST match BindWidget name) -- shows a small dot "."
      - Style: white text with slight drop shadow, centered bottom third of screen
      - PromptText starts hidden, ReticleText starts hidden

    **TestMap Setup:**
    - Open TestMap.umap (or create a simple test level if needed)
    - Set World Settings -> GameMode Override = BP_SereneGameMode
    - Place a floor (large plane with default material)
    - Place 2-3 DoorActor instances (assign cube/plane placeholder meshes)
    - Place 2-3 PickupActor instances (assign small cube meshes)
    - Place 1 ReadableActor (assign plane mesh)
    - Place 1 DrawerActor (assign box meshes for frame + drawer)
    - Add a PlayerStart
    - Ensure at least one directional light for shadow testing

    IMPORTANT: The BindWidget meta tag in C++ REQUIRES the widget name in Blueprint to exactly match the UPROPERTY variable name. "StaminaBar" in C++ must be "StaminaBar" in the UMG designer.
    IMPORTANT: For E key dual-use: IA_Interact uses Pressed trigger (fires immediately on key down). IA_LeanRight uses Hold trigger with 0.2s threshold (fires after holding E for 0.2s). This means a quick E-tap fires interact only. Holding E fires lean after 0.2s. Both triggers are configured in the IMC_Default mapping, not in C++.
    IMPORTANT: If the UE5 Mannequin doesn't have a "head" bone, find the correct bone name (likely "head" for Manny/Quinn) and update the camera attachment in BP_SereneCharacter if needed.
  </action>
  <verify>
    Open TestMap in editor. Press Play (PIE):
    - Player spawns in first person, can see mannequin body looking down
    - WASD moves, mouse looks, pitch clamped
    - Shift-hold: speed increases, stamina bar appears, stamina depletes
    - Release shift: stamina regens after delay, bar hides when full
    - Ctrl: toggles crouch (shorter view, slower movement)
    - Look at DoorActor within range: prompt "E: Open" appears
    - Press E: door opens. Press E again: closes
    - Hold Q: camera leans left. Hold E (long): camera leans right
    - Walk: subtle head-bob. Sprint: more bob. Stand still: no bob
    - Player shadow visible on floor
    - Footstep logs show surface types in Output Log
  </verify>
  <done>
    All data assets created. All Blueprint subclasses configured with correct references. UMG widgets have required BindWidget components. TestMap playable with full first-person experience. All Phase 1 success criteria testable.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1 Foundation: First-person character with visible body, movement (walk/sprint/crouch/stamina), head-bob with toggle, lean mechanic, interaction system with 4 actor types, footstep surface detection, and stamina HUD.
  </what-built>
  <how-to-verify>
    Open the project in Unreal Editor and play TestMap (PIE). Verify each requirement:

    **PLYR-01: First-person with visible body**
    1. Look down -- you should see the mannequin body (arms, legs, torso)
    2. Walk near a light source -- verify player shadow is cast on the ground

    **PLYR-02: Movement with crouch, sprint, stamina**
    3. Walk with WASD -- movement feels weighted, not instant
    4. Hold Shift -- sprint speed (~2x), stamina bar appears and depletes
    5. Sprint until stamina reaches 0 -- player forced to walk, cannot re-sprint immediately
    6. Wait for stamina to regenerate past ~20% -- sprinting available again
    7. Press Ctrl -- player crouches (lower viewpoint, slower)
    8. Press Ctrl again -- player stands up
    9. Try to sprint while crouched -- should NOT work (no crouch-sprint)

    **PLYR-03: Head-bob with toggle**
    10. Walk -- observe subtle camera sway
    11. Sprint -- observe increased sway
    12. Stand still -- no sway
    13. (If accessible) toggle head-bob off -- camera perfectly still during walk

    **PLYR-04: Interaction system**
    14. Walk up to a DoorActor within ~1.5m -- see "E: Open" prompt
    15. Walk beyond 1.5m -- prompt disappears
    16. Look away from door -- prompt disappears
    17. Press E on door -- it opens with smooth rotation
    18. Press E again -- it closes
    19. Press E on PickupActor -- it disappears (destroyed)
    20. Hold Q -- camera leans left
    21. Hold E (long press ~0.2s+) -- camera leans right

    **Core interfaces**
    22. Check Output Log for any errors or warnings

    Type "approved" if all checks pass, or describe any issues found.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues for gap closure</resume-signal>
</task>

</tasks>

<verification>
Full Phase 1 success criteria from ROADMAP.md:
1. Player can walk, run, crouch in first-person with visible arms/hands when looking down
2. Stamina depletes during sprint and regenerates when walking/standing
3. Head-bob can be toggled off in options without affecting gameplay
4. Player can approach objects and see interaction prompts appear
5. Core interfaces (IInteractable, IHideable, ISaveable) compile and can be implemented
</verification>

<success_criteria>
- All 5 ROADMAP success criteria for Phase 1 pass
- 22-point verification checklist completes without blockers
- No compilation errors or runtime crashes
- Movement feels grounded and horror-appropriate
- Interaction system is extensible for Phase 2+ additions
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-06-SUMMARY.md`
</output>
