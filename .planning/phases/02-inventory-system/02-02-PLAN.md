---
phase: 02-inventory-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Source/ProjectWalkingSim/Public/Player/HUD/InventorySlotWidget.h
  - Source/ProjectWalkingSim/Private/Player/HUD/InventorySlotWidget.cpp
  - Source/ProjectWalkingSim/Public/Player/HUD/ItemTooltipWidget.h
  - Source/ProjectWalkingSim/Private/Player/HUD/ItemTooltipWidget.cpp
  - Source/ProjectWalkingSim/Public/Player/HUD/InventoryWidget.h
  - Source/ProjectWalkingSim/Private/Player/HUD/InventoryWidget.cpp
autonomous: true

must_haves:
  truths:
    - "InventorySlotWidget can display an item icon, quantity badge, and selection highlight"
    - "ItemTooltipWidget can display item name, description, and four action buttons"
    - "InventoryWidget creates 8 slot widgets in a horizontal box and can refresh them from slot data"
    - "InventoryWidget starts hidden (opacity 0) and can be shown/hidden"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Player/HUD/InventorySlotWidget.h"
      provides: "UInventorySlotWidget with BindWidget slots for icon, quantity, background, highlight"
      contains: "UInventorySlotWidget"
    - path: "Source/ProjectWalkingSim/Public/Player/HUD/ItemTooltipWidget.h"
      provides: "UItemTooltipWidget with BindWidget slots for name, description, action buttons"
      contains: "UItemTooltipWidget"
    - path: "Source/ProjectWalkingSim/Public/Player/HUD/InventoryWidget.h"
      provides: "UInventoryWidget with SlotContainer, slot array, RefreshSlots, Show/Hide, tooltip management"
      contains: "UInventoryWidget"
  key_links:
    - from: "InventoryWidget.h"
      to: "InventorySlotWidget.h"
      via: "Creates 8 slot widgets dynamically in NativeConstruct"
      pattern: "CreateWidget.*InventorySlotWidget"
    - from: "InventoryWidget.h"
      to: "ItemTooltipWidget.h"
      via: "Manages single tooltip instance, positions above selected slot"
      pattern: "ItemTooltipWidget"
    - from: "InventorySlotWidget.h"
      to: "InventoryTypes.h"
      via: "SetSlotData takes FInventorySlot parameter"
      pattern: "FInventorySlot"
---

<objective>
Create the three inventory UI widget C++ base classes: slot, tooltip, and container.

Purpose: These are the C++ foundations for the UMG Blueprint subclasses. They define BindWidget properties that the UMG Blueprints must match, and expose C++ functions for data binding. No inventory logic lives here -- widgets only display data and emit user interaction events. The InventoryWidget creates 8 InventorySlotWidgets dynamically and manages a single ItemTooltipWidget for the selected slot.

Output: 6 new files (3 header + 3 source) in Player/HUD/ directory.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inventory-system/02-CONTEXT.md
@.planning/phases/02-inventory-system/02-RESEARCH.md

@Source/ProjectWalkingSim/Public/Player/HUD/StaminaBarWidget.h
@Source/ProjectWalkingSim/Public/Player/HUD/InteractionPromptWidget.h
@Source/ProjectWalkingSim/Public/Player/HUD/SereneHUDWidget.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: InventorySlotWidget and ItemTooltipWidget</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/HUD/InventorySlotWidget.h
    Source/ProjectWalkingSim/Private/Player/HUD/InventorySlotWidget.cpp
    Source/ProjectWalkingSim/Public/Player/HUD/ItemTooltipWidget.h
    Source/ProjectWalkingSim/Private/Player/HUD/ItemTooltipWidget.cpp
  </files>
  <action>
    Create both widget C++ base classes following the existing BindWidget pattern (see StaminaBarWidget.h and InteractionPromptWidget.h for conventions).

    **InventorySlotWidget.h / .cpp:**
    - UCLASS, subclass of UUserWidget
    - Forward-declare UItemDataAsset (do NOT include InventoryTypes.h directly -- forward-declare FInventorySlot or include it since it's a struct; you must include InventoryTypes.h for FInventorySlot since it's used by-value)
    - BindWidget properties (protected):
      - `TObjectPtr<UImage> SlotBackground` (meta = (BindWidget))
      - `TObjectPtr<UImage> ItemIcon` (meta = (BindWidget))
      - `TObjectPtr<UTextBlock> QuantityText` (meta = (BindWidget))
      - `TObjectPtr<UImage> SelectionHighlight` (meta = (BindWidgetOptional))
    - Public properties:
      - `int32 SlotIndex = -1` (BlueprintReadOnly, Category = "Inventory") -- set by InventoryWidget during creation
    - Public functions (BlueprintCallable, Category = "Inventory"):
      - `void SetSlotData(const FInventorySlot& SlotData, const UItemDataAsset* ItemData)` -- loads icon via TSoftObjectPtr::LoadSynchronous(), sets QuantityText visibility (hide if quantity <= 1), sets QuantityText to FString::FromInt(Quantity)
      - `void ClearSlot()` -- hides icon, hides quantity text, resets to empty visual state
      - `void SetSelected(bool bSelected)` -- shows/hides SelectionHighlight. If SelectionHighlight is nullptr (optional), do nothing.
    - Declare a delegate for slot interaction:
      - `DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FOnSlotClicked, int32, SlotIndex)`
      - `FOnSlotClicked OnSlotClicked` (BlueprintAssignable) -- broadcast from NativeOnMouseButtonDown or a UButton overlay
    - Override `FReply NativeOnMouseButtonDown(const FGeometry&, const FPointerEvent&)` to broadcast OnSlotClicked with SlotIndex, return FReply::Handled()
    - Override `NativeConstruct()` to set initial empty state (call ClearSlot)
    - .cpp: Include Image.h, TextBlock.h, ItemDataAsset.h, InventoryTypes.h. For icon loading: `if (ItemData && ItemData->Icon.IsValid()) { UTexture2D* IconTex = ItemData->Icon.LoadSynchronous(); if (IconTex && ItemIcon) { ItemIcon->SetBrushFromTexture(IconTex); ItemIcon->SetVisibility(ESlateVisibility::SelfHitTestInvisible); } }`
    - For QuantityText: show only when Quantity > 1, hide otherwise via SetVisibility (this is a TextBlock inside the widget, not a child UserWidget, so SetVisibility is fine)
    - Forward includes: `#include "Components/Image.h"`, `#include "Components/TextBlock.h"`

    **ItemTooltipWidget.h / .cpp:**
    - UCLASS, subclass of UUserWidget
    - BindWidget properties (protected):
      - `TObjectPtr<UTextBlock> ItemNameText` (meta = (BindWidget))
      - `TObjectPtr<UTextBlock> ItemDescriptionText` (meta = (BindWidget))
      - `TObjectPtr<UButton> UseButton` (meta = (BindWidget))
      - `TObjectPtr<UButton> CombineButton` (meta = (BindWidget))
      - `TObjectPtr<UButton> InfoButton` (meta = (BindWidgetOptional)) -- optional, may not be in initial UMG
      - `TObjectPtr<UButton> DiscardButton` (meta = (BindWidget))
    - Public properties:
      - `int32 BoundSlotIndex = -1` (BlueprintReadOnly) -- which slot this tooltip is showing for
    - Delegate declarations:
      - `DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FOnTooltipAction, int32, SlotIndex)`
      - `FOnTooltipAction OnUseClicked` (BlueprintAssignable)
      - `FOnTooltipAction OnCombineClicked` (BlueprintAssignable)
      - `FOnTooltipAction OnInfoClicked` (BlueprintAssignable)
      - `FOnTooltipAction OnDiscardClicked` (BlueprintAssignable)
    - Public functions (BlueprintCallable):
      - `void SetTooltipData(int32 SlotIndex, const UItemDataAsset* ItemData)` -- sets name, description text, stores BoundSlotIndex
      - `void HideTooltip()` -- sets render opacity to 0
      - `void ShowTooltip()` -- sets render opacity to 1
    - Override NativeConstruct: bind button OnClicked delegates to internal handlers that broadcast the corresponding delegate with BoundSlotIndex. Start hidden (SetRenderOpacity 0).
    - .cpp: Include Button.h, TextBlock.h. Bind each button: `UseButton->OnClicked.AddDynamic(this, &UItemTooltipWidget::HandleUseClicked)`. Each handler broadcasts the corresponding public delegate.

    Follow conventions:
    - Copyright header: `// Copyright Null Lantern.`
    - Use LogSerene for warnings (e.g., null ItemData)
    - PROJECTWALKINGSIM_API on classes
  </action>
  <verify>
    Run the UE build command:
    ```
    "C:\Program Files\Epic Games\UE_5.7\Engine\Binaries\DotNET\UnrealBuildTool\UnrealBuildTool.exe" ProjectWalkingSim Win64 Development -Project="C:\Unreal Projects\ProjectWalkingSim\ProjectWalkingSim.uproject" -WaitMutex -FromMsBuild
    ```
  </verify>
  <done>
    InventorySlotWidget has 4 BindWidget properties (SlotBackground, ItemIcon, QuantityText, SelectionHighlight), SetSlotData/ClearSlot/SetSelected methods, and OnSlotClicked delegate. ItemTooltipWidget has 6 BindWidget properties (name, description, 4 buttons), SetTooltipData method, and 4 action delegates. Both compile cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: InventoryWidget container</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/HUD/InventoryWidget.h
    Source/ProjectWalkingSim/Private/Player/HUD/InventoryWidget.cpp
  </files>
  <action>
    Create the root inventory panel widget that contains the horizontal row of 8 slots and manages the tooltip.

    **InventoryWidget.h:**
    - UCLASS, subclass of UUserWidget
    - Forward-declare UInventorySlotWidget, UItemTooltipWidget, UInventoryComponent, struct FInventorySlot
    - BindWidget properties (protected):
      - `TObjectPtr<UHorizontalBox> SlotContainer` (meta = (BindWidget)) -- horizontal box holding slot widgets
    - Editable class references (protected, EditDefaultsOnly):
      - `TSubclassOf<UInventorySlotWidget> SlotWidgetClass` -- set to WBP_InventorySlot in BP
      - `TSubclassOf<UItemTooltipWidget> TooltipWidgetClass` -- set to WBP_ItemTooltip in BP
    - Internal state (private):
      - `TArray<TObjectPtr<UInventorySlotWidget>> SlotWidgets` -- the 8 created slot widget instances
      - `TObjectPtr<UItemTooltipWidget> TooltipWidget` -- single tooltip instance, created in NativeConstruct
      - `int32 SelectedSlotIndex = -1` -- currently selected slot (-1 = none)
      - `bool bIsVisible = false` -- tracks show/hide state
    - Public functions (BlueprintCallable, Category = "Inventory"):
      - `void RefreshSlots(const TArray<FInventorySlot>& Slots, const UInventoryComponent* InventoryComp)` -- iterates SlotWidgets, calls SetSlotData or ClearSlot for each based on FInventorySlot state
      - `void ShowInventory()` -- SetRenderOpacity(1.0f), set bIsVisible = true
      - `void HideInventory()` -- SetRenderOpacity(0.0f), deselect current slot, hide tooltip, set bIsVisible = false
      - `bool IsInventoryVisible() const`
      - `void SelectSlot(int32 SlotIndex)` -- highlight slot, show tooltip with item data, deselect previous
      - `void DeselectSlot()` -- remove highlight, hide tooltip, set SelectedSlotIndex = -1
      - `int32 GetSelectedSlotIndex() const`
    - Delegate forwarding (the widget re-broadcasts tooltip actions so the HUD can route them):
      - `FOnTooltipAction OnUseRequested` (BlueprintAssignable)
      - `FOnTooltipAction OnCombineRequested` (BlueprintAssignable)
      - `FOnTooltipAction OnDiscardRequested` (BlueprintAssignable)

    **InventoryWidget.cpp:**
    - NativeConstruct:
      1. SetRenderOpacity(0.0f) -- start hidden per UMG lessons
      2. Create 8 InventorySlotWidgets via CreateWidget, set SlotIndex on each, add to SlotContainer via AddChildToHorizontalBox, store in SlotWidgets array
      3. Bind each slot's OnSlotClicked to an internal handler `HandleSlotClicked(int32 SlotIndex)` that calls SelectSlot
      4. Create tooltip widget via CreateWidget, add to viewport (or as overlay child). Store in TooltipWidget. Bind tooltip's action delegates to internal handlers that re-broadcast through the InventoryWidget's own delegates.
      5. Log creation success.
    - RefreshSlots: Loop through SlotWidgets and Slots arrays. For each: if slot IsEmpty, call ClearSlot; otherwise call SetSlotData with slot data and GetItemData lookup from InventoryComp. If the currently selected slot becomes empty, call DeselectSlot.
    - SelectSlot: Deselect previous. Set SelectedSlotIndex. Call SetSelected(true) on the slot widget. Show tooltip with item data from the slot. Position tooltip appropriately (this positioning will be refined in the UMG Blueprint -- C++ just shows/hides it).
    - HandleSlotClicked: If same slot clicked again, deselect (toggle behavior). Otherwise, select.

    Important: The tooltip should be a child of this widget in the UMG Blueprint, NOT added to viewport separately. Use BindWidgetOptional or create it programmatically and add to an overlay slot. For simplicity and following the BindWidget pattern: add a `TObjectPtr<UItemTooltipWidget> TooltipWidget` as a BindWidgetOptional. If bound in UMG, use it. If not bound, create programmatically. Actually, the simpler approach: make it a BindWidget. The UMG artist adds WBP_ItemTooltip as a child of WBP_InventoryWidget. This means removing the TooltipWidgetClass property and just using BindWidget.

    REVISED approach for tooltip: Use `meta = (BindWidget)` for `TooltipWidget` (TObjectPtr<UItemTooltipWidget>). The tooltip is placed in the UMG Blueprint as a child widget. C++ just shows/hides it and sets data. This is simpler and matches the project pattern. Remove `TooltipWidgetClass` from properties.

    Include: HorizontalBox.h, InventorySlotWidget.h, ItemTooltipWidget.h, InventoryTypes.h, InventoryComponent.h
  </action>
  <verify>
    Run the UE build command:
    ```
    "C:\Program Files\Epic Games\UE_5.7\Engine\Binaries\DotNET\UnrealBuildTool\UnrealBuildTool.exe" ProjectWalkingSim Win64 Development -Project="C:\Unreal Projects\ProjectWalkingSim\ProjectWalkingSim.uproject" -WaitMutex -FromMsBuild
    ```
  </verify>
  <done>
    InventoryWidget compiles with: SlotContainer BindWidget (HorizontalBox), TooltipWidget BindWidget, SlotWidgetClass TSubclassOf, 8 dynamically created slots in NativeConstruct, RefreshSlots method, ShowInventory/HideInventory, SelectSlot/DeselectSlot, and re-broadcast delegates for tooltip actions.
  </done>
</task>

</tasks>

<verification>
- All 6 new files compile without errors
- InventorySlotWidget has BindWidget: SlotBackground, ItemIcon, QuantityText, SelectionHighlight(optional)
- ItemTooltipWidget has BindWidget: ItemNameText, ItemDescriptionText, UseButton, CombineButton, DiscardButton, InfoButton(optional)
- InventoryWidget has BindWidget: SlotContainer (HorizontalBox), TooltipWidget
- InventoryWidget creates 8 slots dynamically using SlotWidgetClass
- All widgets use SetRenderOpacity for show/hide (not SetVisibility on UserWidget)
- No tick-based updates -- all event-driven via delegates
</verification>

<success_criteria>
Full UE build succeeds. Three inventory widget C++ classes are ready for UMG Blueprint subclassing. They follow the BindWidget pattern established by StaminaBarWidget and InteractionPromptWidget.
</success_criteria>

<output>
After completion, create `.planning/phases/02-inventory-system/02-02-SUMMARY.md`
</output>
