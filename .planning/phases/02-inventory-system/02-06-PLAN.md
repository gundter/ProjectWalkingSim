---
phase: 02-inventory-system
plan: 06
type: execute
wave: 5
depends_on: ["02-05"]
files_modified:
  - Scripts/create_phase2_assets.py
  - Scripts/EDITOR_SETUP_PHASE2.md
  - Config/DefaultEngine.ini
autonomous: false

must_haves:
  truths:
    - "IA_ToggleInventory input action asset exists"
    - "IMC_Default is updated with inventory toggle binding (Tab) and interact rebound to F"
    - "Asset Manager is configured to scan /Game/Data/Items for ItemDataAsset"
    - "Editor setup guide covers UMG Blueprint creation for all 3 inventory widgets"
    - "Editor setup guide covers data asset creation for demo items"
  artifacts:
    - path: "Scripts/create_phase2_assets.py"
      provides: "Python automation for IA_ToggleInventory, IMC_Default update, DefaultEngine.ini Asset Manager config"
      contains: "IA_ToggleInventory"
    - path: "Scripts/EDITOR_SETUP_PHASE2.md"
      provides: "Step-by-step manual editor setup for UMG Blueprints and data assets"
      contains: "WBP_InventoryWidget"
    - path: "Config/DefaultEngine.ini"
      provides: "Asset Manager configuration for Item primary asset type"
      contains: "PrimaryAssetType"
  key_links:
    - from: "Config/DefaultEngine.ini"
      to: "ItemDataAsset"
      via: "Asset Manager scans /Game/Data/Items for UItemDataAsset instances"
      pattern: "ItemDataAsset"
    - from: "Scripts/create_phase2_assets.py"
      to: "IA_ToggleInventory"
      via: "Python script creates input action asset"
      pattern: "ToggleInventory"
---

<objective>
Create input action assets, configure Asset Manager for item scanning, rebind interact key to F, produce editor setup documentation for UMG Blueprints and data assets.

Purpose: The C++ code is complete but needs data assets to function. This plan creates the IA_ToggleInventory input action via Python automation, configures DefaultEngine.ini for Asset Manager item scanning, rebinds IA_Interact from E to F in IMC_Default, and provides a clear editor setup guide for creating the UMG Blueprint widgets (WBP_InventoryWidget, WBP_InventorySlot, WBP_ItemTooltip) and demo item data assets (DA_Key_FrontDoor, DA_Key_Basement, DA_Code_Safe).

Output: Python automation script, editor setup guide, modified DefaultEngine.ini.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inventory-system/02-CONTEXT.md
@.planning/phases/02-inventory-system/02-RESEARCH.md
@.planning/phases/02-inventory-system/02-01-SUMMARY.md
@.planning/phases/02-inventory-system/02-04-SUMMARY.md
@.planning/phases/02-inventory-system/02-05-SUMMARY.md

@Scripts/create_phase1_assets.py
@Scripts/EDITOR_SETUP.md
@Config/DefaultEngine.ini
</context>

<tasks>

<task type="auto">
  <name>Task 1: Python automation + Asset Manager config</name>
  <files>
    Scripts/create_phase2_assets.py
    Config/DefaultEngine.ini
  </files>
  <action>
    **Python script (Scripts/create_phase2_assets.py):**
    Follow the pattern established by `Scripts/create_phase1_assets.py` (read it first for exact API patterns, UE5.7 quirks like InputAction_Factory, FKey.import_text, etc.).

    The script should:
    1. Create IA_ToggleInventory input action:
       - Asset path: `/Game/Input/Actions/IA_ToggleInventory`
       - ValueType: `EInputActionValueType::BOOLEAN` (or the Python equivalent from Phase 1 script)
       - Follow the exact same factory pattern as Phase 1 IA creation

    2. Update IMC_Default to add IA_ToggleInventory binding:
       - Load existing IMC_Default from `/Game/Input/Mappings/IMC_Default`
       - Add mapping: IA_ToggleInventory -> Tab key
       - Use `imc.map_key(action, key)` pattern from Phase 1 script

    3. Rebind IA_Interact from E to F:
       - This is tricky: we need to find the existing IA_Interact mapping in IMC_Default and change its key
       - Approach: Load IMC_Default, iterate mappings to find the one bound to IA_Interact with E key, change its key to F
       - If the API doesn't support modifying existing mappings easily, remove the old mapping and add a new one with F key
       - IMPORTANT: IA_Interact currently has TWO bindings in IMC_Default: E-press (interact) and E-hold (lean right shares the key). The E-hold binding is for IA_LeanRight, not IA_Interact. Only change the IA_Interact binding from E to F. Leave IA_LeanRight E-hold unchanged.
       - Result after rebinding:
         - IA_Interact: F (Pressed trigger)
         - IA_LeanRight: E (Hold trigger) -- unchanged
         - This frees up E-press for potential future use

    4. Save all modified/created assets

    Log each step clearly. Handle errors gracefully.

    **DefaultEngine.ini modification:**
    Add Asset Manager configuration to scan for UItemDataAsset instances. Read the existing DefaultEngine.ini first, then append (or modify if section exists):

    ```ini
    [/Script/Engine.AssetManagerSettings]
    -PrimaryAssetTypesToScan=(PrimaryAssetType="Item",AssetBaseClass="/Script/ProjectWalkingSim.ItemDataAsset",bHasBlueprintClasses=False,bIsEditorOnly=False,Directories=((Path="/Game/Data/Items")),SpecificAssets=(),Rules=(Priority=-1,ChunkId=-1,bApplyRecursively=True,CookRule=Unknown))
    +PrimaryAssetTypesToScan=(PrimaryAssetType="Item",AssetBaseClass="/Script/ProjectWalkingSim.ItemDataAsset",bHasBlueprintClasses=False,bIsEditorOnly=False,Directories=((Path="/Game/Data/Items")),SpecificAssets=(),Rules=(Priority=-1,ChunkId=-1,bApplyRecursively=True,CookRule=Unknown))
    ```

    The `-` then `+` pattern ensures idempotency (removes if exists, then adds). If the `[/Script/Engine.AssetManagerSettings]` section doesn't exist, add it.

    IMPORTANT: Be careful not to corrupt existing DefaultEngine.ini content. Read the file, find the right section or create it, append the line.
  </action>
  <verify>
    Run the Python script in the UE editor (if possible via commandlet) or verify the script syntax. Verify DefaultEngine.ini has the Asset Manager section with ItemDataAsset scanning configuration. Verify the script handles the IMC rebinding correctly.

    If running via commandlet:
    ```
    "C:\Program Files\Epic Games\UE_5.7\Engine\Binaries\Win64\UnrealEditor-Cmd.exe" "C:\Unreal Projects\ProjectWalkingSim\ProjectWalkingSim.uproject" -run=pythonscript -script="C:\Unreal Projects\ProjectWalkingSim\Scripts\create_phase2_assets.py"
    ```

    If commandlet is not available in the current environment, verify:
    - Script file exists with correct Python syntax
    - DefaultEngine.ini has the PrimaryAssetTypesToScan entry
  </verify>
  <done>
    create_phase2_assets.py creates IA_ToggleInventory, adds Tab binding to IMC_Default, rebinds IA_Interact from E to F. DefaultEngine.ini has Asset Manager config scanning /Game/Data/Items for ItemDataAsset. All files exist on disk.
  </done>
</task>

<task type="auto">
  <name>Task 2: Editor setup guide</name>
  <files>
    Scripts/EDITOR_SETUP_PHASE2.md
  </files>
  <action>
    Create `Scripts/EDITOR_SETUP_PHASE2.md` with step-by-step instructions for manual editor setup that Claude cannot automate (UMG Blueprint creation, data asset creation).

    Follow the format and tone of `Scripts/EDITOR_SETUP.md` (Phase 1 guide).

    The guide should cover:

    **Part 1: Run Python Script**
    - How to run create_phase2_assets.py in the editor
    - What to expect (IA_ToggleInventory created, IMC_Default updated)

    **Part 2: Create UMG Blueprint Widgets**

    WBP_InventorySlot (parent: InventorySlotWidget):
    - Create in Content/UI/Inventory/
    - Canvas Panel root with:
      - Image named "SlotBackground" (fill entire slot, subtle dark background)
      - Image named "ItemIcon" (centered, slightly smaller than slot)
      - TextBlock named "QuantityText" (bottom-right corner, small font, shows stack count)
      - Image named "SelectionHighlight" (full slot, semi-transparent highlight, starts hidden) [optional]
    - Size hint: ~80x80 pixels per slot

    WBP_ItemTooltip (parent: ItemTooltipWidget):
    - Create in Content/UI/Inventory/
    - Vertical box with:
      - TextBlock named "ItemNameText" (bold, larger font)
      - TextBlock named "ItemDescriptionText" (regular font, wrapping enabled)
      - Horizontal box with buttons:
        - Button named "UseButton" with text child "Use"
        - Button named "CombineButton" with text child "Combine"
        - Button named "DiscardButton" with text child "Discard"
        - (Optional) Button named "InfoButton" with text child "Info"
    - Dark background, slight padding

    WBP_InventoryWidget (parent: InventoryWidget):
    - Create in Content/UI/Inventory/
    - Canvas Panel or Overlay root with:
      - HorizontalBox named "SlotContainer" (centered bottom, this is where slots get added dynamically)
      - WBP_ItemTooltip as child named "TooltipWidget" (positioned above SlotContainer, anchored bottom-center)
    - Set SlotWidgetClass to WBP_InventorySlot in class defaults

    **Part 3: Update WBP_SereneHUD**
    - Open WBP_SereneHUD
    - Add WBP_InventoryWidget as child in the Canvas Panel, named "InventoryWidget"
    - Anchor to full screen or bottom-center as desired

    **Part 4: Create Demo Item Data Assets**
    - Create folder: Content/Data/Items/
    - Create 3 data assets of type ItemDataAsset:
      - DA_Key_FrontDoor: ItemId="Key_FrontDoor", DisplayName="Front Door Key", Description="A rusty iron key...", bIsKeyItem=true, ItemType=KeyItem, ItemTag=Item.Key
      - DA_Key_Basement: ItemId="Key_Basement", DisplayName="Basement Key", Description="A small brass key...", bIsKeyItem=true, ItemType=KeyItem, ItemTag=Item.Key
      - DA_Code_Safe: ItemId="Code_Safe", DisplayName="Safe Code", Description="A scrap of paper with numbers...", bIsKeyItem=true, ItemType=KeyItem, ItemTag=Item.Key
    - Leave Icon and WorldMesh blank for now (placeholder visuals)

    **Part 5: Configure Blueprints**
    - Open BP_SerenePlayerController
    - In Details, set ToggleInventoryAction to IA_ToggleInventory
    - Verify IA_Interact is already assigned (unchanged from Phase 1)

    **Part 6: Test Map Setup**
    - Place 3-4 PickupActors in TestMap:
      - Set ItemId on each to match data asset ItemIds (Key_FrontDoor, Key_Basement, Code_Safe)
      - Set Quantity = 1
    - Place a test locked door:
      - Use existing DoorActor
      - Set RequiredItemId = "Key_FrontDoor"
      - Set bIsLocked = true

    Include a troubleshooting section for common issues (BindWidget name mismatch, Asset Manager not finding items, etc.).
  </action>
  <verify>
    Verify Scripts/EDITOR_SETUP_PHASE2.md exists, is well-formatted markdown, and covers all 6 parts (python script, 3 UMG widgets, HUD update, data assets, blueprint config, test map).
  </verify>
  <done>
    EDITOR_SETUP_PHASE2.md exists with complete step-by-step instructions for UMG Blueprint creation (WBP_InventorySlot, WBP_ItemTooltip, WBP_InventoryWidget), WBP_SereneHUD update, demo item data assets, blueprint configuration, and test map setup.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 2 inventory system C++ code:
    - UInventoryComponent (8-slot backend with add/remove/combine/discard)
    - UItemDataAsset (item definitions via UPrimaryDataAsset)
    - 3 UI widgets (InventoryWidget, InventorySlotWidget, ItemTooltipWidget)
    - PickupActor inventory integration (TryAddItem, Inventory Full text)
    - DoorActor locked door support (key consumption)
    - SereneCharacter + SerenePlayerController + SereneHUD wiring
    - Input mode switching (cursor, look disable, WASD preserved)
    - Combine system (two-step flow with recipe backend)
    - Keyboard navigation (1-8, arrows, Escape, Delete)
    - IA_ToggleInventory input action + IMC rebinding (E->F interact)
    - Asset Manager config for item data asset scanning
    - Editor setup guide (Scripts/EDITOR_SETUP_PHASE2.md)
  </what-built>
  <how-to-verify>
    **Part A: Manual Editor Setup (follow Scripts/EDITOR_SETUP_PHASE2.md)**
    1. Run create_phase2_assets.py in the editor to create IA_ToggleInventory and rebind IA_Interact to F
    2. Create UMG Blueprint widgets:
       - WBP_InventorySlot (parent: InventorySlotWidget): Add Canvas Panel with Image "SlotBackground", Image "ItemIcon", TextBlock "QuantityText", optional Image "SelectionHighlight"
       - WBP_ItemTooltip (parent: ItemTooltipWidget): Add TextBlock "ItemNameText", TextBlock "ItemDescriptionText", Button "UseButton", Button "CombineButton", Button "DiscardButton"
       - WBP_InventoryWidget (parent: InventoryWidget): Add HorizontalBox "SlotContainer", place WBP_ItemTooltip as child named "TooltipWidget". Set SlotWidgetClass to WBP_InventorySlot.
    3. Update WBP_SereneHUD: Add WBP_InventoryWidget as child named "InventoryWidget" in the Canvas Panel
    4. Create demo item data assets in Content/Data/Items/:
       - DA_Key_FrontDoor: ItemId="Key_FrontDoor", DisplayName="Front Door Key", bIsKeyItem=true, ItemType=KeyItem
       - DA_Key_Basement: ItemId="Key_Basement", DisplayName="Basement Key", bIsKeyItem=true
       - DA_Code_Safe: ItemId="Code_Safe", DisplayName="Safe Code", bIsKeyItem=true
    5. Assign IA_ToggleInventory on BP_SerenePlayerController
    6. Place test PickupActors in TestMap with ItemId matching data assets
    7. Place a test locked door with RequiredItemId = "Key_FrontDoor"

    **Part B: PIE Verification**
    1. Run PIE and verify:
       - [ ] Press Tab to open inventory (cursor appears, camera stops rotating)
       - [ ] Press Tab again to close (cursor disappears, camera rotates again)
       - [ ] WASD movement works while inventory is open
       - [ ] Walk to pickup, press F to pick up (item appears in inventory slot)
       - [ ] Pick up multiple items, verify they fill slots left to right
       - [ ] Try to pick up with full inventory, see "Inventory Full" prompt
       - [ ] Click a slot to select it, tooltip appears with item info
       - [ ] Click Discard in tooltip, item drops in front of player
       - [ ] Pick up dropped item again
       - [ ] Number keys 1-8 select slots while inventory is open
       - [ ] Arrow keys cycle through slots
       - [ ] Walk to locked door, see "Locked" text
       - [ ] Pick up front door key, interact with locked door, door unlocks and opens
       - [ ] Verify key is consumed from inventory after unlocking
    2. Check Output Log for any LogSerene warnings or errors
  </how-to-verify>
  <resume-signal>Type "approved" to close Phase 2, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- IA_ToggleInventory exists in Content/Input/Actions/
- IMC_Default has Tab -> IA_ToggleInventory binding
- IA_Interact is rebound from E to F in IMC_Default
- DefaultEngine.ini has PrimaryAssetTypesToScan for Item type
- EDITOR_SETUP_PHASE2.md exists with clear step-by-step instructions
- All UMG Blueprints created and BindWidget properties resolve
- Demo items appear in Content/Data/Items/
- Full pickup -> inventory -> discard -> re-pickup cycle works
- Locked door unlock with key consumption works
</verification>

<success_criteria>
The complete inventory system is operational in PIE: items can be picked up, viewed, discarded, and used to unlock doors. Input mode switching works correctly. The inventory UI displays correctly and responds to both mouse and keyboard input.
</success_criteria>

<output>
After completion, create `.planning/phases/02-inventory-system/02-06-SUMMARY.md`
</output>
