---
phase: 02-inventory-system
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
  - Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
  - Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
  - Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
  - Source/ProjectWalkingSim/Public/Player/HUD/SereneHUD.h
  - Source/ProjectWalkingSim/Private/Player/HUD/SereneHUD.cpp
  - Source/ProjectWalkingSim/Public/Player/HUD/SereneHUDWidget.h
autonomous: true

must_haves:
  truths:
    - "Player can press a key to toggle inventory open/close"
    - "Mouse cursor appears when inventory is open, disappears when closed"
    - "Camera stops rotating from mouse when inventory is open, but WASD movement works"
    - "Inventory UI refreshes automatically when items are added or removed"
    - "InventoryWidget is part of the SereneHUDWidget hierarchy"
  artifacts:
    - path: "Source/ProjectWalkingSim/Public/Player/SereneCharacter.h"
      provides: "Character with InventoryComponent attached"
      contains: "InventoryComponent"
    - path: "Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h"
      provides: "Controller with inventory toggle, input mode switching, ToggleInventoryAction"
      contains: "ToggleInventoryAction"
    - path: "Source/ProjectWalkingSim/Public/Player/HUD/SereneHUD.h"
      provides: "HUD with inventory delegate handler, ShowInventory, HideInventory"
      contains: "HandleInventoryChanged"
    - path: "Source/ProjectWalkingSim/Public/Player/HUD/SereneHUDWidget.h"
      provides: "Root HUD with InventoryWidget BindWidget"
      contains: "InventoryWidget"
  key_links:
    - from: "SereneCharacter.cpp"
      to: "InventoryComponent.h"
      via: "CreateDefaultSubobject in constructor"
      pattern: "CreateDefaultSubobject.*InventoryComponent"
    - from: "SerenePlayerController.cpp"
      to: "SereneHUD.h"
      via: "HandleToggleInventory calls HUD->ShowInventory/HideInventory"
      pattern: "ShowInventory|HideInventory"
    - from: "SereneHUD.cpp"
      to: "InventoryComponent.h"
      via: "BindToCharacter subscribes to OnInventoryChanged"
      pattern: "OnInventoryChanged.*AddDynamic"
    - from: "SereneHUD.cpp"
      to: "InventoryWidget.h"
      via: "HandleInventoryChanged calls RefreshSlots on InventoryWidget"
      pattern: "RefreshSlots"
---

<objective>
Wire the inventory system into the existing player architecture: attach InventoryComponent to character, add inventory toggle to controller with input mode switching, integrate InventoryWidget into HUD hierarchy, and connect inventory delegates.

Purpose: This is the glue plan that connects the data layer (Plan 01) and UI layer (Plan 02) into the existing player systems. After this plan, the inventory opens/closes with a key press, the cursor appears for UI interaction, and the HUD auto-refreshes when inventory contents change.

Output: 7 modified files across character, controller, HUD, and HUD widget.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-inventory-system/02-CONTEXT.md
@.planning/phases/02-inventory-system/02-RESEARCH.md
@.planning/phases/02-inventory-system/02-01-SUMMARY.md
@.planning/phases/02-inventory-system/02-02-SUMMARY.md

@Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
@Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
@Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
@Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
@Source/ProjectWalkingSim/Public/Player/HUD/SereneHUD.h
@Source/ProjectWalkingSim/Private/Player/HUD/SereneHUD.cpp
@Source/ProjectWalkingSim/Public/Player/HUD/SereneHUDWidget.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Character + Controller inventory wiring</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/SereneCharacter.h
    Source/ProjectWalkingSim/Private/Player/SereneCharacter.cpp
    Source/ProjectWalkingSim/Public/Player/SerenePlayerController.h
    Source/ProjectWalkingSim/Private/Player/SerenePlayerController.cpp
  </files>
  <action>
    **SereneCharacter.h changes:**
    - Add forward declaration: `class UInventoryComponent;`
    - Add protected UPROPERTY under the Plan 04/05 Components section:
      ```cpp
      /** 8-slot inventory for items. Added in Phase 2. */
      UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components")
      TObjectPtr<UInventoryComponent> InventoryComponent;
      ```
    - Update class docstring to mention InventoryComponent (6th component)

    **SereneCharacter.cpp changes:**
    - Add include: `#include "Inventory/InventoryComponent.h"`
    - In constructor, after FootstepComponent creation, add:
      ```cpp
      // --- Phase 02 Components ---
      InventoryComponent = CreateDefaultSubobject<UInventoryComponent>(TEXT("InventoryComponent"));
      ```
    - In BeginPlay log, update component count check to include InventoryComponent:
      ```cpp
      UE_LOG(LogSerene, Log, TEXT("ASereneCharacter::BeginPlay - Components: Stamina=%s, HeadBob=%s, Lean=%s, Interaction=%s, Footstep=%s, Inventory=%s"),
          StaminaComponent ? TEXT("OK") : TEXT("MISSING"),
          HeadBobComponent ? TEXT("OK") : TEXT("MISSING"),
          LeanComponent ? TEXT("OK") : TEXT("MISSING"),
          InteractionComponent ? TEXT("OK") : TEXT("MISSING"),
          FootstepComponent ? TEXT("OK") : TEXT("MISSING"),
          InventoryComponent ? TEXT("OK") : TEXT("MISSING"));
      ```

    **SerenePlayerController.h changes:**
    - Add forward declaration: `class ASereneHUD;` (if not already present)
    - Add protected UPROPERTY for the new input action:
      ```cpp
      /** Bool: Tab (or assigned key) to toggle inventory. */
      UPROPERTY(EditDefaultsOnly, Category = "Input")
      TObjectPtr<UInputAction> ToggleInventoryAction;
      ```
    - Add private members:
      ```cpp
      /** Whether the inventory UI is currently open. */
      bool bIsInventoryOpen = false;

      void HandleToggleInventory(const FInputActionValue& Value);
      void OpenInventory();
      void CloseInventory();
      ```

    **SerenePlayerController.cpp changes:**
    - Add includes: `#include "Player/HUD/SereneHUD.h"`
    - In SetupInputComponent, after the LeanRight binding block, add:
      ```cpp
      // Inventory toggle
      if (ToggleInventoryAction)
      {
          EnhancedInput->BindAction(ToggleInventoryAction, ETriggerEvent::Started,
              this, &ASerenePlayerController::HandleToggleInventory);
      }
      ```
    - Implement HandleToggleInventory:
      ```cpp
      void ASerenePlayerController::HandleToggleInventory(const FInputActionValue& Value)
      {
          if (bIsInventoryOpen)
          {
              CloseInventory();
          }
          else
          {
              OpenInventory();
          }
      }
      ```
    - Implement OpenInventory:
      1. Set bIsInventoryOpen = true
      2. Switch to FInputModeGameAndUI:
         ```cpp
         FInputModeGameAndUI InputMode;
         InputMode.SetHideCursorDuringCapture(false);
         SetInputMode(InputMode);
         ```
      3. `SetShowMouseCursor(true)`
      4. `SetIgnoreLookInput(true)` -- prevents camera rotation from mouse while inventory is open
      5. Notify HUD:
         ```cpp
         if (ASereneHUD* HUD = Cast<ASereneHUD>(GetHUD()))
         {
             HUD->ShowInventory();
         }
         ```
      6. Log at Verbose level

    - Implement CloseInventory:
      1. Set bIsInventoryOpen = false
      2. Switch to FInputModeGameOnly:
         ```cpp
         FInputModeGameOnly InputMode;
         SetInputMode(InputMode);
         ```
      3. `SetShowMouseCursor(false)`
      4. `SetIgnoreLookInput(false)`
      5. Notify HUD:
         ```cpp
         if (ASereneHUD* HUD = Cast<ASereneHUD>(GetHUD()))
         {
             HUD->HideInventory();
         }
         ```
      6. Log at Verbose level

    Keep all existing input bindings and behavior unchanged. The new code is purely additive.
  </action>
  <verify>
    Run the UE build command:
    ```
    "C:\Program Files\Epic Games\UE_5.7\Engine\Binaries\DotNET\UnrealBuildTool\UnrealBuildTool.exe" ProjectWalkingSim Win64 Development -Project="C:\Unreal Projects\ProjectWalkingSim\ProjectWalkingSim.uproject" -WaitMutex -FromMsBuild
    ```
  </verify>
  <done>
    SereneCharacter creates InventoryComponent in constructor and logs it in BeginPlay. SerenePlayerController has ToggleInventoryAction binding, OpenInventory/CloseInventory with proper input mode switching (GameAndUI + cursor + ignore look), and routes show/hide to HUD. Compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: HUD + HUDWidget inventory integration</name>
  <files>
    Source/ProjectWalkingSim/Public/Player/HUD/SereneHUD.h
    Source/ProjectWalkingSim/Private/Player/HUD/SereneHUD.cpp
    Source/ProjectWalkingSim/Public/Player/HUD/SereneHUDWidget.h
  </files>
  <action>
    **SereneHUDWidget.h changes:**
    - Add forward declaration: `class UInventoryWidget;`
    - Add BindWidget property:
      ```cpp
      /** Inventory container widget. Name must match in UMG Blueprint. */
      UPROPERTY(meta = (BindWidget))
      TObjectPtr<UInventoryWidget> InventoryWidget;
      ```
    - Add accessor:
      ```cpp
      UInventoryWidget* GetInventoryWidget() const { return InventoryWidget; }
      ```

    **SereneHUD.h changes:**
    - Add forward declaration: `class UInventoryComponent;`
    - Add public methods:
      ```cpp
      /** Show the inventory UI. Called by PlayerController. */
      void ShowInventory();

      /** Hide the inventory UI. Called by PlayerController. */
      void HideInventory();
      ```
    - Add private delegate handlers:
      ```cpp
      /** Forwards inventory changes to the InventoryWidget for refresh. */
      UFUNCTION()
      void HandleInventoryChanged();

      /** Handles tooltip Use action from InventoryWidget. */
      UFUNCTION()
      void HandleUseRequested(int32 SlotIndex);

      /** Handles tooltip Discard action from InventoryWidget. */
      UFUNCTION()
      void HandleDiscardRequested(int32 SlotIndex);
      ```
    - Add private cached pointer:
      ```cpp
      /** Cached pointer to the character's inventory component. Set in BindToCharacter. */
      UPROPERTY()
      TObjectPtr<UInventoryComponent> CachedInventoryComp;
      ```

    **SereneHUD.cpp changes:**
    - Add includes: `#include "Inventory/InventoryComponent.h"`, `#include "Player/HUD/InventoryWidget.h"`

    - In BindToCharacter (add after existing InteractionComponent binding):
      ```cpp
      if (UInventoryComponent* Inventory = Character->FindComponentByClass<UInventoryComponent>())
      {
          CachedInventoryComp = Inventory;
          Inventory->OnInventoryChanged.AddDynamic(this, &ASereneHUD::HandleInventoryChanged);
          UE_LOG(LogSerene, Log, TEXT("ASereneHUD::BindToCharacter - Bound to InventoryComponent::OnInventoryChanged."));
      }
      ```

    - In BeginPlay (after widget creation and AddToViewport), bind InventoryWidget action delegates:
      ```cpp
      if (HUDWidgetInstance && HUDWidgetInstance->GetInventoryWidget())
      {
          UInventoryWidget* InvWidget = HUDWidgetInstance->GetInventoryWidget();
          InvWidget->OnUseRequested.AddDynamic(this, &ASereneHUD::HandleUseRequested);
          InvWidget->OnDiscardRequested.AddDynamic(this, &ASereneHUD::HandleDiscardRequested);
      }
      ```

    - HandleInventoryChanged:
      ```cpp
      if (HUDWidgetInstance && HUDWidgetInstance->GetInventoryWidget() && CachedInventoryComp)
      {
          HUDWidgetInstance->GetInventoryWidget()->RefreshSlots(
              CachedInventoryComp->GetSlots(), CachedInventoryComp);
      }
      ```

    - ShowInventory:
      ```cpp
      if (HUDWidgetInstance && HUDWidgetInstance->GetInventoryWidget())
      {
          HUDWidgetInstance->GetInventoryWidget()->ShowInventory();
          // Do an immediate refresh so slots are current when inventory opens
          HandleInventoryChanged();
      }
      ```

    - HideInventory:
      ```cpp
      if (HUDWidgetInstance && HUDWidgetInstance->GetInventoryWidget())
      {
          HUDWidgetInstance->GetInventoryWidget()->HideInventory();
      }
      ```

    - HandleUseRequested:
      ```cpp
      if (!CachedInventoryComp) return;
      const TArray<FInventorySlot>& Slots = CachedInventoryComp->GetSlots();
      if (!Slots.IsValidIndex(SlotIndex) || Slots[SlotIndex].IsEmpty()) return;

      const UItemDataAsset* ItemData = CachedInventoryComp->GetItemData(Slots[SlotIndex].ItemId);
      if (!ItemData) return;

      // For now, "Use" is a placeholder. Key items don't have a direct "use" action
      // outside of door interaction. Log and potentially expand in future phases.
      UE_LOG(LogSerene, Log, TEXT("ASereneHUD::HandleUseRequested - Use requested for slot %d: %s"),
          SlotIndex, *Slots[SlotIndex].ItemId.ToString());
      ```

    - HandleDiscardRequested:
      ```cpp
      if (!CachedInventoryComp) return;
      const TArray<FInventorySlot>& Slots = CachedInventoryComp->GetSlots();
      if (!Slots.IsValidIndex(SlotIndex) || Slots[SlotIndex].IsEmpty()) return;

      const UItemDataAsset* ItemData = CachedInventoryComp->GetItemData(Slots[SlotIndex].ItemId);

      // Key item warning: log warning but still allow discard (per CONTEXT: "CAN be discarded with strong warning")
      if (ItemData && ItemData->bIsKeyItem)
      {
          UE_LOG(LogSerene, Warning, TEXT("ASereneHUD::HandleDiscardRequested - Discarding KEY ITEM at slot %d: %s"),
              SlotIndex, *Slots[SlotIndex].ItemId.ToString());
          // TODO: Show confirmation dialog in future iteration
      }

      CachedInventoryComp->DiscardItem(SlotIndex);
      ```

    All existing HUD behavior (stamina, interaction prompt) remains unchanged. The new code is purely additive.
  </action>
  <verify>
    Run the UE build command:
    ```
    "C:\Program Files\Epic Games\UE_5.7\Engine\Binaries\DotNET\UnrealBuildTool\UnrealBuildTool.exe" ProjectWalkingSim Win64 Development -Project="C:\Unreal Projects\ProjectWalkingSim\ProjectWalkingSim.uproject" -WaitMutex -FromMsBuild
    ```
  </verify>
  <done>
    SereneHUDWidget has InventoryWidget BindWidget with accessor. SereneHUD binds to OnInventoryChanged in BindToCharacter, implements HandleInventoryChanged that calls RefreshSlots, ShowInventory/HideInventory that toggle the InventoryWidget, and HandleUseRequested/HandleDiscardRequested that route actions to InventoryComponent. Compiles cleanly.
  </done>
</task>

</tasks>

<verification>
- SereneCharacter has InventoryComponent created in constructor
- SerenePlayerController has ToggleInventoryAction, OpenInventory, CloseInventory with proper input mode switching
- SereneHUD binds to OnInventoryChanged and routes to InventoryWidget::RefreshSlots
- SereneHUD has ShowInventory/HideInventory called by controller
- SereneHUDWidget has InventoryWidget BindWidget
- HUD routes tooltip Use/Discard actions to InventoryComponent
- All existing Phase 1 behavior preserved (stamina, interaction prompt, movement)
- Full UE build succeeds
</verification>

<success_criteria>
The complete data flow is wired: Controller toggle -> HUD show/hide -> InventoryWidget display. InventoryComponent changes -> OnInventoryChanged delegate -> HUD handler -> InventoryWidget::RefreshSlots. Tooltip actions -> HUD handlers -> InventoryComponent methods. Input mode switches correctly between game-only and game+UI.
</success_criteria>

<output>
After completion, create `.planning/phases/02-inventory-system/02-04-SUMMARY.md`
</output>
